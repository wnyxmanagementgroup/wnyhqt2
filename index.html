<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.15s ease-in-out; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .form-label { font-weight: bold; color: #374151; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        fieldset { border-color: #e5e7eb; }
        legend { background-color: #f3f4f6; padding: 0.25rem 1rem; border-radius: 9999px; font-weight: 700; color: #4f46e5; font-size: 1.125rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; padding: 0.6rem 1.25rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 0.75rem; }
        .nav-button.active { background-color: #e0e7ff; border: 2px solid #4f46e5; }
        .stat-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; }
        .stat-card h3 { font-size: 1.25rem; font-weight: 700; color: #111827; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.2s; }
        .stat-item:hover { background-color: #eff6ff; }
        .stat-item:last-child { border-bottom: none; }
        .tab-button { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .tab-button:not(.active) { background-color: #e0e7ff; color: #4f46e5; }
        .alert-error { background-color: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 1rem; border-radius: 0.5rem; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        
        /* ✅ เพิ่ม CSS สำหรับสถานะต่างๆ */
        .empty-state { text-align: center; padding: 2rem; color: #6b7280; }
        .loading-state { display: flex; justify-content: center; align-items: center; padding: 2rem; }
        .error-state { text-align: center; padding: 2rem; color: #dc2626; background-color: #fef2f2; border-radius: 0.5rem; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <div id="login-screen" class="max-w-md mx-auto mt-10 p-8 rounded-2xl shadow-2xl main-container">
            <div class="text-center mb-8">
                <img src="https://www.wny.ac.th/wny/storage/2025/03/Branner-WNY-Thai.png" alt="Logo" class="mx-auto h-28 mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WNY App ไปราชการ</h1>
                <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="form-label">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">รหัสผ่าน (Password)</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-full text-lg">
                    <div id="login-loader" class="loader hidden"></div>
                    <span id="login-button-text">เข้าสู่ระบบ</span>
                </button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
             <p class="text-center mt-4 text-sm text-gray-600">
                ยังไม่มีบัญชี? <button type="button" id="show-register-modal-button" class="font-semibold text-indigo-600 hover:text-indigo-500">สมัครใช้งานที่นี่</button>
            </p>
        </div>

        <div id="main-app" class="hidden">
            <header class="p-4 bg-white rounded-xl shadow-lg mb-6 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">ยินดีต้อนรับ, <span id="user-fullname"></span></h2>
                    <p class="text-sm text-gray-500">ตำแหน่ง: <span id="user-position"></span></p>
                </div>
                <button id="logout-button" class="btn btn-danger">ออกจากระบบ</button>
            </header>

            <div id="navigation" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-6">
                <button data-target="dashboard-page" id="user-nav-dashboard" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition active">
                    <h3 class="font-bold text-indigo-700">แดชบอร์ด</h3>
                    <p class="text-xs text-gray-500">ภาพรวมของคุณ</p>
                </button>
                <button data-target="form-page" id="user-nav-form" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ร่างคำขอไปราชการ</h3>
                    <p class="text-xs text-gray-500">สร้างบันทึกข้อความ</p>
                </button>
                 <button data-target="command-generation-page" id="admin-nav-command" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-purple-700">จัดการบันทึกและคำสั่ง</h3>
                    <p class="text-xs text-gray-500">สำหรับผู้ดูแลระบบ</p>
                </button>
                 <button data-target="stats-page" id="nav-stats" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-green-700">สถิติข้อมูล</h3>
                    <p class="text-xs text-gray-500">สรุปภาพรวม</p>
                </button>
                <button data-target="profile-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ข้อมูลส่วนตัว</h3>
                    <p class="text-xs text-gray-500">จัดการข้อมูลของคุณ</p>
                </button>
                <button id="admin-nav-users" data-target="admin-users-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการผู้ใช้</h3>
                    <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
                </button>
            </div>

            <main id="page-content" class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg">
                <div id="dashboard-page" class="page-view">
                    <h2 class="text-2xl font-bold mb-4">รายการคำขอไปราชการของฉัน</h2>
                    <input type="text" id="search-requests" class="form-input mb-4" placeholder="ค้นหาตามวัตถุประสงค์, สถานที่, เลขอ้างอิง...">
                    <div id="requests-container">
                        <div id="requests-loader" class="text-center p-8">
                            <div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                        </div>
                        <div id="requests-list" class="hidden"></div>
                        <p id="no-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบรายการคำขอของคุณ</p>
                    </div>
                </div>

                <div id="form-page" class="page-view hidden">
                     <form id="request-form">
                          <input type="hidden" id="form-request-id">
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ข้อมูลทั่วไป</legend>
                                <div><label for="form-doc-date" class="form-label">วันที่</label><input type="date" id="form-doc-date" class="form-input" required></div>
                          </fieldset>
                         <fieldset class="border p-4 rounded-lg mb-6"><legend>1. รายละเอียดการไปราชการ</legend>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                   <div><label for="form-requester-name" class="form-label">ชื่อ-นามสกุลผู้ขอ</label><input type="text" id="form-requester-name" class="form-input" required></div>
                                   <div><label for="form-requester-position" class="form-label">ตำแหน่ง</label><input type="text" id="form-requester-position" class="form-input" required></div>
                              </div>
                             <div class="mt-4"><label for="form-location" class="form-label">ขออนุญาตไปราชการ ณ สถานที่</label><input type="text" id="form-location" class="form-input" required></div>
                             <div class="mt-4"><label for="form-purpose" class="form-label">เพื่อ</label><textarea id="form-purpose" rows="2" class="form-input" required></textarea></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                   <div><label for="form-start-date" class="form-label">ตั้งแต่วันที่</label><input type="date" id="form-start-date" class="form-input" required></div>
                                   <div><label for="form-end-date" class="form-label">ถึงวันที่</label><input type="date" id="form-end-date" class="form-input" required></div>
                              </div>
                         </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ผู้ร่วมเดินทาง (ถ้ามี)</legend>
                                <div id="form-attendees-list"></div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button type="button" id="form-add-attendee" class="btn btn-success w-full sm:w-auto"><span>+ เพิ่มผู้ร่วมเดินทาง</span></button>
                                    <button type="button" id="form-import-excel" class="btn btn-primary w-full sm:w-auto">
                                        <div id="import-excel-loader" class="loader hidden"></div>
                                        <span>นำเข้าจาก Excel</span>
                                    </button>
                                    <button type="button" id="form-download-template" class="btn bg-gray-500 text-white hover:bg-gray-600 w-full sm:w-auto"><span>ดาวน์โหลดแม่แบบ</span></button>
                                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                                </div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>2. การเบิกค่าใช้จ่าย</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="expense_no" name="expense_option" value="no" checked class="h-4 w-4"><label for="expense_no" class="ml-2">ไม่ขอเบิกค่าใช้จ่าย</label></div>
                                    <div><input type="radio" id="expense_partial" name="expense_option" value="partial" class="h-4 w-4"><label for="expense_partial" class="ml-2">ขอเบิกเฉพาะค่าใช้จ่าย</label></div>
                              </div>
                             <div id="partial-expense-options" class="pl-6 mt-3 hidden space-y-2">
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าเบี้ยเลี้ยง" data-item-name="ค่าเบี้ยเลี้ยง" class="rounded"> ค่าเบี้ยเลี้ยง</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าอาหาร" data-item-name="ค่าอาหาร" class="rounded"> ค่าอาหาร</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าที่พัก" data-item-name="ค่าที่พัก" class="rounded"> ค่าที่พัก</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าพาหนะ" data-item-name="ค่าพาหนะ" class="rounded"> ค่าพาหนะ</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าน้ำมัน" data-item-name="ค่าน้ำมัน" class="rounded"> ค่าน้ำมัน</label>
                                  <div class="flex items-center gap-2"><label><input type="checkbox" name="expense_item" id="expense_other_check" data-item-name="ค่าใช้จ่ายอื่นๆ" class="rounded"> ค่าใช้จ่ายอื่นๆ</label><input type="text" id="expense_other_text" class="form-input text-sm p-1 flex-grow" placeholder="ระบุ"></div>
                             </div>
                             <div id="total-expense-container" class="mt-4 hidden"><label for="form-total-expense" class="form-label">รวมเป็นจำนวนเงิน (บาท)</label><input type="number" id="form-total-expense" class="form-input w-full md:w-1/2" placeholder="0.00" step="0.01"></div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>3. การเดินทาง</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="vehicle_gov" name="vehicle_option" value="gov" checked class="h-4 w-4"><label for="vehicle_gov" class="ml-2">รถยนต์ราชการ (รถโรงเรียน)</label></div>
                                    <div><input type="radio" id="vehicle_private" name="vehicle_option" value="private" class="h-4 w-4"><label for="vehicle_private" class="ml-2">รถยนต์ส่วนตัว</label></div>
                                    <div id="private-vehicle-details" class="pl-8 mt-2 hidden"><label for="form-license-plate" class="form-label">หมายเลขทะเบียน</label><input type="text" id="form-license-plate" class="form-input w-full md:w-1/2"></div>
                                    <div><input type="radio" id="vehicle_public" name="vehicle_option" value="public" class="h-4 w-4"><label for="vehicle_public" class="ml-2">พาหนะอื่นๆ</label></div>
                              </div>
                         </fieldset>
                          <fieldset id="signer-fieldset" class="border p-4 rounded-lg mb-6"><legend>5. ข้อมูลผู้ลงนาม</legend>
                                <div class="mb-4">
                                    <label for="form-department" class="form-label">กลุ่มสาระฯ / งาน</label>
                                    <select id="form-department" class="form-input" required></select>
                                </div>
                                <div><label for="form-head-name" class="form-label">ชื่อหัวหน้ากลุ่มสาระ / หัวหน้างาน</label><input type="text" id="form-head-name" class="form-input bg-gray-200" readonly></div>
                         </fieldset>
                         <div class="text-center mt-10 border-t pt-6 border-gray-200">
                              <button type="submit" id="submit-request-button" class="btn btn-primary w-full sm:w-auto text-lg">
                                <div id="submit-loader" class="loader hidden"></div>
                                <span id="submit-button-text">บันทึกและสร้างเอกสาร</span>
                             </button>
                         </div>
                    </form>
                      <div id="form-result" class="hidden mt-6 p-6 text-center">
                          <h3 id="form-result-title" class="font-bold text-lg"></h3>
                          <p id="form-result-message" class="mt-2 text-gray-700"></p>
                            <div class="flex justify-center flex-wrap gap-4 mt-4">
                                <a id="form-result-link" href="#" target="_blank" class="btn btn-success">เปิดไฟล์ PDF</a>
                             </div>
                      </div>
                </div>

                <div id="profile-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">ข้อมูลส่วนตัว</h2>
                      <form id="profile-form">
                         <div class="mb-4"><label for="profile-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="profile-username" class="form-input bg-gray-200" readonly></div>
                          <div class="mb-4"><label for="profile-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="profile-fullname" class="form-input" required></div>
                          <div class="mb-4"><label for="profile-position" class="form-label">ตำแหน่ง</label><input type="text" id="profile-position" class="form-input" required></div>
                        <div class="mb-6"><label for="profile-department" class="form-label">กลุ่มสาระการเรียนรู้/กลุ่มงาน</label><input type="text" id="profile-department" class="form-input" required></div>
                        <button type="submit" id="save-profile-button" class="btn btn-primary"><div id="profile-loader" class="loader hidden"></div><span id="profile-button-text">บันทึกข้อมูล</span></button>
                          <p id="profile-message" class="text-green-600 mt-4 hidden"></p>
                    </form>
                    
                    <h2 class="text-2xl font-bold mb-4 mt-10 border-t pt-6">เปลี่ยนรหัสผ่าน</h2>
                    <form id="password-form">
                        <div class="mb-4 relative">
                            <label for="profile-current-password" class="form-label">รหัสผ่านปัจจุบัน</label>
                            <input type="password" id="profile-current-password" class="form-input" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="profile-new-password" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" id="profile-new-password" class="form-input" required>
                        </div>
                        <div class="mb-6 relative">
                            <label for="profile-confirm-password" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                            <input type="password" id="profile-confirm-password" class="form-input" required>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-password-toggle" class="form-checkbox h-5 w-5 text-indigo-600">
                                <span class="ml-2 text-gray-700">แสดงรหัสผ่าน</span>
                            </label>
                        </div>
                        <button type="submit" id="save-password-button" class="btn btn-primary">
                            <div id="password-loader" class="loader hidden"></div>
                            <span id="password-button-text">เปลี่ยนรหัสผ่าน</span>
                        </button>
                        <p id="password-message" class="text-green-600 mt-4 hidden"></p>
                        <p id="password-error" class="text-red-500 mt-4 hidden"></p>
                    </form>
                </div>
                
                <div id="admin-users-page" class="page-view hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-2xl font-bold">จัดการผู้ใช้งาน</h2>
                        <div class="flex gap-2">
                             <button id="import-users-button" class="btn btn-primary">
                                <div id="import-users-loader" class="loader hidden"></div>
                                <span>นำเข้าจาก Excel</span>
                             </button>
                             <button id="download-user-template-button" class="btn bg-gray-500 text-white hover:bg-gray-600">ดาวน์โหลดแม่แบบ</button>
                             <button id="add-user-button" class="btn btn-success">เพิ่มผู้ใช้ใหม่</button>
                             <input type="file" id="user-excel-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <div id="admin-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลผู้ใช้...</p></div>
                    <div id="admin-users-list" class="hidden overflow-x-auto"></div>
                </div>

                <div id="command-generation-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการบันทึกข้อความและคำสั่งไปราชการ</h2>
                    
                    <div class="flex space-x-2 border-b-2 border-gray-200 mb-4">
                        <button id="admin-view-requests-tab" class="tab-button active">คำขอทั้งหมด</button>
                        <button id="admin-view-memos-tab" class="tab-button">บันทึกที่ส่งแล้ว</button>
                    </div>

                    <div id="admin-requests-view">
                        <div id="command-requests-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดคำขอทั้งหมด...</p></div>
                        <div id="command-requests-list" class="hidden overflow-x-auto"></div>
                        <p id="no-command-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบคำขอที่ต้องดำเนินการ</p>
                    </div>
                    
                    <div id="admin-memos-view" class="hidden">
                         <div id="admin-memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                        <div id="admin-memos-list" class="hidden overflow-x-auto"></div>
                        <p id="no-admin-memos-message" class="text-center text-gray-500 p-8 hidden">ไม่พบบันทึกข้อความ</p>
                    </div>
                </div>
                
                <div id="stats-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">สรุปสถิติข้อมูลทั้งหมด</h2>
                    <div id="stats-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังประมวลผลข้อมูลสถิติ...</p>
                    </div>
                    <div id="stats-content" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                        <div id="stats-by-user" class="stat-card"></div>
                        <div id="stats-by-department" class="stat-card"></div>
                        <div id="stats-by-year" class="stat-card"></div>
                        <div id="stats-by-expense" class="stat-card"></div>
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            <p>จัดทำโดยกลุ่มบริหารงานบุคคล โรงเรียนวังน้ำเย็นวิทยาคม </p>
            <p>พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี </p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">สมัครใช้งานใหม่</h3>
            <form id="register-form">
                <div class="mb-4"><label for="register-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="register-username" class="form-input" required></div>
                 <div class="mb-4"><label for="register-password" class="form-label">รหัสผ่าน (Password)</label><input type="password" id="register-password" class="form-input" required></div>
                 <div class="mb-4"><label for="register-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="register-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="register-position" class="form-label">ตำแหน่ง</label><input type="text" id="register-position" class="form-input" required></div>
                 <div class="mb-4"><label for="register-department" class="form-label">กลุ่มสาระการเรียนรู้</label><input type="text" id="register-department" class="form-input" required></div>
                <p id="register-error" class="text-red-500 mb-4 hidden"></p>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="register-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="register-save-button" class="btn btn-primary"><div id="register-loader" class="loader hidden"></div><span id="register-button-text">สมัครใช้งาน</span></button></div>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 id="admin-modal-title" class="text-xl font-bold mb-4">เพิ่มผู้ใช้ใหม่</h3>
            <form id="admin-modal-form">
                <input type="hidden" id="modal-original-username">
                <div class="mb-4"><label for="modal-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="modal-username" class="form-input" required></div>
                <div class="mb-4"><label for="modal-password" class="form-label">รหัสผ่าน (เว้นว่างไว้หากไม่ต้องการเปลี่ยน)</label><input type="password" id="modal-password" class="form-input" placeholder="รหัสผ่านใหม่"></div>
                 <div class="mb-4"><label for="modal-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="modal-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-position" class="form-label">ตำแหน่ง</label><input type="text" id="modal-position" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-department" class="form-label">กลุ่มสาระฯ/งาน</label><input type="text" id="modal-department" class="form-input" required></div>
                 <div class="mb-4">
                    <label for="modal-role" class="form-label">สิทธิ์</label>
                    <select id="modal-role" class="form-input"><option value="user">User</option><option value="admin">Admin</option></select>
                </div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="admin-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="admin-modal-save-button" class="btn btn-primary"><div id="admin-modal-loader" class="loader hidden"></div><span id="admin-modal-button-text">บันทึก</span></button></div>
            </form>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content text-center">
            <h3 id="alert-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="alert-modal-message" class="mb-6"></p>
            <button id="alert-modal-close-button" class="btn btn-primary">ตกลง</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="confirm-modal-message" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-no-button" class="btn bg-gray-300">ยกเลิก</button>
                <button id="confirm-modal-yes-button" class="btn btn-danger">ยืนยัน</button>
            </div>
        </div>
    </div>
    
    <div id="command-approval-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">เลือกรูปแบบคำสั่งเพื่ออนุมัติ</h3>
            <form id="command-approval-form">
                <input type="hidden" id="approval-request-id">
                <p class="mb-4">กรุณาเลือกรูปแบบคำสั่งที่ถูกต้องตามจำนวนผู้เดินทาง</p>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-100">
                        <label for="template-solo" class="flex items-center cursor-pointer flex-grow">
                            <input type="radio" id="template-solo" name="templateType" value="solo" required class="mr-3 h-4 w-4">
                            เดินทาง 1 คน
                        </label>
                        <button type="button" id="preview-solo" class="text-sm text-indigo-600 hover:underline font-semibold">ดูตัวอย่าง</button>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-100">
                        <label for="template-small" class="flex items-center cursor-pointer flex-grow">
                            <input type="radio" id="template-small" name="templateType" value="groupSmall" class="mr-3 h-4 w-4">
                            เดินทาง 2-5 คน
                        </label>
                        <button type="button" id="preview-small" class="text-sm text-indigo-600 hover:underline font-semibold">ดูตัวอย่าง</button>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-100">
                        <label for="template-large" class="flex items-center cursor-pointer flex-grow">
                            <input type="radio" id="template-large" name="templateType" value="groupLarge" class="mr-3 h-4 w-4">
                            เดินทาง 6 คนขึ้นไป
                        </label>
                        <button type="button" id="preview-large" class="text-sm text-indigo-600 hover:underline font-semibold">ดูตัวอย่าง</button>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="command-approval-modal-close-button">ยกเลิก</button>
                    <button type="submit" id="command-approval-submit-button" class="btn btn-primary">
                        <div id="command-approval-loader" class="loader hidden"></div>
                        <span>ยืนยันและออกคำสั่ง</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="admin-memo-action-modal" class="modal">
        <div class="modal-content">
             <h3 class="text-xl font-bold mb-4">จัดการไฟล์ที่เสร็จสมบูรณ์</h3>
             <form id="admin-memo-action-form">
                <input type="hidden" id="action-memo-id">
                <p class="mb-4">อัปโหลดไฟล์ที่ผ่านการอนุมัติและลงนามเรียบร้อยแล้ว</p>
                <div class="mb-3">
                    <label for="completed-memo-file" class="form-label">ไฟล์บันทึกข้อความ (ฉบับสมบูรณ์)</label>
                    <input type="file" id="completed-memo-file" class="form-input" accept="application/pdf">
                </div>
                 <div class="mb-3">
                    <label for="completed-command-file" class="form-label">ไฟล์คำสั่ง (ฉบับสมบูรณ์)</label>
                    <input type="file" id="completed-command-file" class="form-input" accept="application/pdf">
                </div>
                <div class="mb-6">
                    <label for="dispatch-book-file" class="form-label">หนังสือส่ง (ถ้ามี)</label>
                    <input type="file" id="dispatch-book-file" class="form-input" accept="application/pdf">
                </div>
                 <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="admin-memo-action-modal-close-button">ยกเลิก</button>
                    <button type="submit" id="admin-memo-action-submit-button" class="btn btn-success">
                        <div id="admin-memo-action-loader" class="loader hidden"></div>
                        <span>เสร็จสิ้นและส่งไฟล์</span>
                    </button>
                </div>
             </form>
        </div>
    </div>
    
    <div id="stats-detail-modal" class="modal">
        <div class="modal-content">
            <h3 id="stats-detail-title" class="text-xl font-bold mb-4"></h3>
            <div id="stats-detail-content" class="max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="btn bg-gray-300" id="stats-detail-modal-close-button">ปิด</button>
            </div>
        </div>
    </div>

    <div id="dispatch-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">สร้างหนังสือส่ง</h3>
            <form id="dispatch-form">
                <input type="hidden" id="dispatch-request-id">
                <div class="mb-4">
                    <label for="dispatch-month" class="form-label">เดือน</label>
                    <select id="dispatch-month" class="form-input" required>
                        <option value="มกราคม">มกราคม</option>
                        <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                        <option value="มีนาคม">มีนาคม</option>
                        <option value="เมษายน">เมษายน</option>
                        <option value="พฤษภาคม">พฤษภาคม</option>
                        <option value="มิถุนายน">มิถุนายน</option>
                        <option value="กรกฎาคม">กรกฎาคม</option>
                        <option value="สิงหาคม">สิงหาคม</option>
                        <option value="กันยายน">กันยายน</option>
                        <option value="ตุลาคม">ตุลาคม</option>
                        <option value="พฤศจิกายน">พฤศจิกายน</option>
                        <option value="ธันวาคม">ธันวาคม</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="dispatch-year" class="form-label">ปี พ.ศ.</label>
                    <input type="number" id="dispatch-year" class="form-input" placeholder="เช่น 2567" required>
                </div>
                <div class="mb-4">
                    <label for="dispatch-memo-count" class="form-label">จำนวนบันทึกข้อความ</label>
                    <input type="number" id="dispatch-memo-count" class="form-input" placeholder="กรอกเป็นตัวเลข" required>
                </div>
                <div class="mb-4">
                    <label for="dispatch-command-count" class="form-label">จำนวนคำสั่ง</label>
                    <input type="number" id="dispatch-command-count" class="form-input" placeholder="กรอกเป็นตัวเลข" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="dispatch-modal-close-button">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">สร้างหนังสือ</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="send-memo-modal" class="modal">
         <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">ส่งบันทึกข้อความ</h3>
            <form id="send-memo-form">
                 <input type="hidden" id="memo-modal-request-id">
                 <div class="mb-4">
                    <label class="form-label">ประเภทการส่ง</label>
                    <div class="flex gap-4 mt-2">
                        <div><input type="radio" id="modal-memo-type-no-reimburse" name="modal_memo_type" value="no_reimburse" checked><label for="modal-memo-type-no-reimburse" class="ml-2">ไม่เบิก (แนบไฟล์)</label></div>
                        <div><input type="radio" id="modal-memo-type-reimburse" name="modal_memo_type" value="reimburse"><label for="modal-memo-type-reimburse" class="ml-2">เบิก (ไม่ต้องแนบไฟล์)</label></div>
                    </div>
                </div>
                 <div id="modal-memo-file-container" class="mb-6">
                    <label for="modal-memo-file" class="form-label">ไฟล์บันทึกข้อความ (PDF เท่านั้น)</label>
                    <input type="file" id="modal-memo-file" class="form-input" accept="application/pdf" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="send-memo-modal-close-button">ยกเลิก</button>
                    <button type="submit" id="send-memo-submit-button" class="btn btn-primary">
                        <div id="send-memo-loader" class="loader hidden"></div>
                        <span>ส่งบันทึก</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
     // ใช้ URL ของ Google Apps Script ที่คุณให้มา
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBlEmcMGrCrxRul_Maz9pqMFiWxvNXo5htmJ-jUpN0h7HVQ7lpo6-D61dY_7mFbkci/exec";

// ✅ กำหนดค่า Template IDs สำหรับปุ่ม Preview
const COMMAND_TEMPLATE_SOLO_ID = '1tanbQgNp8NYCjUCDig0qvzpzZ4tFsT1Z_ru6qGn5O4g';
const COMMAND_TEMPLATE_GROUP_SMALL_ID = '1jzJg_qwRYNa8wjb32PVgnVmrzkO0bNVNcOECb2a6u6Y';
const COMMAND_TEMPLATE_GROUP_LARGE_ID = '10M8eolqah-8WXxHQ_q43NXiCOv0CkbnBxqq6AgfxtB0';

// Global State
let allRequestsCache = [];
let allMemosCache = [];
let userMemosCache = [];
let allUsersCache = [];
let specialPositionMap = {};

const statusTranslations = {
    'Pending': 'กำลังดำเนินการ',
    'Submitted': 'กำลังดำเนินการ',
    'Approved': 'เสร็จสิ้นรอออกคำสั่งไปราชการ',
    'Pending Approval': 'กำลังดำเนินการ',
    'เสร็จสิ้น/รับไฟล์ไปใช้งาน': 'เสร็จสิ้น',
    'รอเอกสาร (เบิก)': 'รอตรวจสอบและออกคำสั่ง',
    'นำกลับไปแก้ไข': 'นำกลับไปแก้ไข'
};

function translateStatus(status) {
    return statusTranslations[status] || status;
}

// --- Cache Management ---
const cacheManager = {
    requests: {
        data: [],
        timestamp: null,
        ttl: 5 * 60 * 1000 // 5 minutes
    },
    users: {
        data: [],
        timestamp: null,
        ttl: 10 * 60 * 1000 // 10 minutes
    },
    memos: {
        data: [],
        timestamp: null,
        ttl: 5 * 60 * 1000 // 5 minutes
    },
    
    isValid(cacheType) {
        return this[cacheType].timestamp && 
               (Date.now() - this[cacheType].timestamp) < this[cacheType].ttl;
    },
    
    set(cacheType, data) {
        this[cacheType].data = data;
        this[cacheType].timestamp = Date.now();
    },
    
    clear(cacheType = null) {
        if (cacheType) {
            this[cacheType].data = [];
            this[cacheType].timestamp = null;
        } else {
            Object.keys(this).forEach(key => {
                this[key].data = [];
                this[key].timestamp = null;
            });
        }
    }
};

// ✅ เพิ่ม Security Functions
function sanitizeHTML(str) {
    if (typeof str !== 'string') return str;
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function validateInput(input, type = 'text') {
    if (typeof input !== 'string') return false;
    
    const trimmed = input.trim();
    
    switch (type) {
        case 'email':
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(trimmed);
        case 'number':
            return !isNaN(trimmed) && isFinite(trimmed) && trimmed !== '';
        case 'date':
            return !isNaN(new Date(trimmed).getTime());
        case 'username':
            return /^[a-zA-Z0-9_]+$/.test(trimmed) && trimmed.length >= 3;
        default:
            return trimmed.length > 0;
    }
}

// ✅ เพิ่ม Global Error Handlers
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    showAlert("System Error", "An unexpected error occurred. Please refresh the page.");
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    showAlert("System Error", "An unexpected error occurred. Please refresh the page.");
});

// --- API HELPER FUNCTIONS ---

async function apiCall(method, action, payload = {}) {
    let url = SCRIPT_URL;
    const options = {
        method: method,
        redirect: 'follow',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    };

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.log('Request timeout after 60 seconds');
        }, 60000);
        options.signal = controller.signal;

        if (method === 'GET') {
            const params = new URLSearchParams({ 
                action, 
                ...payload, 
                cacheBust: new Date().getTime() 
            });
            url += `?${params}`;
        } else {
            options.body = JSON.stringify({ action, payload });
        }

        const response = await fetch(url, options);
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        
        return result;
    } catch (error) {
        console.error('API Call Error:', error);
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            showAlert('Timeout', 'การเชื่อมต่อใช้เวลานานเกินไป กรุณาลองใหม่');
        } else if (error.message.includes('Failed to fetch')) {
            showAlert('การเชื่อมต่อล้มเหลว', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
        } else {
            showAlert('เกิดข้อผิดพลาด', `Server error: ${error.message}`);
        }
        throw error;
    }
}

// ✅ เพิ่ม API Call with Retry
async function apiCallWithRetry(method, action, payload = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            return await apiCall(method, action, payload);
        } catch (error) {
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
}

// --- UTILITY FUNCTIONS ---

function showAlert(title, message) {
    document.getElementById('alert-modal-title').textContent = title;
    document.getElementById('alert-modal-message').textContent = message;
    document.getElementById('alert-modal').style.display = 'flex';
}

function showConfirm(title, message) {
    document.getElementById('confirm-modal-title').textContent = title;
    document.getElementById('confirm-modal-message').textContent = message;
    document.getElementById('confirm-modal').style.display = 'flex';

    return new Promise((resolve) => {
        const yesButton = document.getElementById('confirm-modal-yes-button');
        const noButton = document.getElementById('confirm-modal-no-button');
        const onYes = () => { cleanup(); resolve(true); };
        const onNo = () => { cleanup(); resolve(false); };
        
        const cleanup = () => {
            document.getElementById('confirm-modal').style.display = 'none';
            yesButton.removeEventListener('click', onYes);
            noButton.removeEventListener('click', onNo);
        };

        yesButton.addEventListener('click', onYes, { once: true });
        noButton.addEventListener('click', onNo, { once: true });
    });
}

function toggleLoader(buttonId, show) {
    const button = document.getElementById(buttonId);
    if (!button) {
        console.error(`Button with id '${buttonId}' not found`);
        return;
    }
    
    const loader = button.querySelector('.loader');
    const text = button.querySelector('span');
    
    if (show) {
        if (loader) loader.classList.remove('hidden');
        if (text) text.classList.add('hidden');
        button.disabled = true;
    } else {
        if (loader) loader.classList.add('hidden');
        if (text) text.classList.remove('hidden');
        button.disabled = false;
    }
}

function getCurrentUser() {
    const userJson = sessionStorage.getItem('currentUser');
    return userJson ? JSON.parse(userJson) : null;
}

function fileToObject(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const data = reader.result.toString().split(',')[1];
            resolve({ filename: file.name, mimeType: file.type, data: data });
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

// ✅ เพิ่มฟังก์ชันจัดการสถานะ UI
function showLoadingState(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="loading-state">
            <div class="loader"></div>
            <span class="ml-2">กำลังโหลด...</span>
        </div>
    `;
}

function showEmptyState(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="empty-state">
            <p>${sanitizeHTML(message)}</p>
        </div>
    `;
}

function showErrorState(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="error-state">
            <p>${sanitizeHTML(message)}</p>
        </div>
    `;
}

// ✅ เพิ่มฟังก์ชัน validation วันที่
function validateDates(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (start < today) {
        return 'วันที่เริ่มต้นต้องไม่เป็นวันในอดีต';
    }
    
    if (end < start) {
        return 'วันที่สิ้นสุดต้องไม่มาก่อนวันที่เริ่มต้น';
    }
    
    if ((end - start) / (1000 * 60 * 60 * 24) > 30) {
        return 'ระยะเวลาในการไปราชการต้องไม่เกิน 30 วัน';
    }
    
    return null;
}

// Debounce สำหรับ search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// --- PAGE NAVIGATION ---

async function switchPage(targetPageId) {
    document.querySelectorAll('.page-view').forEach(page => page.classList.add('hidden'));
    const targetPage = document.getElementById(targetPageId);
    if (targetPage) {
         targetPage.classList.remove('hidden');
    }

    document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
        if(btn.dataset.target === targetPageId) {
            btn.classList.add('active');
        }
    });

    if (targetPageId === 'form-page') await resetRequestForm();
    if (targetPageId === 'dashboard-page') await fetchUserRequests();
    if (targetPageId === 'profile-page') loadProfileData();
    if (targetPageId === 'stats-page') await loadStatsData();
    if (targetPageId === 'admin-users-page') await fetchAllUsers();
    if (targetPageId === 'command-generation-page') {
        document.getElementById('admin-view-requests-tab').click();
    }
}

// --- MAIN APP LOGIC ---

document.addEventListener('DOMContentLoaded', () => {
    console.log('App Initializing with Google Sheets Backend...');
    setupEventListeners();
    const user = getCurrentUser();
    if (user) {
        initializeUserSession(user);
    } else {
        showLoginScreen();
    }
});

// --- INITIALIZATION ---

function initializeUserSession(user) {
    updateUIForUser(user);
    showMainApp();
    switchPage('dashboard-page');
}

function updateUIForUser(user) {
    document.getElementById('user-fullname').textContent = user.fullName || 'N/A';
    document.getElementById('user-position').textContent = user.position || 'N/A';

    const isAdmin = user.role === 'admin';
    document.getElementById('admin-nav-command').classList.toggle('hidden', !isAdmin);
    document.getElementById('admin-nav-users').classList.toggle('hidden', !isAdmin);
}

function showMainApp() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
}

function showLoginScreen() {
    sessionStorage.removeItem('currentUser');
    cacheManager.clear();
    document.getElementById('main-app').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
}

// --- EVENT LISTENER SETUP ---

function setupEventListeners() {
    // Auth
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('logout-button').addEventListener('click', showLoginScreen);
    document.getElementById('show-register-modal-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'flex');
    document.getElementById('register-form').addEventListener('submit', handleRegister);

    // Navigation
    document.getElementById('navigation').addEventListener('click', (e) => {
        const navButton = e.target.closest('.nav-button');
        if (navButton && navButton.dataset.target) {
            switchPage(navButton.dataset.target);
        }
    });

    // Modals
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });
    });
    document.getElementById('register-modal-close-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'none');
    document.getElementById('admin-modal-close-button').addEventListener('click', () => document.getElementById('admin-modal').style.display = 'none');
    document.getElementById('alert-modal-close-button').addEventListener('click', () => document.getElementById('alert-modal').style.display = 'none');
    document.getElementById('command-approval-modal-close-button').addEventListener('click', () => document.getElementById('command-approval-modal').style.display = 'none');
    document.getElementById('admin-memo-action-modal-close-button').addEventListener('click', () => document.getElementById('admin-memo-action-modal').style.display = 'none');
    document.getElementById('stats-detail-modal-close-button').addEventListener('click', () => document.getElementById('stats-detail-modal').style.display = 'none');
    document.getElementById('dispatch-modal-close-button').addEventListener('click', () => document.getElementById('dispatch-modal').style.display = 'none');
    document.getElementById('send-memo-modal-close-button').addEventListener('click', () => document.getElementById('send-memo-modal').style.display = 'none');

    // ✅ แก้ไข: เพิ่ม Event Listeners สำหรับปุ่ม Preview
    document.getElementById('preview-solo').addEventListener('click', () => {
        window.open(`https://drive.google.com/file/d/${COMMAND_TEMPLATE_SOLO_ID}/view`, '_blank');
    });
    document.getElementById('preview-small').addEventListener('click', () => {
        window.open(`https://drive.google.com/file/d/${COMMAND_TEMPLATE_GROUP_SMALL_ID}/view`, '_blank');
    });
    document.getElementById('preview-large').addEventListener('click', () => {
        window.open(`https://drive.google.com/file/d/${COMMAND_TEMPLATE_GROUP_LARGE_ID}/view`, '_blank');
    });

    // Forms
    document.getElementById('request-form').addEventListener('submit', handleRequestFormSubmit);
    document.getElementById('form-add-attendee').addEventListener('click', () => addAttendeeField());
    document.getElementById('form-import-excel').addEventListener('click', () => document.getElementById('excel-file-input').click());
    document.getElementById('excel-file-input').addEventListener('change', handleExcelImport);
    document.getElementById('form-download-template').addEventListener('click', downloadAttendeeTemplate);
    document.querySelectorAll('input[name="expense_option"]').forEach(radio => radio.addEventListener('change', toggleExpenseOptions));
    document.querySelectorAll('input[name="vehicle_option"]').forEach(radio => radio.addEventListener('change', toggleVehicleOptions));
    
    document.getElementById('send-memo-form').addEventListener('submit', handleMemoSubmitFromModal);
    document.querySelectorAll('input[name="modal_memo_type"]').forEach(radio => radio.addEventListener('change', (e) => {
        const fileContainer = document.getElementById('modal-memo-file-container');
        const fileInput = document.getElementById('modal-memo-file');
        const isReimburse = e.target.value === 'reimburse';
        fileContainer.classList.toggle('hidden', isReimburse);
        fileInput.required = !isReimburse;
    }));

    document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
    document.getElementById('password-form').addEventListener('submit', handlePasswordUpdate);
    document.getElementById('show-password-toggle').addEventListener('change', togglePasswordVisibility);
    document.getElementById('command-approval-form').addEventListener('submit', handleCommandApproval);
    document.getElementById('admin-memo-action-form').addEventListener('submit', handleAdminMemoActionSubmit);
    document.getElementById('dispatch-form').addEventListener('submit', handleDispatchFormSubmit);
    
    document.getElementById('form-department').addEventListener('change', (e) => {
        const selectedPosition = e.target.value;
        const headNameInput = document.getElementById('form-head-name');
        headNameInput.value = specialPositionMap[selectedPosition] || '';
    });
    
    // Search
    document.getElementById('search-requests').addEventListener(
        'input', 
        debounce((e) => {
            renderRequestsList(allRequestsCache, userMemosCache, e.target.value);
        }, 300)
    );

    // Admin
    document.getElementById('add-user-button').addEventListener('click', openAddUserModal);
    document.getElementById('admin-modal-form').addEventListener('submit', handleAdminUserSave);
    document.getElementById('download-user-template-button').addEventListener('click', downloadUserTemplate);
    document.getElementById('import-users-button').addEventListener('click', () => document.getElementById('user-excel-input').click());
    document.getElementById('user-excel-input').addEventListener('change', handleUserImport);
    
    // Admin Page Tabs
    document.getElementById('admin-view-requests-tab').addEventListener('click', (e) => {
        document.getElementById('admin-view-memos-tab').classList.remove('active');
        e.target.classList.add('active');
        document.getElementById('admin-requests-view').classList.remove('hidden');
        document.getElementById('admin-memos-view').classList.add('hidden');
        fetchAllRequestsForCommand();
    });
    document.getElementById('admin-view-memos-tab').addEventListener('click', (e) => {
        document.getElementById('admin-view-requests-tab').classList.remove('active');
        e.target.classList.add('active');
        document.getElementById('admin-memos-view').classList.remove('hidden');
        document.getElementById('admin-requests-view').classList.add('hidden');
        fetchAllMemos();
    });
}

// --- AUTHENTICATION HANDLERS ---

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const errorP = document.getElementById('login-error');
    errorP.classList.add('hidden');
    toggleLoader('login-button', true);

    if (!validateInput(username, 'username')) {
        errorP.textContent = 'ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร และประกอบด้วยตัวอักษรภาษาอังกฤษและตัวเลขเท่านั้น';
        errorP.classList.remove('hidden');
        toggleLoader('login-button', false);
        return;
    }

    try {
        const result = await apiCallWithRetry('POST', 'verifyCredentials', { username, password });
        sessionStorage.setItem('currentUser', JSON.stringify(result.user));
        initializeUserSession(result.user);
    } catch (error) {
        errorP.textContent = error.message;
        errorP.classList.remove('hidden');
    } finally {
        toggleLoader('login-button', false);
    }
}

async function handleRegister(e) {
    e.preventDefault();
    const payload = {
        username: document.getElementById('register-username').value.trim(),
        password: document.getElementById('register-password').value,
        fullName: document.getElementById('register-fullname').value.trim(),
        position: document.getElementById('register-position').value.trim(),
        department: document.getElementById('register-department').value.trim(),
        role: 'user'
    };
    const errorP = document.getElementById('register-error');
    errorP.classList.add('hidden');
    
    if (!validateInput(payload.username, 'username')) {
        errorP.textContent = "ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร และประกอบด้วยตัวอักษรภาษาอังกฤษและตัวเลขเท่านั้น";
        errorP.classList.remove('hidden');
        return;
    }
    
    if (payload.password.length < 6) {
        errorP.textContent = "รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร";
        errorP.classList.remove('hidden');
        return;
    }

    if (!validateInput(payload.fullName) || !validateInput(payload.position) || !validateInput(payload.department)) {
        errorP.textContent = "กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง";
        errorP.classList.remove('hidden');
        return;
    }

    toggleLoader('register-save-button', true);
    
    try {
        const result = await apiCallWithRetry('POST', 'registerUser', payload);
        document.getElementById('register-modal').style.display = 'none';
        e.target.reset();
        showAlert("สมัครสำเร็จ", result.message);
    } catch (error) {
        errorP.textContent = error.message;
        errorP.classList.remove('hidden');
    } finally {
        toggleLoader('register-save-button', false);
    }
}

// --- DATA FETCHING & RENDERING (USER) ---

async function fetchUserRequests() {
    const user = getCurrentUser();
    if (!user) return;
    
    showLoadingState('requests-container');
    document.getElementById('no-requests-message').classList.add('hidden');

    try {
        if (cacheManager.isValid('requests')) {
            allRequestsCache = cacheManager.requests.data;
            userMemosCache = cacheManager.memos.data;
        } else {
            const [requestsResult, memosResult] = await Promise.all([
                apiCallWithRetry('GET', 'getUserRequests', { username: user.username }),
                apiCallWithRetry('GET', 'getSentMemos', { username: user.username })
            ]);
            allRequestsCache = requestsResult.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) || [];
            userMemosCache = memosResult.data || [];
            
            cacheManager.set('requests', allRequestsCache);
            cacheManager.set('memos', userMemosCache);
        }
        
        if (allRequestsCache.length === 0) {
            showEmptyState('requests-container', 'ไม่พบรายการคำขอของคุณ');
        } else {
            renderRequestsList(allRequestsCache, userMemosCache);
        }
    } catch (error) {
        console.error("Error fetching user requests:", error);
        showErrorState('requests-container', 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
    }
}

function renderRequestsList(requests, memos = [], searchTerm = '') {
    const listContainer = document.getElementById('requests-list');
    const noDataMsg = document.getElementById('no-requests-message');
    listContainer.innerHTML = '';

    let filteredRequests = requests;
    if (searchTerm) {
        const lowerCaseSearch = searchTerm.toLowerCase();
        filteredRequests = requests.filter(req => 
            req.purpose?.toLowerCase().includes(lowerCaseSearch) ||
            req.location?.toLowerCase().includes(lowerCaseSearch) ||
            req.id?.toLowerCase().includes(lowerCaseSearch)
        );
    }
    
    if (filteredRequests.length === 0) {
        noDataMsg.classList.remove('hidden');
        listContainer.classList.add('hidden');
    } else {
        noDataMsg.classList.add('hidden');
        const list = document.createElement('div');
        list.className = 'space-y-4';

        const memoMap = new Map(memos.map(memo => [memo.refNumber, memo]));

        filteredRequests.forEach(req => {
            const memo = memoMap.get(req.id);
            let completedFilesHTML = '';
            
            // ✅ ตรวจสอบสถานะที่ไม่อนุญาตให้แก้ไข
            const isCompleted = memo && (
                memo.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน' || 
                memo.status === 'Approved' ||
                memo.status === 'เสร็จสิ้นรอออกคำสั่งไปราชการ'
            );
            
            if (memo) {
                if (memo.completedMemoUrl) {
                    completedFilesHTML += `<a href="${memo.completedMemoUrl}" target="_blank" class="text-green-600 hover:text-green-900 text-sm font-semibold">ไฟล์บันทึก</a>`;
                }
                if (memo.completedCommandUrl) {
                    completedFilesHTML += `<a href="${memo.completedCommandUrl}" target="_blank" class="text-blue-600 hover:text-blue-900 text-sm font-semibold ml-4">ไฟล์คำสั่ง</a>`;
                }
                if (memo.dispatchBookUrl) {
                    completedFilesHTML += `<a href="${memo.dispatchBookUrl}" target="_blank" class="text-purple-600 hover:text-purple-900 text-sm font-semibold ml-4">หนังสือส่ง</a>`;
                }
            }

            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg shadow-sm hover:shadow-md transition bg-white';
            
            // ✅ แสดงปุ่มตามสถานะ
            let actionButtons = '';
            if (isCompleted) {
                actionButtons = `
                    <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 justify-end">
                        ${req.pdfUrl ? `<a href="${req.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูร่างบันทึก</a>` : ''}
                        <button class="btn text-sm bg-gray-400 text-white cursor-not-allowed" disabled>ส่งบันทึก</button>
                        <button class="btn text-sm bg-gray-400 text-white cursor-not-allowed" disabled>แก้ไข</button>
                        <button class="btn text-sm bg-gray-400 text-white cursor-not-allowed" disabled>ลบ</button>
                        <span class="text-xs text-red-500 font-semibold self-center">(ไม่สามารถแก้ไขได้ เนื่องจากสถานะเสร็จสิ้น)</span>
                    </div>
                `;
            } else {
                actionButtons = `
                    <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 justify-end">
                        ${req.pdfUrl ? `<a href="${req.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูร่างบันทึก</a>` : ''}
                        <button class="btn text-sm bg-blue-500 text-white" data-id="${req.id}" data-action="send-memo">ส่งบันทึก</button>
                        <button class="btn text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900" data-id="${req.id}" data-action="edit">แก้ไข</button>
                        <button class="btn text-sm btn-danger" data-id="${req.id}" data-action="delete">ลบ</button>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="flex flex-wrap justify-between items-start gap-2">
                    <div>
                        <h4 class="font-bold text-lg text-indigo-700">${sanitizeHTML(req.purpose)}</h4>
                        <p class="text-sm text-gray-600"><strong>สถานที่:</strong> ${sanitizeHTML(req.location)}</p>
                        <p class="text-xs text-gray-400 mt-1"><strong>ID:</strong> ${sanitizeHTML(req.id)}</p>
                    </div>
                    <div class="text-right text-xs space-y-1">
                        <p>สถานะ: <span class="font-bold px-2 py-1 rounded-full ${
                            isCompleted ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                        }">${memo ? translateStatus(memo.status) : 'ยังไม่ส่ง'}</span></p>
                        ${isCompleted ? '<p class="text-red-500 text-xs font-semibold">⚠️ สถานะเสร็จสิ้น</p>' : ''}
                    </div>
                </div>

                ${completedFilesHTML ? `
                <div class="border-t mt-3 pt-3">
                    <h5 class="text-sm font-bold text-gray-700 mb-2">ไฟล์ฉบับสมบูรณ์:</h5>
                    <div class="flex flex-wrap gap-4">
                        ${completedFilesHTML}
                    </div>
                </div>
                ` : ''}

                ${actionButtons}
            `;
            list.appendChild(card);
        });
        listContainer.innerHTML = '';
        listContainer.appendChild(list);
        listContainer.addEventListener('click', handleRequestAction);
        listContainer.classList.remove('hidden');
    }
}

// ✅ แก้ไขฟังก์ชัน handleCommandApproval
async function handleCommandApproval(e) {
    e.preventDefault();
    const requestId = document.getElementById('approval-request-id').value;
    const templateType = document.querySelector('input[name="templateType"]:checked')?.value;
    
    if (!templateType) {
        showAlert('ข้อมูลไม่ครบ', 'กรุณาเลือกรูปแบบคำสั่ง');
        return;
    }

    toggleLoader('command-approval-submit-button', true);

    try {
        const result = await apiCallWithRetry('POST', 'approveCommand', {
            requestId: requestId,
            templateType: templateType
        });

        if (result.status === 'success') {
            document.getElementById('command-approval-modal').style.display = 'none';
            showAlert('สำเร็จ', result.message);
            // ✅ แก้ไข: ล้าง cache และโหลดข้อมูลใหม่
            cacheManager.clear('requests');
            await fetchAllRequestsForCommand();
        } else {
            showAlert('เกิดข้อผิดพลาด', result.message);
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('command-approval-submit-button', false);
    }
}

// ✅ เพิ่มฟังก์ชัน fetchAllRequestsForCommand
async function fetchAllRequestsForCommand() {
    showLoadingState('command-requests-list');
    
    try {
        if (cacheManager.isValid('requests')) {
            allRequestsCache = cacheManager.requests.data;
        } else {
            const result = await apiCallWithRetry('GET', 'getAllRequests');
            allRequestsCache = result.data || [];
            cacheManager.set('requests', allRequestsCache);
        }
        
        renderAdminRequestsList(allRequestsCache);
    } catch (error) {
        console.error("Error fetching all requests:", error);
        showErrorState('command-requests-list', 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
    }
}

// ✅ แก้ไขฟังก์ชัน renderAdminRequestsList
function renderAdminRequestsList(requests) {
    const listContainer = document.getElementById('command-requests-list');
    const noDataMsg = document.getElementById('no-command-requests-message');
    const loader = document.getElementById('command-requests-loader');
    
    if (loader) loader.classList.add('hidden');
    
    if (requests.length === 0) {
        listContainer.classList.add('hidden');
        noDataMsg.classList.remove('hidden');
        return;
    }

    listContainer.classList.remove('hidden');
    noDataMsg.classList.add('hidden');

    const sortedRequests = requests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    let html = `
        <table class="min-w-full bg-white">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-4 border text-left">ID</th>
                    <th class="py-2 px-4 border text-left">ผู้ขอ</th>
                    <th class="py-2 px-4 border text-left">วัตถุประสงค์</th>
                    <th class="py-2 px-4 border text-left">สถานะคำสั่ง</th>
                    <th class="py-2 px-4 border text-left">การดำเนินการ</th>
                </tr>
            </thead>
            <tbody>
    `;

    sortedRequests.forEach(request => {
        const hasCommand = request.commandPdfUrl && request.commandPdfUrl !== '';
        const isPending = !hasCommand && request.commandStatus === 'กำลังดำเนินการ';
        
        html += `
            <tr class="hover:bg-gray-50">
                <td class="py-2 px-4 border">${sanitizeHTML(request.id)}</td>
                <td class="py-2 px-4 border">${sanitizeHTML(request.requesterName)}</td>
                <td class="py-2 px-4 border">${sanitizeHTML(request.purpose)}</td>
                <td class="py-2 px-4 border">
                    <span class="px-2 py-1 rounded-full text-xs ${
                        hasCommand ? 'bg-green-100 text-green-800' : 
                        isPending ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'
                    }">
                        ${hasCommand ? 'ออกคำสั่งแล้ว' : 
                          isPending ? 'รอออกคำสั่ง' : 'กำลังดำเนินการ'}
                    </span>
                </td>
                <td class="py-2 px-4 border">
                    <div class="flex flex-wrap gap-2">
                        ${request.pdfUrl ? 
                            `<a href="${request.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูบันทึก</a>` : 
                            '<span class="text-gray-400 text-sm">ไม่มีไฟล์</span>'
                        }
                        ${!hasCommand && isPending ? 
                            `<button class="btn btn-sm btn-primary approve-command" data-id="${request.id}">ออกคำสั่ง</button>` : 
                            hasCommand ? 
                            `<a href="${request.commandPdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูคำสั่ง</a>` :
                            '<span class="text-gray-400 text-sm">รอดำเนินการ</span>'
                        }
                    </div>
                </td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    listContainer.innerHTML = html;

    // Add event listeners for approve buttons
    document.querySelectorAll('.approve-command').forEach(button => {
        button.addEventListener('click', (e) => {
            const requestId = e.target.dataset.id;
            document.getElementById('approval-request-id').value = requestId;
            document.getElementById('command-approval-modal').style.display = 'flex';
        });
    });
}

// ✅ เพิ่มฟังก์ชัน validateRequestForm
function validateRequestForm(payload) {
    const errors = [];
    
    // ✅ เพิ่ม validation วันที่
    const dateError = validateDates(payload.startDate, payload.endDate);
    if (dateError) errors.push(dateError);
    
    // Validation เดิม
    const startDate = new Date(payload.startDate);
    const endDate = new Date(payload.endDate);
    if (startDate > endDate) {
        errors.push('วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด');
    }
    
    if (payload.attendees && payload.attendees.length > 0) {
        payload.attendees.forEach((attendee, index) => {
            if (!attendee.name || !attendee.position) {
                errors.push(`ผู้ร่วมเดินทางลำดับที่ ${index + 1} กรุณากรอกข้อมูลให้ครบ`);
            }
        });
    }
    
    if (payload.expenseOption === 'partial' && payload.expenseItems.length === 0) {
        errors.push('กรุณาเลือกรายการค่าใช้จ่ายที่ต้องการเบิก');
    }
    
    return errors;
}

// ✅ แก้ไขฟังก์ชัน handleRequestFormSubmit
async function handleRequestFormSubmit(e) {
    e.preventDefault();
    toggleLoader('submit-request-button', true);

    try {
        const user = getCurrentUser();
        if (!user || !user.username || user.username.trim() === '') {
            showAlert("ข้อมูลไม่ครบ", "ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่");
            toggleLoader('submit-request-button', false);
            return;
        }

        // Collect form data
        const payload = {
            username: user.username,
            id: document.getElementById('form-request-id').value || '',
            docDate: document.getElementById('form-doc-date').value,
            requesterName: document.getElementById('form-requester-name').value,
            requesterPosition: document.getElementById('form-requester-position').value,
            location: document.getElementById('form-location').value,
            purpose: document.getElementById('form-purpose').value,
            startDate: document.getElementById('form-start-date').value,
            endDate: document.getElementById('form-end-date').value,
            attendees: getAttendeesFromForm(),
            expenseOption: document.querySelector('input[name="expense_option"]:checked').value,
            expenseItems: getExpenseItemsFromForm(),
            totalExpense: document.getElementById('form-total-expense').value || 0,
            vehicleOption: document.querySelector('input[name="vehicle_option"]:checked').value,
            licensePlate: document.getElementById('form-license-plate').value || '',
            department: document.getElementById('form-department').value,
            headName: document.getElementById('form-head-name').value
        };

        // Validate form
        const errors = validateRequestForm(payload);
        if (errors.length > 0) {
            showAlert('ข้อมูลไม่ครบถ้วน', errors.join('\n'));
            toggleLoader('submit-request-button', false);
            return;
        }

        // Submit request
        const result = await apiCallWithRetry('POST', 'createRequest', payload);
        
        if (result.status === 'success') {
            document.getElementById('form-result-title').textContent = 'บันทึกข้อมูลสำเร็จ';
            document.getElementById('form-result-message').textContent = `คำขอของคุณถูกบันทึกเรียบร้อยแล้ว (ID: ${result.data.id})`;
            document.getElementById('form-result-link').href = result.data.pdfUrl;
            document.getElementById('form-result').classList.remove('hidden');
            
            // Clear cache and refresh requests list
            cacheManager.clear('requests');
            await fetchUserRequests();
            
            // Reset form
            await resetRequestForm();
        } else {
            showAlert('เกิดข้อผิดพลาด', result.message);
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message);
    } finally {
        toggleLoader('submit-request-button', false);
    }
}

// --- ฟังก์ชันเสริมที่จำเป็น ---

function getAttendeesFromForm() {
    const attendees = [];
    document.querySelectorAll('#form-attendees-list .attendee-row').forEach(row => {
        const name = row.querySelector('.attendee-name').value;
        const position = row.querySelector('.attendee-position').value;
        if (name && position) {
            attendees.push({ name, position });
        }
    });
    return attendees;
}

function getExpenseItemsFromForm() {
    const items = [];
    document.querySelectorAll('input[name="expense_item"]:checked').forEach(checkbox => {
        const itemName = checkbox.dataset.itemName;
        if (itemName === 'ค่าใช้จ่ายอื่นๆ') {
            const otherText = document.getElementById('expense_other_text').value;
            items.push({ name: itemName, detail: otherText });
        } else {
            items.push({ name: itemName });
        }
    });
    return items;
}

function toggleExpenseOptions() {
    const isPartial = document.getElementById('expense_partial').checked;
    document.getElementById('partial-expense-options').classList.toggle('hidden', !isPartial);
    document.getElementById('total-expense-container').classList.toggle('hidden', !isPartial);
}

function toggleVehicleOptions() {
    const isPrivate = document.getElementById('vehicle_private').checked;
    document.getElementById('private-vehicle-details').classList.toggle('hidden', !isPrivate);
}

function addAttendeeField(name = '', position = '') {
    const container = document.getElementById('form-attendees-list');
    const index = container.children.length;
    const row = document.createElement('div');
    row.className = 'attendee-row grid grid-cols-1 md:grid-cols-2 gap-4 mb-2';
    row.innerHTML = `
        <div>
            <input type="text" class="attendee-name form-input" placeholder="ชื่อ-นามสกุล" value="${name}">
        </div>
        <div class="flex gap-2">
            <input type="text" class="attendee-position form-input" placeholder="ตำแหน่ง" value="${position}">
            <button type="button" class="btn btn-danger remove-attendee">ลบ</button>
        </div>
    `;
    container.appendChild(row);
    
    // Add event listener for remove button
    row.querySelector('.remove-attendee').addEventListener('click', () => {
        row.remove();
    });
}

async function resetRequestForm() {
    document.getElementById('request-form').reset();
    document.getElementById('form-request-id').value = '';
    document.getElementById('form-result').classList.add('hidden');
    document.getElementById('form-attendees-list').innerHTML = '';
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('form-doc-date').value = today;
    
    // Reset expense options
    document.getElementById('expense_no').checked = true;
    toggleExpenseOptions();
    
    // Reset vehicle options
    document.getElementById('vehicle_gov').checked = true;
    toggleVehicleOptions();
    
    // Load departments
    await loadDepartments();
}

async function loadDepartments() {
    try {
        const result = await apiCallWithRetry('GET', 'getAllUsers');
        const departments = [...new Set(result.data.map(user => user.department).filter(Boolean))];
        const select = document.getElementById('form-department');
        select.innerHTML = '<option value="">เลือกกลุ่มสาระฯ/งาน</option>';
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading departments:', error);
    }
}

function handleRequestAction(e) {
    const button = e.target.closest('button');
    if (!button) return;
    
    const requestId = button.dataset.id;
    const action = button.dataset.action;
    
    switch (action) {
        case 'send-memo':
            document.getElementById('memo-modal-request-id').value = requestId;
            document.getElementById('send-memo-modal').style.display = 'flex';
            break;
        case 'edit':
            editRequest(requestId);
            break;
        case 'delete':
            deleteRequest(requestId);
            break;
    }
}

async function editRequest(requestId) {
    try {
        const result = await apiCallWithRetry('GET', 'getAttendeesForRequest', { requestId });
        const request = allRequestsCache.find(req => req.id === requestId);
        
        if (request) {
            // Populate form with request data
            document.getElementById('form-request-id').value = request.id;
            document.getElementById('form-doc-date').value = new Date(request.docDate).toISOString().split('T')[0];
            document.getElementById('form-requester-name').value = request.requesterName;
            document.getElementById('form-requester-position').value = request.requesterPosition;
            document.getElementById('form-location').value = request.location;
            document.getElementById('form-purpose').value = request.purpose;
            document.getElementById('form-start-date').value = new Date(request.startDate).toISOString().split('T')[0];
            document.getElementById('form-end-date').value = new Date(request.endDate).toISOString().split('T')[0];
            
            // Populate attendees
            document.getElementById('form-attendees-list').innerHTML = '';
            result.data.forEach(attendee => {
                addAttendeeField(attendee.name, attendee.position);
            });
            
            // Switch to form page
            switchPage('form-page');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลสำหรับแก้ไข: ' + error.message);
    }
}

async function deleteRequest(requestId) {
    const confirmed = await showConfirm('ยืนยันการลบ', 'คุณแน่ใจว่าต้องการลบคำขอนี้ใช่หรือไม่?');
    if (confirmed) {
        try {
            const result = await apiCallWithRetry('POST', 'deleteRequest', { id: requestId });
            showAlert('สำเร็จ', result.message);
            cacheManager.clear('requests');
            await fetchUserRequests();
        } catch (error) {
            showAlert('เกิดข้อผิดพลาด', error.message);
        }
    }
}

// --- ฟังก์ชันพื้นฐานอื่นๆ ---

async function fetchAllUsers() {
    showLoadingState('admin-users-list');
    try {
        const result = await apiCallWithRetry('GET', 'getAllUsers');
        allUsersCache = result.data || [];
        renderUsersList(allUsersCache);
    } catch (error) {
        showErrorState('admin-users-list', 'เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้');
    }
}

function renderUsersList(users) {
    const container = document.getElementById('admin-users-list');
    container.innerHTML = `
        <table class="min-w-full bg-white">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-4 border text-left">ชื่อผู้ใช้</th>
                    <th class="py-2 px-4 border text-left">ชื่อ-นามสกุล</th>
                    <th class="py-2 px-4 border text-left">ตำแหน่ง</th>
                    <th class="py-2 px-4 border text-left">กลุ่มสาระ</th>
                    <th class="py-2 px-4 border text-left">สิทธิ์</th>
                    <th class="py-2 px-4 border text-left">การดำเนินการ</th>
                </tr>
            </thead>
            <tbody>
                ${users.map(user => `
                    <tr>
                        <td class="py-2 px-4 border">${sanitizeHTML(user.username)}</td>
                        <td class="py-2 px-4 border">${sanitizeHTML(user.fullName)}</td>
                        <td class="py-2 px-4 border">${sanitizeHTML(user.position)}</td>
                        <td class="py-2 px-4 border">${sanitizeHTML(user.department)}</td>
                        <td class="py-2 px-4 border">${sanitizeHTML(user.role)}</td>
                        <td class="py-2 px-4 border">
                            <button class="btn btn-sm btn-primary edit-user" data-username="${user.username}">แก้ไข</button>
                            <button class="btn btn-sm btn-danger delete-user" data-username="${user.username}">ลบ</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    container.classList.remove('hidden');
}

async function loadProfileData() {
    const user = getCurrentUser();
    if (!user) return;
    
    document.getElementById('profile-username').value = user.username || '';
    document.getElementById('profile-fullname').value = user.fullName || '';
    document.getElementById('profile-position').value = user.position || '';
    document.getElementById('profile-department').value = user.department || '';
}

async function handleProfileUpdate(e) {
    e.preventDefault();
    toggleLoader('save-profile-button', true);
    
    const user = getCurrentUser();
    const payload = {
        username: user.username,
        fullName: document.getElementById('profile-fullname').value,
        position: document.getElementById('profile-position').value,
        department: document.getElementById('profile-department').value
    };
    
    try {
        const result = await apiCallWithRetry('POST', 'updateUserProfile', payload);
        showAlert('สำเร็จ', result.message);
        
        // Update session storage
        const updatedUser = { ...user, ...payload };
        sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
        updateUIForUser(updatedUser);
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('save-profile-button', false);
    }
}

// ฟังก์ชันพื้นฐานอื่นๆ ที่จำเป็น
function togglePasswordVisibility() {
    const showPassword = document.getElementById('show-password-toggle').checked;
    const currentPassword = document.getElementById('profile-current-password');
    const newPassword = document.getElementById('profile-new-password');
    const confirmPassword = document.getElementById('profile-confirm-password');
    
    currentPassword.type = showPassword ? 'text' : 'password';
    newPassword.type = showPassword ? 'text' : 'password';
    confirmPassword.type = showPassword ? 'text' : 'password';
}

async function handlePasswordUpdate(e) {
    e.preventDefault();
    toggleLoader('save-password-button', true);
    
    const user = getCurrentUser();
    const payload = {
        username: user.username,
        oldPassword: document.getElementById('profile-current-password').value,
        newPassword: document.getElementById('profile-new-password').value
    };
    
    const confirmPassword = document.getElementById('profile-confirm-password').value;
    
    if (payload.newPassword !== confirmPassword) {
        showAlert('ข้อผิดพลาด', 'รหัสผ่านใหม่และยืนยันรหัสผ่านไม่ตรงกัน');
        toggleLoader('save-password-button', false);
        return;
    }
    
    try {
        const result = await apiCallWithRetry('POST', 'updatePassword', payload);
        showAlert('สำเร็จ', result.message);
        document.getElementById('password-form').reset();
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('save-password-button', false);
    }
}

// ฟังก์ชัน placeholder สำหรับฟังก์ชันที่ยังไม่ได้ implement
async function fetchAllMemos() {
    // Implementation for fetching all memos
    console.log('Fetching all memos...');
}

async function loadStatsData() {
    // Implementation for loading stats data
    console.log('Loading stats data...');
}

function openAddUserModal() {
    // Implementation for opening add user modal
    console.log('Opening add user modal...');
}

function handleAdminUserSave(e) {
    // Implementation for admin user save
    e.preventDefault();
    console.log('Saving admin user...');
}

function downloadUserTemplate() {
    // Implementation for downloading user template
    console.log('Downloading user template...');
}

function handleUserImport(e) {
    // Implementation for user import
    console.log('Handling user import...');
}

function handleMemoSubmitFromModal(e) {
    // Implementation for memo submit from modal
    e.preventDefault();
    console.log('Submitting memo from modal...');
}

function handleAdminMemoActionSubmit(e) {
    // Implementation for admin memo action submit
    e.preventDefault();
    console.log('Submitting admin memo action...');
}

function handleDispatchFormSubmit(e) {
    // Implementation for dispatch form submit
    e.preventDefault();
    console.log('Submitting dispatch form...');
}

function downloadAttendeeTemplate() {
    // Implementation for downloading attendee template
    console.log('Downloading attendee template...');
}

function handleExcelImport(e) {
    // Implementation for Excel import
    console.log('Handling Excel import...');
}
    </script>
</body>
</html>
