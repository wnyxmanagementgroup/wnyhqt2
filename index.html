<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.15s ease-in-out; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .form-label { font-weight: bold; color: #374151; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        fieldset { border-color: #e5e7eb; }
        legend { background-color: #f3f4f6; padding: 0.25rem 1rem; border-radius: 9999px; font-weight: 700; color: #4f46e5; font-size: 1.125rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; padding: 0.6rem 1.25rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 0.75rem; }
        .nav-button.active { background-color: #e0e7ff; border: 2px solid #4f46e5; }
        .stat-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; }
        .stat-card h3 { font-size: 1.25rem; font-weight: 700; color: #111827; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.2s; }
        .stat-item:hover { background-color: #eff6ff; }
        .stat-item:last-child { border-bottom: none; }
        .tab-button { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .tab-button:not(.active) { background-color: #e0e7ff; color: #4f46e5; }
        .alert-error { background-color: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 1rem; border-radius: 0.5rem; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        
        /* ✅ เพิ่ม CSS สำหรับสถานะต่างๆ */
        .empty-state { text-align: center; padding: 2rem; color: #6b7280; }
        .loading-state { display: flex; justify-content: center; align-items: center; padding: 2rem; }
        .error-state { text-align: center; padding: 2rem; color: #dc2626; background-color: #fef2f2; border-radius: 0.5rem; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <div id="login-screen" class="max-w-md mx-auto mt-10 p-8 rounded-2xl shadow-2xl main-container">
            <div class="text-center mb-8">
                <img src="https://www.wny.ac.th/wny/storage/2025/03/Branner-WNY-Thai.png" alt="Logo" class="mx-auto h-28 mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WNY App ไปราชการ</h1>
                <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="form-label">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">รหัสผ่าน (Password)</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-full text-lg">
                    <div id="login-loader" class="loader hidden"></div>
                    <span id="login-button-text">เข้าสู่ระบบ</span>
                </button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
             <p class="text-center mt-4 text-sm text-gray-600">
                ยังไม่มีบัญชี? <button type="button" id="show-register-modal-button" class="font-semibold text-indigo-600 hover:text-indigo-500">สมัครใช้งานที่นี่</button>
            </p>
        </div>

        <div id="main-app" class="hidden">
            <header class="p-4 bg-white rounded-xl shadow-lg mb-6 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">ยินดีต้อนรับ, <span id="user-fullname"></span></h2>
                    <p class="text-sm text-gray-500">ตำแหน่ง: <span id="user-position"></span></p>
                </div>
                <button id="logout-button" class="btn btn-danger">ออกจากระบบ</button>
            </header>

            <div id="navigation" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-6">
                <button data-target="dashboard-page" id="user-nav-dashboard" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition active">
                    <h3 class="font-bold text-indigo-700">แดชบอร์ด</h3>
                    <p class="text-xs text-gray-500">ภาพรวมของคุณ</p>
                </button>
                <button data-target="form-page" id="user-nav-form" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ร่างคำขอไปราชการ</h3>
                    <p class="text-xs text-gray-500">สร้างบันทึกข้อความ</p>
                </button>
                 <button data-target="command-generation-page" id="admin-nav-command" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-purple-700">จัดการบันทึกและคำสั่ง</h3>
                    <p class="text-xs text-gray-500">สำหรับผู้ดูแลระบบ</p>
                </button>
                 <button data-target="stats-page" id="nav-stats" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-green-700">สถิติข้อมูล</h3>
                    <p class="text-xs text-gray-500">สรุปภาพรวม</p>
                </button>
                <button data-target="profile-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ข้อมูลส่วนตัว</h3>
                    <p class="text-xs text-gray-500">จัดการข้อมูลของคุณ</p>
                </button>
                <button id="admin-nav-users" data-target="admin-users-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการผู้ใช้</h3>
                    <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
                </button>
            </div>

            <main id="page-content" class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg">
                <div id="dashboard-page" class="page-view">
                    <h2 class="text-2xl font-bold mb-4">รายการคำขอไปราชการของฉัน</h2>
                    <input type="text" id="search-requests" class="form-input mb-4" placeholder="ค้นหาตามวัตถุประสงค์, สถานที่, เลขอ้างอิง...">
                    <div id="requests-container">
                        <div id="requests-loader" class="text-center p-8">
                            <div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                        </div>
                        <div id="requests-list" class="hidden"></div>
                        <p id="no-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบรายการคำขอของคุณ</p>
                    </div>
                </div>

                <div id="form-page" class="page-view hidden">
                     <form id="request-form">
                          <input type="hidden" id="form-request-id">
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ข้อมูลทั่วไป</legend>
                                <div><label for="form-doc-date" class="form-label">วันที่</label><input type="date" id="form-doc-date" class="form-input" required></div>
                          </fieldset>
                         <fieldset class="border p-4 rounded-lg mb-6"><legend>1. รายละเอียดการไปราชการ</legend>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                   <div><label for="form-requester-name" class="form-label">ชื่อ-นามสกุลผู้ขอ</label><input type="text" id="form-requester-name" class="form-input" required></div>
                                   <div><label for="form-requester-position" class="form-label">ตำแหน่ง</label><input type="text" id="form-requester-position" class="form-input" required></div>
                              </div>
                             <div class="mt-4"><label for="form-location" class="form-label">ขออนุญาตไปราชการ ณ สถานที่</label><input type="text" id="form-location" class="form-input" required></div>
                             <div class="mt-4"><label for="form-purpose" class="form-label">เพื่อ</label><textarea id="form-purpose" rows="2" class="form-input" required></textarea></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                   <div><label for="form-start-date" class="form-label">ตั้งแต่วันที่</label><input type="date" id="form-start-date" class="form-input" required></div>
                                   <div><label for="form-end-date" class="form-label">ถึงวันที่</label><input type="date" id="form-end-date" class="form-input" required></div>
                              </div>
                         </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ผู้ร่วมเดินทาง (ถ้ามี)</legend>
                                <div id="form-attendees-list"></div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button type="button" id="form-add-attendee" class="btn btn-success w-full sm:w-auto"><span>+ เพิ่มผู้ร่วมเดินทาง</span></button>
                                    <button type="button" id="form-import-excel" class="btn btn-primary w-full sm:w-auto">
                                        <div id="import-excel-loader" class="loader hidden"></div>
                                        <span>นำเข้าจาก Excel</span>
                                    </button>
                                    <button type="button" id="form-download-template" class="btn bg-gray-500 text-white hover:bg-gray-600 w-full sm:w-auto"><span>ดาวน์โหลดแม่แบบ</span></button>
                                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                                </div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>2. การเบิกค่าใช้จ่าย</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="expense_no" name="expense_option" value="no" checked class="h-4 w-4"><label for="expense_no" class="ml-2">ไม่ขอเบิกค่าใช้จ่าย</label></div>
                                    <div><input type="radio" id="expense_partial" name="expense_option" value="partial" class="h-4 w-4"><label for="expense_partial" class="ml-2">ขอเบิกเฉพาะค่าใช้จ่าย</label></div>
                              </div>
                             <div id="partial-expense-options" class="pl-6 mt-3 hidden space-y-2">
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าเบี้ยเลี้ยง" data-item-name="ค่าเบี้ยเลี้ยง" class="rounded"> ค่าเบี้ยเลี้ยง</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าอาหาร" data-item-name="ค่าอาหาร" class="rounded"> ค่าอาหาร</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าที่พัก" data-item-name="ค่าที่พัก" class="rounded"> ค่าที่พัก</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าพาหนะ" data-item-name="ค่าพาหนะ" class="rounded"> ค่าพาหนะ</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าน้ำมัน" data-item-name="ค่าน้ำมัน" class="rounded"> ค่าน้ำมัน</label>
                                  <div class="flex items-center gap-2"><label><input type="checkbox" name="expense_item" id="expense_other_check" data-item-name="ค่าใช้จ่ายอื่นๆ" class="rounded"> ค่าใช้จ่ายอื่นๆ</label><input type="text" id="expense_other_text" class="form-input text-sm p-1 flex-grow" placeholder="ระบุ"></div>
                             </div>
                             <div id="total-expense-container" class="mt-4 hidden"><label for="form-total-expense" class="form-label">รวมเป็นจำนวนเงิน (บาท)</label><input type="number" id="form-total-expense" class="form-input w-full md:w-1/2" placeholder="0.00" step="0.01"></div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>3. การเดินทาง</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="vehicle_gov" name="vehicle_option" value="gov" checked class="h-4 w-4"><label for="vehicle_gov" class="ml-2">รถยนต์ราชการ (รถโรงเรียน)</label></div>
                                    <div><input type="radio" id="vehicle_private" name="vehicle_option" value="private" class="h-4 w-4"><label for="vehicle_private" class="ml-2">รถยนต์ส่วนตัว</label></div>
                                    <div id="private-vehicle-details" class="pl-8 mt-2 hidden"><label for="form-license-plate" class="form-label">หมายเลขทะเบียน</label><input type="text" id="form-license-plate" class="form-input w-full md:w-1/2"></div>
                                    <div><input type="radio" id="vehicle_public" name="vehicle_option" value="public" class="h-4 w-4"><label for="vehicle_public" class="ml-2">พาหนะอื่นๆ</label></div>
                              </div>
                         </fieldset>
                          <fieldset id="signer-fieldset" class="border p-4 rounded-lg mb-6"><legend>5. ข้อมูลผู้ลงนาม</legend>
                                <div class="mb-4">
                                    <label for="form-department" class="form-label">กลุ่มสาระฯ / งาน</label>
                                    <select id="form-department" class="form-input" required></select>
                                </div>
                                <div><label for="form-head-name" class="form-label">ชื่อหัวหน้ากลุ่มสาระ / หัวหน้างาน</label><input type="text" id="form-head-name" class="form-input bg-gray-200" readonly></div>
                         </fieldset>
                         <div class="text-center mt-10 border-t pt-6 border-gray-200">
                              <button type="submit" id="submit-request-button" class="btn btn-primary w-full sm:w-auto text-lg">
                                <div id="submit-loader" class="loader hidden"></div>
                                <span id="submit-button-text">บันทึกและสร้างเอกสาร</span>
                             </button>
                         </div>
                    </form>
                      <div id="form-result" class="hidden mt-6 p-6 text-center">
                          <h3 id="form-result-title" class="font-bold text-lg"></h3>
                          <p id="form-result-message" class="mt-2 text-gray-700"></p>
                            <div class="flex justify-center flex-wrap gap-4 mt-4">
                                <a id="form-result-link" href="#" target="_blank" class="btn btn-success">เปิดไฟล์ PDF</a>
                             </div>
                      </div>
                </div>

                <div id="profile-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">ข้อมูลส่วนตัว</h2>
                      <form id="profile-form">
                         <div class="mb-4"><label for="profile-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="profile-username" class="form-input bg-gray-200" readonly></div>
                          <div class="mb-4"><label for="profile-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="profile-fullname" class="form-input" required></div>
                          <div class="mb-4"><label for="profile-position" class="form-label">ตำแหน่ง</label><input type="text" id="profile-position" class="form-input" required></div>
                        <div class="mb-6"><label for="profile-department" class="form-label">กลุ่มสาระการเรียนรู้/กลุ่มงาน</label><input type="text" id="profile-department" class="form-input" required></div>
                        <button type="submit" id="save-profile-button" class="btn btn-primary"><div id="profile-loader" class="loader hidden"></div><span id="profile-button-text">บันทึกข้อมูล</span></button>
                          <p id="profile-message" class="text-green-600 mt-4 hidden"></p>
                    </form>
                    
                    <h2 class="text-2xl font-bold mb-4 mt-10 border-t pt-6">เปลี่ยนรหัสผ่าน</h2>
                    <form id="password-form">
                        <div class="mb-4 relative">
                            <label for="profile-current-password" class="form-label">รหัสผ่านปัจจุบัน</label>
                            <input type="password" id="profile-current-password" class="form-input" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="profile-new-password" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" id="profile-new-password" class="form-input" required>
                        </div>
                        <div class="mb-6 relative">
                            <label for="profile-confirm-password" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                            <input type="password" id="profile-confirm-password" class="form-input" required>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-password-toggle" class="form-checkbox h-5 w-5 text-indigo-600">
                                <span class="ml-2 text-gray-700">แสดงรหัสผ่าน</span>
                            </label>
                        </div>
                        <button type="submit" id="save-password-button" class="btn btn-primary">
                            <div id="password-loader" class="loader hidden"></div>
                            <span id="password-button-text">เปลี่ยนรหัสผ่าน</span>
                        </button>
                        <p id="password-message" class="text-green-600 mt-4 hidden"></p>
                        <p id="password-error" class="text-red-500 mt-4 hidden"></p>
                    </form>
                </div>
                
                <div id="admin-users-page" class="page-view hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-2xl font-bold">จัดการผู้ใช้งาน</h2>
                        <div class="flex gap-2">
                             <button id="import-users-button" class="btn btn-primary">
                                <div id="import-users-loader" class="loader hidden"></div>
                                <span>นำเข้าจาก Excel</span>
                             </button>
                             <button id="download-user-template-button" class="btn bg-gray-500 text-white hover:bg-gray-600">ดาวน์โหลดแม่แบบ</button>
                             <button id="add-user-button" class="btn btn-success">เพิ่มผู้ใช้ใหม่</button>
                             <input type="file" id="user-excel-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <div id="admin-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลผู้ใช้...</p></div>
                    <div id="admin-users-list" class="hidden overflow-x-auto"></div>
                </div>

                <div id="command-generation-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการบันทึกข้อความและคำสั่งไปราชการ</h2>
                    
                    <div class="flex space-x-2 border-b-2 border-gray-200 mb-4">
                        <button id="admin-view-requests-tab" class="tab-button active">คำขอทั้งหมด</button>
                        <button id="admin-view-memos-tab" class="tab-button">บันทึกที่ส่งแล้ว</button>
                    </div>

                    <div id="admin-requests-view">
                        <div id="command-requests-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดคำขอทั้งหมด...</p></div>
                        <div id="command-requests-list" class="hidden overflow-x-auto"></div>
                        <p id="no-command-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบคำขอที่ต้องดำเนินการ</p>
                    </div>
                    
                    <div id="admin-memos-view" class="hidden">
                         <div id="admin-memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                        <div id="admin-memos-list" class="hidden overflow-x-auto"></div>
                        <p id="no-admin-memos-message" class="text-center text-gray-500 p-8 hidden">ไม่พบบันทึกข้อความ</p>
                    </div>
                </div>
                
                <div id="stats-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">สรุปสถิติข้อมูลทั้งหมด</h2>
                    <div id="stats-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังประมวลผลข้อมูลสถิติ...</p>
                    </div>
                    <div id="stats-content" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                        <div id="stats-by-user" class="stat-card"></div>
                        <div id="stats-by-department" class="stat-card"></div>
                        <div id="stats-by-year" class="stat-card"></div>
                        <div id="stats-by-expense" class="stat-card"></div>
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            <p>จัดทำโดยกลุ่มบริหารงานบุคคล โรงเรียนวังน้ำเย็นวิทยาคม </p>
            <p>พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี </p>
        </footer>
    </div>

    <div id="register-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">สมัครใช้งานใหม่</h3>
            <form id="register-form">
                <div class="mb-4"><label for="register-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="register-username" class="form-input" required></div>
                 <div class="mb-4"><label for="register-password" class="form-label">รหัสผ่าน (Password)</label><input type="password" id="register-password" class="form-input" required></div>
                 <div class="mb-4"><label for="register-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="register-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="register-position" class="form-label">ตำแหน่ง</label><input type="text" id="register-position" class="form-input" required></div>
                 <div class="mb-4"><label for="register-department" class="form-label">กลุ่มสาระการเรียนรู้</label><input type="text" id="register-department" class="form-input" required></div>
                <p id="register-error" class="text-red-500 mb-4 hidden"></p>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="register-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="register-save-button" class="btn btn-primary"><div id="register-loader" class="loader hidden"></div><span id="register-button-text">สมัครใช้งาน</span></button></div>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 id="admin-modal-title" class="text-xl font-bold mb-4">เพิ่มผู้ใช้ใหม่</h3>
            <form id="admin-modal-form">
                <input type="hidden" id="modal-original-username">
                <div class="mb-4"><label for="modal-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="modal-username" class="form-input" required></div>
                <div class="mb-4"><label for="modal-password" class="form-label">รหัสผ่าน (เว้นว่างไว้หากไม่ต้องการเปลี่ยน)</label><input type="password" id="modal-password" class="form-input" placeholder="รหัสผ่านใหม่"></div>
                 <div class="mb-4"><label for="modal-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="modal-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-position" class="form-label">ตำแหน่ง</label><input type="text" id="modal-position" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-department" class="form-label">กลุ่มสาระฯ/งาน</label><input type="text" id="modal-department" class="form-input" required></div>
                 <div class="mb-4">
                    <label for="modal-role" class="form-label">สิทธิ์</label>
                    <select id="modal-role" class="form-input"><option value="user">User</option><option value="admin">Admin</option></select>
                </div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="admin-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="admin-modal-save-button" class="btn btn-primary"><div id="admin-modal-loader" class="loader hidden"></div><span id="admin-modal-button-text">บันทึก</span></button></div>
            </form>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content text-center">
            <h3 id="alert-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="alert-modal-message" class="mb-6"></p>
            <button id="alert-modal-close-button" class="btn btn-primary">ตกลง</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="confirm-modal-message" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-no-button" class="btn bg-gray-300">ยกเลิก</button>
                <button id="confirm-modal-yes-button" class="btn btn-danger">ยืนยัน</button>
            </div>
        </div>
    </div>
    
    <div id="command-approval-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">เลือกรูปแบบคำสั่งเพื่ออนุมัติ</h3>
            <form id="command-approval-form">
                <input type="hidden" id="approval-request-id">
                <p class="mb-4">กรุณาเลือกรูปแบบคำสั่งที่ถูกต้องตามจำนวนผู้เดินทาง</p>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-100">
                        <label for="template-solo" class="flex items-center cursor-pointer flex-grow">
                            <input type="radio" id="template-solo" name="templateType" value="solo" required class="mr-3 h-4 w-4">
                            เดินทาง 1 คน
                        </label>
                        <button type="button" id="preview-solo" class="text-sm text-indigo-600 hover:underline font-semibold">ดูตัวอย่าง</button>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-100">
                        <label for="template-small" class="flex items-center cursor-pointer flex-grow">
                            <input type="radio" id="template-small" name="templateType" value="groupSmall" class="mr-3 h-4 w-4">
                            เดินทาง 2-5 คน
                        </label>
                        <button type="button" id="preview-small" class="text-sm text-indigo-600 hover:underline font-semibold">ดูตัวอย่าง</button>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-100">
                        <label for="template-large" class="flex items-center cursor-pointer flex-grow">
                            <input type="radio" id="template-large" name="templateType" value="groupLarge" class="mr-3 h-4 w-4">
                            เดินทาง 6 คนขึ้นไป
                        </label>
                        <button type="button" id="preview-large" class="text-sm text-indigo-600 hover:underline font-semibold">ดูตัวอย่าง</button>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="command-approval-modal-close-button">ยกเลิก</button>
                    <button type="submit" id="command-approval-submit-button" class="btn btn-primary">
                        <div id="command-approval-loader" class="loader hidden"></div>
                        <span>ยืนยันและออกคำสั่ง</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="admin-memo-action-modal" class="modal">
        <div class="modal-content">
             <h3 class="text-xl font-bold mb-4">จัดการไฟล์ที่เสร็จสมบูรณ์</h3>
             <form id="admin-memo-action-form">
                <input type="hidden" id="action-memo-id">
                <p class="mb-4">อัปโหลดไฟล์ที่ผ่านการอนุมัติและลงนามเรียบร้อยแล้ว</p>
                <div class="mb-3">
                    <label for="completed-memo-file" class="form-label">ไฟล์บันทึกข้อความ (ฉบับสมบูรณ์)</label>
                    <input type="file" id="completed-memo-file" class="form-input" accept="application/pdf">
                </div>
                 <div class="mb-3">
                    <label for="completed-command-file" class="form-label">ไฟล์คำสั่ง (ฉบับสมบูรณ์)</label>
                    <input type="file" id="completed-command-file" class="form-input" accept="application/pdf">
                </div>
                <div class="mb-6">
                    <label for="dispatch-book-file" class="form-label">หนังสือส่ง (ถ้ามี)</label>
                    <input type="file" id="dispatch-book-file" class="form-input" accept="application/pdf">
                </div>
                 <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="admin-memo-action-modal-close-button">ยกเลิก</button>
                    <button type="submit" id="admin-memo-action-submit-button" class="btn btn-success">
                        <div id="admin-memo-action-loader" class="loader hidden"></div>
                        <span>เสร็จสิ้นและส่งไฟล์</span>
                    </button>
                </div>
             </form>
        </div>
    </div>
    
    <div id="stats-detail-modal" class="modal">
        <div class="modal-content">
            <h3 id="stats-detail-title" class="text-xl font-bold mb-4"></h3>
            <div id="stats-detail-content" class="max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="btn bg-gray-300" id="stats-detail-modal-close-button">ปิด</button>
            </div>
        </div>
    </div>

    <div id="dispatch-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">สร้างหนังสือส่ง</h3>
            <form id="dispatch-form">
                <input type="hidden" id="dispatch-request-id">
                <div class="mb-4">
                    <label for="dispatch-month" class="form-label">เดือน</label>
                    <select id="dispatch-month" class="form-input" required>
                        <option value="มกราคม">มกราคม</option>
                        <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                        <option value="มีนาคม">มีนาคม</option>
                        <option value="เมษายน">เมษายน</option>
                        <option value="พฤษภาคม">พฤษภาคม</option>
                        <option value="มิถุนายน">มิถุนายน</option>
                        <option value="กรกฎาคม">กรกฎาคม</option>
                        <option value="สิงหาคม">สิงหาคม</option>
                        <option value="กันยายน">กันยายน</option>
                        <option value="ตุลาคม">ตุลาคม</option>
                        <option value="พฤศจิกายน">พฤศจิกายน</option>
                        <option value="ธันวาคม">ธันวาคม</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="dispatch-year" class="form-label">ปี พ.ศ.</label>
                    <input type="number" id="dispatch-year" class="form-input" placeholder="เช่น 2567" required>
                </div>
                <div class="mb-4">
                    <label for="dispatch-memo-count" class="form-label">จำนวนบันทึกข้อความ</label>
                    <input type="number" id="dispatch-memo-count" class="form-input" placeholder="กรอกเป็นตัวเลข" required>
                </div>
                <div class="mb-4">
                    <label for="dispatch-command-count" class="form-label">จำนวนคำสั่ง</label>
                    <input type="number" id="dispatch-command-count" class="form-input" placeholder="กรอกเป็นตัวเลข" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="dispatch-modal-close-button">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">สร้างหนังสือ</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="send-memo-modal" class="modal">
         <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">ส่งบันทึกข้อความ</h3>
            <form id="send-memo-form">
                 <input type="hidden" id="memo-modal-request-id">
                 <div class="mb-4">
                    <label class="form-label">ประเภทการส่ง</label>
                    <div class="flex gap-4 mt-2">
                        <div><input type="radio" id="modal-memo-type-no-reimburse" name="modal_memo_type" value="no_reimburse" checked><label for="modal-memo-type-no-reimburse" class="ml-2">ไม่เบิก (แนบไฟล์)</label></div>
                        <div><input type="radio" id="modal-memo-type-reimburse" name="modal_memo_type" value="reimburse"><label for="modal-memo-type-reimburse" class="ml-2">เบิก (ไม่ต้องแนบไฟล์)</label></div>
                    </div>
                </div>
                 <div id="modal-memo-file-container" class="mb-6">
                    <label for="modal-memo-file" class="form-label">ไฟล์บันทึกข้อความ (PDF เท่านั้น)</label>
                    <input type="file" id="modal-memo-file" class="form-input" accept="application/pdf" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="send-memo-modal-close-button">ยกเลิก</button>
                    <button type="submit" id="send-memo-submit-button" class="btn btn-primary">
                        <div id="send-memo-loader" class="loader hidden"></div>
                        <span>ส่งบันทึก</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
// ใช้ URL ของ Google Apps Script ที่คุณให้มา
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBlEmcMGrCrxRul_Maz9pqMFiWxvNXo5htmJ-jUpN0h7HVQ7lpo6-D61dY_7mFbkci/exec";

// ✅ กำหนดค่า Template IDs สำหรับปุ่ม Preview
const COMMAND_TEMPLATE_SOLO_ID = '1tanbQgNp8NYCjUCDig0qvzpzZ4tFsT1Z_ru6qGn5O4g';
const COMMAND_TEMPLATE_GROUP_SMALL_ID = '1jzJg_qwRYNa8wjb32PVgnVmrzkO0bNVNcOECb2a6u6Y';
const COMMAND_TEMPLATE_GROUP_LARGE_ID = '10M8eolqah-8WXxHQ_q43NXiCOv0CkbnBxqq6AgfxtB0';

// Global State
let allRequestsCache = [];
let allMemosCache = [];
let userMemosCache = [];
let allUsersCache = [];
let specialPositionMap = {};

const statusTranslations = {
    'Pending': 'กำลังดำเนินการ',
    'Submitted': 'กำลังดำเนินการ',
    'Approved': 'เสร็จสิ้นรอออกคำสั่งไปราชการ',
    'Pending Approval': 'กำลังดำเนินการ',
    'เสร็จสิ้น/รับไฟล์ไปใช้งาน': 'เสร็จสิ้น',
    'รอเอกสาร (เบิก)': 'รอตรวจสอบและออกคำสั่ง',
    'นำกลับไปแก้ไข': 'นำกลับไปแก้ไข'
};

function translateStatus(status) {
    return statusTranslations[status] || status;
}

// --- Cache Management ---
const cacheManager = {
    requests: {
        data: [],
        timestamp: null,
        ttl: 5 * 60 * 1000 // 5 minutes
    },
    users: {
        data: [],
        timestamp: null,
        ttl: 10 * 60 * 1000 // 10 minutes
    },
    memos: {
        data: [],
        timestamp: null,
        ttl: 5 * 60 * 1000 // 5 minutes
    },
    
    isValid(cacheType) {
        return this[cacheType].timestamp && 
               (Date.now() - this[cacheType].timestamp) < this[cacheType].ttl;
    },
    
    set(cacheType, data) {
        this[cacheType].data = data;
        this[cacheType].timestamp = Date.now();
    },
    
    clear(cacheType = null) {
        if (cacheType) {
            this[cacheType].data = [];
            this[cacheType].timestamp = null;
        } else {
            Object.keys(this).forEach(key => {
                this[key].data = [];
                this[key].timestamp = null;
            });
        }
    }
};

// ✅ เพิ่ม Security Functions
function sanitizeHTML(str) {
    if (typeof str !== 'string') return str;
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function validateInput(input, type = 'text') {
    if (typeof input !== 'string') return false;
    
    const trimmed = input.trim();
    
    switch (type) {
        case 'email':
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(trimmed);
        case 'number':
            return !isNaN(trimmed) && isFinite(trimmed) && trimmed !== '';
        case 'date':
            return !isNaN(new Date(trimmed).getTime());
        case 'username':
            return /^[a-zA-Z0-9_]+$/.test(trimmed) && trimmed.length >= 3;
        default:
            return trimmed.length > 0;
    }
}

// --- API HELPER FUNCTIONS ---

async function apiCall(method, action, payload = {}) {
    let url = SCRIPT_URL;
    const options = {
        method: method,
        redirect: 'follow',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    };

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.log('Request timeout after 60 seconds');
        }, 60000);
        options.signal = controller.signal;

        if (method === 'GET') {
            const params = new URLSearchParams({ 
                action, 
                ...payload, 
                cacheBust: new Date().getTime() 
            });
            url += `?${params}`;
        } else {
            options.body = JSON.stringify({ action, payload });
        }

        const response = await fetch(url, options);
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        
        return result;
    } catch (error) {
        console.error('API Call Error:', error);
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            throw new Error('การเชื่อมต่อใช้เวลานานเกินไป กรุณาลองใหม่');
        } else if (error.message.includes('Failed to fetch')) {
            throw new Error('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
        } else {
            throw new Error(`Server error: ${error.message}`);
        }
    }
}

// ✅ เพิ่ม API Call with Retry
async function apiCallWithRetry(method, action, payload = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            return await apiCall(method, action, payload);
        } catch (error) {
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
}

// --- UTILITY FUNCTIONS ---

function showAlert(title, message) {
    const alertModal = document.getElementById('alert-modal');
    if (!alertModal) {
        console.error('Alert modal not found');
        alert(`${title}: ${message}`);
        return;
    }
    
    document.getElementById('alert-modal-title').textContent = title;
    document.getElementById('alert-modal-message').textContent = message;
    alertModal.style.display = 'flex';
}

function showConfirm(title, message) {
    return new Promise((resolve) => {
        const confirmModal = document.getElementById('confirm-modal');
        if (!confirmModal) {
            const result = confirm(`${title}: ${message}`);
            resolve(result);
            return;
        }

        document.getElementById('confirm-modal-title').textContent = title;
        document.getElementById('confirm-modal-message').textContent = message;
        confirmModal.style.display = 'flex';

        const yesButton = document.getElementById('confirm-modal-yes-button');
        const noButton = document.getElementById('confirm-modal-no-button');
        
        const cleanup = () => {
            confirmModal.style.display = 'none';
            yesButton.removeEventListener('click', onYes);
            noButton.removeEventListener('click', onNo);
        };

        const onYes = () => { cleanup(); resolve(true); };
        const onNo = () => { cleanup(); resolve(false); };

        yesButton.addEventListener('click', onYes, { once: true });
        noButton.addEventListener('click', onNo, { once: true });
    });
}

function toggleLoader(buttonId, show) {
    const button = document.getElementById(buttonId);
    if (!button) {
        console.error(`Button with id '${buttonId}' not found`);
        return;
    }
    
    const loader = button.querySelector('.loader');
    const text = button.querySelector('span');
    
    if (show) {
        if (loader) loader.classList.remove('hidden');
        if (text) text.classList.add('hidden');
        button.disabled = true;
    } else {
        if (loader) loader.classList.add('hidden');
        if (text) text.classList.remove('hidden');
        button.disabled = false;
    }
}

function getCurrentUser() {
    try {
        const userJson = sessionStorage.getItem('currentUser');
        return userJson ? JSON.parse(userJson) : null;
    } catch (error) {
        console.error('Error getting current user:', error);
        return null;
    }
}

function fileToObject(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const data = reader.result.toString().split(',')[1];
            resolve({ filename: file.name, mimeType: file.type, data: data });
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

// ✅ เพิ่มฟังก์ชันจัดการสถานะ UI
function showLoadingState(containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container with id '${containerId}' not found`);
        return;
    }
    container.innerHTML = `
        <div class="loading-state">
            <div class="loader"></div>
            <span class="ml-2">กำลังโหลด...</span>
        </div>
    `;
}

function showEmptyState(containerId, message) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container with id '${containerId}' not found`);
        return;
    }
    container.innerHTML = `
        <div class="empty-state">
            <p>${sanitizeHTML(message)}</p>
        </div>
    `;
}

function showErrorState(containerId, message) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container with id '${containerId}' not found`);
        return;
    }
    container.innerHTML = `
        <div class="error-state">
            <p>${sanitizeHTML(message)}</p>
        </div>
    `;
}

// ✅ เพิ่มฟังก์ชัน validation วันที่
function validateDates(startDate, endDate) {
    try {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (start < today) {
            return 'วันที่เริ่มต้นต้องไม่เป็นวันในอดีต';
        }
        
        if (end < start) {
            return 'วันที่สิ้นสุดต้องไม่มาก่อนวันที่เริ่มต้น';
        }
        
        if ((end - start) / (1000 * 60 * 60 * 24) > 30) {
            return 'ระยะเวลาในการไปราชการต้องไม่เกิน 30 วัน';
        }
        
        return null;
    } catch (error) {
        return 'รูปแบบวันที่ไม่ถูกต้อง';
    }
}

// Debounce สำหรับ search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// --- PAGE NAVIGATION ---

async function switchPage(targetPageId) {
    try {
        // Hide all pages
        document.querySelectorAll('.page-view').forEach(page => {
            if (page.classList) {
                page.classList.add('hidden');
            }
        });
        
        // Show target page
        const targetPage = document.getElementById(targetPageId);
        if (targetPage && targetPage.classList) {
            targetPage.classList.remove('hidden');
        }

        // Update active nav buttons
        document.querySelectorAll('.nav-button').forEach(btn => {
            if (btn.classList) {
                btn.classList.remove('active');
                if(btn.dataset.target === targetPageId) {
                    btn.classList.add('active');
                }
            }
        });

        // Load page-specific data
        if (targetPageId === 'form-page') await resetRequestForm();
        if (targetPageId === 'dashboard-page') await fetchUserRequests();
        if (targetPageId === 'profile-page') loadProfileData();
        if (targetPageId === 'stats-page') await loadStatsData();
        if (targetPageId === 'admin-users-page') await fetchAllUsers();
        if (targetPageId === 'command-generation-page') {
            const requestsTab = document.getElementById('admin-view-requests-tab');
            if (requestsTab) requestsTab.click();
        }
    } catch (error) {
        console.error('Error switching page:', error);
        showAlert('ข้อผิดพลาด', 'ไม่สามารถเปลี่ยนหน้าได้: ' + error.message);
    }
}

// --- MAIN APP LOGIC ---

document.addEventListener('DOMContentLoaded', () => {
    console.log('App Initializing with Google Sheets Backend...');
    try {
        setupEventListeners();
        const user = getCurrentUser();
        if (user) {
            initializeUserSession(user);
        } else {
            showLoginScreen();
        }
    } catch (error) {
        console.error('Error during app initialization:', error);
        showAlert('System Error', 'An unexpected error occurred. Please refresh the page.');
    }
});

// --- INITIALIZATION ---

function initializeUserSession(user) {
    try {
        updateUIForUser(user);
        showMainApp();
        switchPage('dashboard-page');
    } catch (error) {
        console.error('Error initializing user session:', error);
        showAlert('ข้อผิดพลาด', 'ไม่สามารถเริ่มต้นเซสชันได้: ' + error.message);
    }
}

function updateUIForUser(user) {
    try {
        const fullnameElement = document.getElementById('user-fullname');
        const positionElement = document.getElementById('user-position');
        
        if (fullnameElement) fullnameElement.textContent = user.fullName || 'N/A';
        if (positionElement) positionElement.textContent = user.position || 'N/A';

        const isAdmin = user.role === 'admin';
        
        const adminCommandNav = document.getElementById('admin-nav-command');
        const adminUsersNav = document.getElementById('admin-nav-users');
        
        if (adminCommandNav) adminCommandNav.classList.toggle('hidden', !isAdmin);
        if (adminUsersNav) adminUsersNav.classList.toggle('hidden', !isAdmin);
    } catch (error) {
        console.error('Error updating UI for user:', error);
    }
}

function showMainApp() {
    try {
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        
        if (loginScreen && loginScreen.classList) loginScreen.classList.add('hidden');
        if (mainApp && mainApp.classList) mainApp.classList.remove('hidden');
    } catch (error) {
        console.error('Error showing main app:', error);
    }
}

function showLoginScreen() {
    try {
        sessionStorage.removeItem('currentUser');
        cacheManager.clear();
        
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        
        if (mainApp && mainApp.classList) mainApp.classList.add('hidden');
        if (loginScreen && loginScreen.classList) loginScreen.classList.remove('hidden');
    } catch (error) {
        console.error('Error showing login screen:', error);
    }
}

// --- EVENT LISTENER SETUP ---

function setupEventListeners() {
    try {
        // Auth
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const showRegisterButton = document.getElementById('show-register-modal-button');
        const registerForm = document.getElementById('register-form');

        if (loginForm) loginForm.addEventListener('submit', handleLogin);
        if (logoutButton) logoutButton.addEventListener('click', showLoginScreen);
        if (showRegisterButton) showRegisterButton.addEventListener('click', () => {
            const registerModal = document.getElementById('register-modal');
            if (registerModal) registerModal.style.display = 'flex';
        });
        if (registerForm) registerForm.addEventListener('submit', handleRegister);

        // Navigation
        const navigation = document.getElementById('navigation');
        if (navigation) {
            navigation.addEventListener('click', (e) => {
                const navButton = e.target.closest('.nav-button');
                if (navButton && navButton.dataset.target) {
                    switchPage(navButton.dataset.target);
                }
            });
        }

        // Modal close handlers
        setupModalCloseHandlers();

        // Forms
        const requestForm = document.getElementById('request-form');
        if (requestForm) requestForm.addEventListener('submit', handleRequestFormSubmit);

        // Add other essential event listeners
        setupFormEventListeners();
        setupAdminEventListeners();
        setupAdditionalEventListeners();

    } catch (error) {
        console.error('Error setting up event listeners:', error);
    }
}

function setupModalCloseHandlers() {
    // Modal close buttons
    const closeButtons = [
        'register-modal-close-button',
        'admin-modal-close-button',
        'alert-modal-close-button',
        'command-approval-modal-close-button',
        'admin-memo-action-modal-close-button',
        'stats-detail-modal-close-button',
        'dispatch-modal-close-button',
        'send-memo-modal-close-button'
    ];

    closeButtons.forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
            button.addEventListener('click', () => {
                const modal = button.closest('.modal');
                if (modal) modal.style.display = 'none';
            });
        }
    });

    // Close modal when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
}

function setupFormEventListeners() {
    try {
        // Request form elements
        const addAttendeeBtn = document.getElementById('form-add-attendee');
        if (addAttendeeBtn) addAttendeeBtn.addEventListener('click', () => addAttendeeField());

        // Expense options
        document.querySelectorAll('input[name="expense_option"]').forEach(radio => {
            radio.addEventListener('change', toggleExpenseOptions);
        });

        // Vehicle options
        document.querySelectorAll('input[name="vehicle_option"]').forEach(radio => {
            radio.addEventListener('change', toggleVehicleOptions);
        });

        // Department change
        const departmentSelect = document.getElementById('form-department');
        if (departmentSelect) {
            departmentSelect.addEventListener('change', (e) => {
                const selectedPosition = e.target.value;
                const headNameInput = document.getElementById('form-head-name');
                if (headNameInput) {
                    headNameInput.value = specialPositionMap[selectedPosition] || '';
                }
            });
        }

        // Search
        const searchInput = document.getElementById('search-requests');
        if (searchInput) {
            searchInput.addEventListener('input', debounce((e) => {
                renderRequestsList(allRequestsCache, userMemosCache, e.target.value);
            }, 300));
        }

    } catch (error) {
        console.error('Error setting up form event listeners:', error);
    }
}

function setupAdminEventListeners() {
    try {
        // Admin tabs
        const requestsTab = document.getElementById('admin-view-requests-tab');
        const memosTab = document.getElementById('admin-view-memos-tab');

        if (requestsTab) {
            requestsTab.addEventListener('click', (e) => {
                if (memosTab && memosTab.classList) memosTab.classList.remove('active');
                if (e.target && e.target.classList) e.target.classList.add('active');
                
                const requestsView = document.getElementById('admin-requests-view');
                const memosView = document.getElementById('admin-memos-view');
                
                if (requestsView && requestsView.classList) requestsView.classList.remove('hidden');
                if (memosView && memosView.classList) memosView.classList.add('hidden');
                
                fetchAllRequestsForCommand();
            });
        }

        if (memosTab) {
            memosTab.addEventListener('click', (e) => {
                if (requestsTab && requestsTab.classList) requestsTab.classList.remove('active');
                if (e.target && e.target.classList) e.target.classList.add('active');
                
                const requestsView = document.getElementById('admin-requests-view');
                const memosView = document.getElementById('admin-memos-view');
                
                if (memosView && memosView.classList) memosView.classList.remove('hidden');
                if (requestsView && requestsView.classList) requestsView.classList.add('hidden');
                
                fetchAllMemos();
            });
        }

    } catch (error) {
        console.error('Error setting up admin event listeners:', error);
    }
}

// --- AUTHENTICATION HANDLERS ---

async function handleLogin(e) {
    if (e) e.preventDefault();
    
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const errorP = document.getElementById('login-error');
    
    if (!usernameInput || !passwordInput) {
        showAlert('ข้อผิดพลาด', 'ไม่พบฟิลด์ชื่อผู้ใช้หรือรหัสผ่าน');
        return;
    }

    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    if (errorP && errorP.classList) errorP.classList.add('hidden');
    toggleLoader('login-button', true);

    if (!validateInput(username, 'username')) {
        if (errorP) {
            errorP.textContent = 'ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร และประกอบด้วยตัวอักษรภาษาอังกฤษและตัวเลขเท่านั้น';
            errorP.classList.remove('hidden');
        }
        toggleLoader('login-button', false);
        return;
    }

    try {
        const result = await apiCallWithRetry('POST', 'verifyCredentials', { username, password });
        sessionStorage.setItem('currentUser', JSON.stringify(result.user));
        initializeUserSession(result.user);
    } catch (error) {
        if (errorP) {
            errorP.textContent = error.message;
            errorP.classList.remove('hidden');
        }
    } finally {
        toggleLoader('login-button', false);
    }
}

async function handleRegister(e) {
    if (e) e.preventDefault();
    
    const payload = {
        username: document.getElementById('register-username')?.value.trim() || '',
        password: document.getElementById('register-password')?.value || '',
        fullName: document.getElementById('register-fullname')?.value.trim() || '',
        position: document.getElementById('register-position')?.value.trim() || '',
        department: document.getElementById('register-department')?.value.trim() || '',
        role: 'user'
    };

    const errorP = document.getElementById('register-error');
    if (errorP && errorP.classList) errorP.classList.add('hidden');
    
    if (!validateInput(payload.username, 'username')) {
        if (errorP) {
            errorP.textContent = "ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร และประกอบด้วยตัวอักษรภาษาอังกฤษและตัวเลขเท่านั้น";
            errorP.classList.remove('hidden');
        }
        return;
    }
    
    if (payload.password.length < 6) {
        if (errorP) {
            errorP.textContent = "รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร";
            errorP.classList.remove('hidden');
        }
        return;
    }

    toggleLoader('register-save-button', true);
    
    try {
        const result = await apiCallWithRetry('POST', 'registerUser', payload);
        const registerModal = document.getElementById('register-modal');
        if (registerModal) registerModal.style.display = 'none';
        
        const registerForm = document.getElementById('register-form');
        if (registerForm) registerForm.reset();
        
        showAlert("สมัครสำเร็จ", result.message);
    } catch (error) {
        if (errorP) {
            errorP.textContent = error.message;
            errorP.classList.remove('hidden');
        }
    } finally {
        toggleLoader('register-save-button', false);
    }
}

// --- DASHBOARD FUNCTIONS ---

async function fetchUserRequests() {
    const user = getCurrentUser();
    if (!user) return;
    
    showLoadingState('requests-container');
    const noDataMsg = document.getElementById('no-requests-message');
    if (noDataMsg && noDataMsg.classList) noDataMsg.classList.add('hidden');

    try {
        // ใช้ cache ถ้ามี
        if (cacheManager.isValid('requests') && cacheManager.requests.data.length > 0) {
            allRequestsCache = cacheManager.requests.data;
            // ดึง memos แยกต่างหาก
            const memosResult = await apiCallWithRetry('GET', 'getSentMemos', { username: user.username });
            userMemosCache = memosResult.data || [];
        } else {
            // ดึงข้อมูลใหม่
            const [requestsResult, memosResult] = await Promise.all([
                apiCallWithRetry('GET', 'getUserRequests', { username: user.username }),
                apiCallWithRetry('GET', 'getSentMemos', { username: user.username })
            ]);
            
            allRequestsCache = requestsResult.data?.sort((a, b) => {
                const dateA = new Date(a.timestamp || a.createdAt || 0);
                const dateB = new Date(b.timestamp || b.createdAt || 0);
                return dateB - dateA;
            }) || [];
            
            userMemosCache = memosResult.data || [];
            
            cacheManager.set('requests', allRequestsCache);
            cacheManager.set('memos', userMemosCache);
        }
        
        if (allRequestsCache.length === 0) {
            showEmptyState('requests-container', 'ไม่พบรายการคำขอของคุณ');
        } else {
            renderRequestsList(allRequestsCache, userMemosCache);
        }
    } catch (error) {
        console.error("Error fetching user requests:", error);
        showErrorState('requests-container', 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message);
    }
}

function renderRequestsList(requests, memos = [], searchTerm = '') {
    const listContainer = document.getElementById('requests-list');
    const noDataMsg = document.getElementById('no-requests-message');
    
    if (!listContainer) return;
    
    listContainer.innerHTML = '';

    let filteredRequests = requests || [];
    if (searchTerm) {
        const lowerCaseSearch = searchTerm.toLowerCase();
        filteredRequests = filteredRequests.filter(req => 
            (req.purpose?.toLowerCase().includes(lowerCaseSearch)) ||
            (req.location?.toLowerCase().includes(lowerCaseSearch)) ||
            (req.id?.toLowerCase().includes(lowerCaseSearch))
        );
    }
    
    if (filteredRequests.length === 0) {
        if (noDataMsg && noDataMsg.classList) {
            noDataMsg.classList.remove('hidden');
        }
        if (listContainer.classList) {
            listContainer.classList.add('hidden');
        }
    } else {
        if (noDataMsg && noDataMsg.classList) {
            noDataMsg.classList.add('hidden');
        }
        if (listContainer.classList) {
            listContainer.classList.remove('hidden');
        }

        const list = document.createElement('div');
        list.className = 'space-y-4';

        const memoMap = new Map();
        if (memos && Array.isArray(memos)) {
            memos.forEach(memo => {
                if (memo.refNumber) {
                    memoMap.set(memo.refNumber, memo);
                }
            });
        }

        filteredRequests.forEach(req => {
            const memo = memoMap.get(req.id);
            let completedFilesHTML = '';
            
            const isCompleted = memo && (
                memo.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน' || 
                memo.status === 'Approved' ||
                memo.status === 'เสร็จสิ้นรอออกคำสั่งไปราชการ'
            );
            
            if (memo) {
                if (memo.completedMemoUrl) {
                    completedFilesHTML += `<a href="${memo.completedMemoUrl}" target="_blank" class="text-green-600 hover:text-green-900 text-sm font-semibold">ไฟล์บันทึก</a>`;
                }
                if (memo.completedCommandUrl) {
                    completedFilesHTML += `<a href="${memo.completedCommandUrl}" target="_blank" class="text-blue-600 hover:text-blue-900 text-sm font-semibold ml-4">ไฟล์คำสั่ง</a>`;
                }
                if (memo.dispatchBookUrl) {
                    completedFilesHTML += `<a href="${memo.dispatchBookUrl}" target="_blank" class="text-purple-600 hover:text-purple-900 text-sm font-semibold ml-4">หนังสือส่ง</a>`;
                }
            }

            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg shadow-sm hover:shadow-md transition bg-white';
            
            let actionButtons = '';
            if (isCompleted) {
                actionButtons = `
                    <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 justify-end">
                        ${req.pdfUrl ? `<a href="${req.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูร่างบันทึก</a>` : ''}
                        <button class="btn text-sm bg-gray-400 text-white cursor-not-allowed" disabled>ส่งบันทึก</button>
                        <button class="btn text-sm bg-gray-400 text-white cursor-not-allowed" disabled>แก้ไข</button>
                        <button class="btn text-sm bg-gray-400 text-white cursor-not-allowed" disabled>ลบ</button>
                        <span class="text-xs text-red-500 font-semibold self-center">(ไม่สามารถแก้ไขได้ เนื่องจากสถานะเสร็จสิ้น)</span>
                    </div>
                `;
            } else {
                actionButtons = `
                    <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 justify-end">
                        ${req.pdfUrl ? `<a href="${req.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูร่างบันทึก</a>` : ''}
                        <button class="btn text-sm bg-blue-500 text-white" data-id="${req.id}" data-action="send-memo">ส่งบันทึก</button>
                        <button class="btn text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900" data-id="${req.id}" data-action="edit">แก้ไข</button>
                        <button class="btn text-sm btn-danger" data-id="${req.id}" data-action="delete">ลบ</button>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="flex flex-wrap justify-between items-start gap-2">
                    <div>
                        <h4 class="font-bold text-lg text-indigo-700">${sanitizeHTML(req.purpose || '')}</h4>
                        <p class="text-sm text-gray-600"><strong>สถานที่:</strong> ${sanitizeHTML(req.location || '')}</p>
                        <p class="text-xs text-gray-400 mt-1"><strong>ID:</strong> ${sanitizeHTML(req.id || '')}</p>
                    </div>
                    <div class="text-right text-xs space-y-1">
                        <p>สถานะ: <span class="font-bold px-2 py-1 rounded-full ${
                            isCompleted ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                        }">${memo ? translateStatus(memo.status) : 'ยังไม่ส่ง'}</span></p>
                        ${isCompleted ? '<p class="text-red-500 text-xs font-semibold">⚠️ สถานะเสร็จสิ้น</p>' : ''}
                    </div>
                </div>

                ${completedFilesHTML ? `
                <div class="border-t mt-3 pt-3">
                    <h5 class="text-sm font-bold text-gray-700 mb-2">ไฟล์ฉบับสมบูรณ์:</h5>
                    <div class="flex flex-wrap gap-4">
                        ${completedFilesHTML}
                    </div>
                </div>
                ` : ''}

                ${actionButtons}
            `;
            list.appendChild(card);
        });
        
        listContainer.appendChild(list);
        listContainer.addEventListener('click', handleRequestAction);
    }
}

// --- MEMO MANAGEMENT FUNCTIONS ---

async function fetchAllMemos() {
    showLoadingState('admin-memos-list');
    
    try {
        if (cacheManager.isValid('memos') && cacheManager.memos.data.length > 0) {
            allMemosCache = cacheManager.memos.data;
        } else {
            const result = await apiCallWithRetry('GET', 'getAllMemos');
            allMemosCache = result.data?.sort((a, b) => {
                const dateA = new Date(a.timestamp || a.createdAt || 0);
                const dateB = new Date(b.timestamp || b.createdAt || 0);
                return dateB - dateA;
            }) || [];
            cacheManager.set('memos', allMemosCache);
        }
        
        renderMemosList(allMemosCache);
    } catch (error) {
        console.error("Error fetching all memos:", error);
        showErrorState('admin-memos-list', 'เกิดข้อผิดพลาดในการโหลดข้อมูลบันทึกข้อความ: ' + error.message);
    }
}

function renderMemosList(memos) {
    const listContainer = document.getElementById('admin-memos-list');
    const noDataMsg = document.getElementById('no-admin-memos-message');
    const loader = document.getElementById('admin-memos-loader');
    
    if (!listContainer) return;
    
    if (loader && loader.classList) loader.classList.add('hidden');
    
    if (!memos || memos.length === 0) {
        if (listContainer && listContainer.classList) listContainer.classList.add('hidden');
        if (noDataMsg && noDataMsg.classList) noDataMsg.classList.remove('hidden');
        return;
    }

    if (listContainer && listContainer.classList) listContainer.classList.remove('hidden');
    if (noDataMsg && noDataMsg.classList) noDataMsg.classList.add('hidden');

    let html = `
        <table class="min-w-full bg-white">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-4 border text-left">รหัสอ้างอิง</th>
                    <th class="py-2 px-4 border text-left">ผู้ส่ง</th>
                    <th class="py-2 px-4 border text-left">สถานะ</th>
                    <th class="py-2 px-4 border text-left">วันที่ส่ง</th>
                    <th class="py-2 px-4 border text-left">ไฟล์</th>
                    <th class="py-2 px-4 border text-left">การดำเนินการ</th>
                </tr>
            </thead>
            <tbody>
    `;

    memos.forEach(memo => {
        const statusClass = getStatusClass(memo.status);
        const formattedDate = memo.timestamp ? formatDate(new Date(memo.timestamp)) : '-';
        
        html += `
            <tr class="hover:bg-gray-50">
                <td class="py-2 px-4 border">${sanitizeHTML(memo.refNumber || '-')}</td>
                <td class="py-2 px-4 border">${sanitizeHTML(memo.submittedBy || '-')}</td>
                <td class="py-2 px-4 border">
                    <span class="px-2 py-1 rounded-full text-xs ${statusClass}">
                        ${translateStatus(memo.status || 'Unknown')}
                    </span>
                </td>
                <td class="py-2 px-4 border">${formattedDate}</td>
                <td class="py-2 px-4 border">
                    <div class="flex flex-wrap gap-2">
                        ${memo.fileURL ? 
                            `<a href="${memo.fileURL}" target="_blank" class="text-blue-600 hover:text-blue-900 text-sm">ไฟล์บันทึก</a>` : 
                            '<span class="text-gray-400 text-sm">ไม่มีไฟล์</span>'
                        }
                        ${memo.completedMemoUrl ? 
                            `<a href="${memo.completedMemoUrl}" target="_blank" class="text-green-600 hover:text-green-900 text-sm ml-2">ไฟล์สมบูรณ์</a>` : ''
                        }
                        ${memo.completedCommandUrl ? 
                            `<a href="${memo.completedCommandUrl}" target="_blank" class="text-purple-600 hover:text-purple-900 text-sm ml-2">คำสั่ง</a>` : ''
                        }
                    </div>
                </td>
                <td class="py-2 px-4 border">
                    <div class="flex flex-wrap gap-2">
                        ${memo.status !== 'เสร็จสิ้น/รับไฟล์ไปใช้งาน' ? 
                            `<button class="btn btn-sm btn-success complete-memo" data-id="${memo.id}">เสร็จสิ้น</button>` : 
                            '<span class="text-green-600 text-sm">ดำเนินการเรียบร้อย</span>'
                        }
                    </div>
                </td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    listContainer.innerHTML = html;

    // Add event listeners for complete buttons
    document.querySelectorAll('.complete-memo').forEach(button => {
        button.addEventListener('click', (e) => {
            const memoId = e.target.dataset.id;
            openCompleteMemoModal(memoId);
        });
    });
}

function getStatusClass(status) {
    switch (status) {
        case 'เสร็จสิ้น/รับไฟล์ไปใช้งาน':
        case 'Approved':
            return 'bg-green-100 text-green-800';
        case 'กำลังดำเนินการ':
        case 'Pending':
            return 'bg-yellow-100 text-yellow-800';
        case 'นำกลับไปแก้ไข':
            return 'bg-red-100 text-red-800';
        default:
            return 'bg-gray-100 text-gray-800';
    }
}

function formatDate(date) {
    if (!date || isNaN(date.getTime())) return '-';
    
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear() + 543; // Convert to Buddhist year
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

// --- COMPLETE MEMO MODAL ---

function openCompleteMemoModal(memoId) {
    document.getElementById('action-memo-id').value = memoId;
    document.getElementById('admin-memo-action-modal').style.display = 'flex';
}

async function handleAdminMemoActionSubmit(e) {
    if (e) e.preventDefault();
    
    const memoId = document.getElementById('action-memo-id').value;
    if (!memoId) {
        showAlert('ข้อผิดพลาด', 'ไม่พบรหัสบันทึกข้อความ');
        return;
    }

    toggleLoader('admin-memo-action-submit-button', true);

    try {
        const completedMemoFile = document.getElementById('completed-memo-file').files[0];
        const completedCommandFile = document.getElementById('completed-command-file').files[0];
        const dispatchBookFile = document.getElementById('dispatch-book-file').files[0];

        let completedMemoFileObj = null;
        let completedCommandFileObj = null;
        let dispatchBookFileObj = null;

        // Convert files to objects if they exist
        if (completedMemoFile) {
            completedMemoFileObj = await fileToObject(completedMemoFile);
        }
        if (completedCommandFile) {
            completedCommandFileObj = await fileToObject(completedCommandFile);
        }
        if (dispatchBookFile) {
            dispatchBookFileObj = await fileToObject(dispatchBookFile);
        }

        const payload = {
            id: memoId,
            status: 'เสร็จสิ้น/รับไฟล์ไปใช้งาน',
            completedMemoFile: completedMemoFileObj,
            completedCommandFile: completedCommandFileObj,
            dispatchBookFile: dispatchBookFileObj
        };

        const result = await apiCallWithRetry('POST', 'updateMemoStatus', payload);

        if (result.status === 'success') {
            document.getElementById('admin-memo-action-modal').style.display = 'none';
            showAlert('สำเร็จ', result.message);
            
            // Clear file inputs
            document.getElementById('completed-memo-file').value = '';
            document.getElementById('completed-command-file').value = '';
            document.getElementById('dispatch-book-file').value = '';
            
            // Refresh memos list
            cacheManager.clear('memos');
            await fetchAllMemos();
        } else {
            showAlert('เกิดข้อผิดพลาด', result.message);
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('admin-memo-action-submit-button', false);
    }
}

// --- SEND MEMO MODAL ---

async function handleMemoSubmitFromModal(e) {
    if (e) e.preventDefault();
    
    const requestId = document.getElementById('memo-modal-request-id').value;
    const memoType = document.querySelector('input[name="modal_memo_type"]:checked').value;
    
    if (!requestId) {
        showAlert('ข้อผิดพลาด', 'ไม่พบรหัสคำขอ');
        return;
    }

    toggleLoader('send-memo-submit-button', true);

    try {
        const user = getCurrentUser();
        let fileObj = null;

        if (memoType === 'no_reimburse') {
            const memoFile = document.getElementById('modal-memo-file').files[0];
            if (!memoFile) {
                showAlert('ข้อผิดพลาด', 'กรุณาเลือกไฟล์บันทึกข้อความ');
                toggleLoader('send-memo-submit-button', false);
                return;
            }
            fileObj = await fileToObject(memoFile);
        }

        const payload = {
            refNumber: requestId,
            username: user.username,
            memoType: memoType,
            file: fileObj
        };

        const result = await apiCallWithRetry('POST', 'uploadMemo', payload);

        if (result.status === 'success') {
            document.getElementById('send-memo-modal').style.display = 'none';
            showAlert('สำเร็จ', result.message);
            
            // Clear file input
            document.getElementById('modal-memo-file').value = '';
            
            // Refresh requests list
            cacheManager.clear('requests');
            cacheManager.clear('memos');
            await fetchUserRequests();
        } else {
            showAlert('เกิดข้อผิดพลาด', result.message);
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('send-memo-submit-button', false);
    }
}

// --- ADMIN REQUESTS LIST ---

async function fetchAllRequestsForCommand() {
    showLoadingState('command-requests-list');
    
    try {
        if (cacheManager.isValid('requests') && cacheManager.requests.data.length > 0) {
            allRequestsCache = cacheManager.requests.data;
        } else {
            const result = await apiCallWithRetry('GET', 'getAllRequests');
            allRequestsCache = result.data?.sort((a, b) => {
                const dateA = new Date(a.timestamp || a.createdAt || 0);
                const dateB = new Date(b.timestamp || b.createdAt || 0);
                return dateB - dateA;
            }) || [];
            cacheManager.set('requests', allRequestsCache);
        }
        
        renderAdminRequestsList(allRequestsCache);
    } catch (error) {
        console.error("Error fetching all requests:", error);
        showErrorState('command-requests-list', 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message);
    }
}

function renderAdminRequestsList(requests) {
    const listContainer = document.getElementById('command-requests-list');
    const noDataMsg = document.getElementById('no-command-requests-message');
    const loader = document.getElementById('command-requests-loader');
    
    if (!listContainer) return;
    
    if (loader && loader.classList) loader.classList.add('hidden');
    
    if (!requests || requests.length === 0) {
        if (listContainer && listContainer.classList) listContainer.classList.add('hidden');
        if (noDataMsg && noDataMsg.classList) noDataMsg.classList.remove('hidden');
        return;
    }

    if (listContainer && listContainer.classList) listContainer.classList.remove('hidden');
    if (noDataMsg && noDataMsg.classList) noDataMsg.classList.add('hidden');

    let html = `
        <table class="min-w-full bg-white">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-4 border text-left">ID</th>
                    <th class="py-2 px-4 border text-left">ผู้ขอ</th>
                    <th class="py-2 px-4 border text-left">วัตถุประสงค์</th>
                    <th class="py-2 px-4 border text-left">สถานที่</th>
                    <th class="py-2 px-4 border text-left">สถานะคำสั่ง</th>
                    <th class="py-2 px-4 border text-left">การดำเนินการ</th>
                </tr>
            </thead>
            <tbody>
    `;

    requests.forEach(request => {
        const hasCommand = request.commandPdfUrl && request.commandPdfUrl !== '';
        const isPending = !hasCommand && (request.commandStatus === 'กำลังดำเนินการ' || !request.commandStatus);
        const statusClass = hasCommand ? 'bg-green-100 text-green-800' : 
                            isPending ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
        
        const statusText = hasCommand ? 'ออกคำสั่งแล้ว' : 
                          isPending ? 'รอออกคำสั่ง' : 'กำลังดำเนินการ';

        html += `
            <tr class="hover:bg-gray-50">
                <td class="py-2 px-4 border">${sanitizeHTML(request.id || '-')}</td>
                <td class="py-2 px-4 border">${sanitizeHTML(request.requesterName || '-')}</td>
                <td class="py-2 px-4 border">${sanitizeHTML(request.purpose || '-')}</td>
                <td class="py-2 px-4 border">${sanitizeHTML(request.location || '-')}</td>
                <td class="py-2 px-4 border">
                    <span class="px-2 py-1 rounded-full text-xs ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td class="py-2 px-4 border">
                    <div class="flex flex-wrap gap-2">
                        ${request.pdfUrl ? 
                            `<a href="${request.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูบันทึก</a>` : 
                            '<span class="text-gray-400 text-sm">ไม่มีไฟล์</span>'
                        }
                        ${!hasCommand && isPending ? 
                            `<button class="btn btn-sm btn-primary approve-command" data-id="${request.id}">ออกคำสั่ง</button>` : 
                            hasCommand ? 
                            `<a href="${request.commandPdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูคำสั่ง</a>` :
                            '<span class="text-gray-400 text-sm">รอดำเนินการ</span>'
                        }
                    </div>
                </td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    listContainer.innerHTML = html;

    // Add event listeners for approve buttons
    document.querySelectorAll('.approve-command').forEach(button => {
        button.addEventListener('click', (e) => {
            const requestId = e.target.dataset.id;
            document.getElementById('approval-request-id').value = requestId;
            document.getElementById('command-approval-modal').style.display = 'flex';
        });
    });
}

// --- BASIC FORM FUNCTIONS ---

function getAttendeesFromForm() {
    const attendees = [];
    const attendeeRows = document.querySelectorAll('#form-attendees-list .attendee-row');
    
    attendeeRows.forEach(row => {
        const nameInput = row.querySelector('.attendee-name');
        const positionInput = row.querySelector('.attendee-position');
        
        if (nameInput && positionInput) {
            const name = nameInput.value.trim();
            const position = positionInput.value.trim();
            
            if (name && position) {
                attendees.push({ name, position });
            }
        }
    });
    
    return attendees;
}

function getExpenseItemsFromForm() {
    const items = [];
    const checkedItems = document.querySelectorAll('input[name="expense_item"]:checked');
    
    checkedItems.forEach(checkbox => {
        const itemName = checkbox.dataset.itemName;
        if (itemName === 'ค่าใช้จ่ายอื่นๆ') {
            const otherText = document.getElementById('expense_other_text')?.value || '';
            items.push({ name: itemName, detail: otherText });
        } else {
            items.push({ name: itemName });
        }
    });
    
    return items;
}

function toggleExpenseOptions() {
    const isPartial = document.getElementById('expense_partial')?.checked || false;
    const partialOptions = document.getElementById('partial-expense-options');
    const totalContainer = document.getElementById('total-expense-container');
    
    if (partialOptions && partialOptions.classList) {
        partialOptions.classList.toggle('hidden', !isPartial);
    }
    if (totalContainer && totalContainer.classList) {
        totalContainer.classList.toggle('hidden', !isPartial);
    }
}

function toggleVehicleOptions() {
    const isPrivate = document.getElementById('vehicle_private')?.checked || false;
    const privateDetails = document.getElementById('private-vehicle-details');
    
    if (privateDetails && privateDetails.classList) {
        privateDetails.classList.toggle('hidden', !isPrivate);
    }
}

function addAttendeeField(name = '', position = '') {
    const container = document.getElementById('form-attendees-list');
    if (!container) return;
    
    const index = container.children.length;
    const row = document.createElement('div');
    row.className = 'attendee-row grid grid-cols-1 md:grid-cols-2 gap-4 mb-2';
    row.innerHTML = `
        <div>
            <input type="text" class="attendee-name form-input" placeholder="ชื่อ-นามสกุล" value="${name}">
        </div>
        <div class="flex gap-2">
            <input type="text" class="attendee-position form-input" placeholder="ตำแหน่ง" value="${position}">
            <button type="button" class="btn btn-danger remove-attendee">ลบ</button>
        </div>
    `;
    container.appendChild(row);
    
    // Add event listener for remove button
    const removeBtn = row.querySelector('.remove-attendee');
    if (removeBtn) {
        removeBtn.addEventListener('click', () => {
            row.remove();
        });
    }
}

async function resetRequestForm() {
    try {
        const requestForm = document.getElementById('request-form');
        if (requestForm) requestForm.reset();
        
        document.getElementById('form-request-id').value = '';
        
        const formResult = document.getElementById('form-result');
        if (formResult && formResult.classList) formResult.classList.add('hidden');
        
        const attendeesList = document.getElementById('form-attendees-list');
        if (attendeesList) attendeesList.innerHTML = '';
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        const docDateInput = document.getElementById('form-doc-date');
        if (docDateInput) docDateInput.value = today;
        
        // Reset expense options
        const expenseNo = document.getElementById('expense_no');
        if (expenseNo) expenseNo.checked = true;
        toggleExpenseOptions();
        
        // Reset vehicle options
        const vehicleGov = document.getElementById('vehicle_gov');
        if (vehicleGov) vehicleGov.checked = true;
        toggleVehicleOptions();
        
        // Load departments
        await loadDepartments();
    } catch (error) {
        console.error('Error resetting request form:', error);
    }
}

async function loadDepartments() {
    try {
        const result = await apiCallWithRetry('GET', 'getAllUsers');
        const departments = [...new Set(result.data?.map(user => user.department).filter(Boolean) || [])];
        const select = document.getElementById('form-department');
        
        if (select) {
            select.innerHTML = '<option value="">เลือกกลุ่มสาระฯ/งาน</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading departments:', error);
    }
}

// --- REQUEST ACTION HANDLERS ---

function handleRequestAction(e) {
    const button = e.target.closest('button');
    if (!button) return;
    
    const requestId = button.dataset.id;
    const action = button.dataset.action;
    
    if (!requestId || !action) return;
    
    switch (action) {
        case 'send-memo':
            const memoRequestId = document.getElementById('memo-modal-request-id');
            if (memoRequestId) memoRequestId.value = requestId;
            
            const sendMemoModal = document.getElementById('send-memo-modal');
            if (sendMemoModal) sendMemoModal.style.display = 'flex';
            break;
            
        case 'edit':
            editRequest(requestId);
            break;
            
        case 'delete':
            deleteRequest(requestId);
            break;
    }
}

async function editRequest(requestId) {
    try {
        const [attendeesResult, requestsResult] = await Promise.all([
            apiCallWithRetry('GET', 'getAttendeesForRequest', { requestId }),
            apiCallWithRetry('GET', 'getUserRequests', { username: getCurrentUser()?.username })
        ]);
        
        const request = requestsResult.data?.find(req => req.id === requestId);
        
        if (request) {
            // Populate form with request data
            document.getElementById('form-request-id').value = request.id;
            
            const docDateInput = document.getElementById('form-doc-date');
            if (docDateInput && request.docDate) {
                docDateInput.value = new Date(request.docDate).toISOString().split('T')[0];
            }
            
            document.getElementById('form-requester-name').value = request.requesterName || '';
            document.getElementById('form-requester-position').value = request.requesterPosition || '';
            document.getElementById('form-location').value = request.location || '';
            document.getElementById('form-purpose').value = request.purpose || '';
            
            const startDateInput = document.getElementById('form-start-date');
            const endDateInput = document.getElementById('form-end-date');
            
            if (startDateInput && request.startDate) {
                startDateInput.value = new Date(request.startDate).toISOString().split('T')[0];
            }
            if (endDateInput && request.endDate) {
                endDateInput.value = new Date(request.endDate).toISOString().split('T')[0];
            }
            
            // Populate attendees
            const attendeesList = document.getElementById('form-attendees-list');
            if (attendeesList) attendeesList.innerHTML = '';
            
            if (attendeesResult.data && Array.isArray(attendeesResult.data)) {
                attendeesResult.data.forEach(attendee => {
                    addAttendeeField(attendee.name, attendee.position);
                });
            }
            
            // Switch to form page
            switchPage('form-page');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลสำหรับแก้ไข: ' + error.message);
    }
}

async function deleteRequest(requestId) {
    const confirmed = await showConfirm('ยืนยันการลบ', 'คุณแน่ใจว่าต้องการลบคำขอนี้ใช่หรือไม่?');
    if (confirmed) {
        try {
            const result = await apiCallWithRetry('POST', 'deleteRequest', { id: requestId });
            showAlert('สำเร็จ', result.message);
            cacheManager.clear('requests');
            await fetchUserRequests();
        } catch (error) {
            showAlert('เกิดข้อผิดพลาด', error.message);
        }
    }
}

// --- PROFILE FUNCTIONS ---

function loadProfileData() {
    const user = getCurrentUser();
    if (!user) return;
    
    document.getElementById('profile-username').value = user.username || '';
    document.getElementById('profile-fullname').value = user.fullName || '';
    document.getElementById('profile-position').value = user.position || '';
    document.getElementById('profile-department').value = user.department || '';
}

async function handleProfileUpdate(e) {
    if (e) e.preventDefault();
    
    toggleLoader('save-profile-button', true);
    
    const user = getCurrentUser();
    if (!user) {
        showAlert('ข้อผิดพลาด', 'ไม่พบข้อมูลผู้ใช้');
        toggleLoader('save-profile-button', false);
        return;
    }

    const payload = {
        username: user.username,
        fullName: document.getElementById('profile-fullname')?.value || '',
        position: document.getElementById('profile-position')?.value || '',
        department: document.getElementById('profile-department')?.value || ''
    };
    
    try {
        const result = await apiCallWithRetry('POST', 'updateUserProfile', payload);
        showAlert('สำเร็จ', result.message);
        
        // Update session storage
        const updatedUser = { ...user, ...payload };
        sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
        updateUIForUser(updatedUser);
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('save-profile-button', false);
    }
}

async function handlePasswordUpdate(e) {
    if (e) e.preventDefault();
    
    toggleLoader('save-password-button', true);
    
    const user = getCurrentUser();
    if (!user) {
        showAlert('ข้อผิดพลาด', 'ไม่พบข้อมูลผู้ใช้');
        toggleLoader('save-password-button', false);
        return;
    }

    const payload = {
        username: user.username,
        oldPassword: document.getElementById('profile-current-password')?.value || '',
        newPassword: document.getElementById('profile-new-password')?.value || ''
    };
    
    const confirmPassword = document.getElementById('profile-confirm-password')?.value || '';
    
    if (payload.newPassword !== confirmPassword) {
        showAlert('ข้อผิดพลาด', 'รหัสผ่านใหม่และยืนยันรหัสผ่านไม่ตรงกัน');
        toggleLoader('save-password-button', false);
        return;
    }
    
    if (payload.newPassword.length < 6) {
        showAlert('ข้อผิดพลาด', 'รหัสผ่านใหม่ต้องมีความยาวอย่างน้อย 6 ตัวอักษร');
        toggleLoader('save-password-button', false);
        return;
    }
    
    try {
        const result = await apiCallWithRetry('POST', 'updatePassword', payload);
        showAlert('สำเร็จ', result.message);
        
        const passwordForm = document.getElementById('password-form');
        if (passwordForm) passwordForm.reset();
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('save-password-button', false);
    }
}

function togglePasswordVisibility() {
    const showPassword = document.getElementById('show-password-toggle')?.checked || false;
    const currentPassword = document.getElementById('profile-current-password');
    const newPassword = document.getElementById('profile-new-password');
    const confirmPassword = document.getElementById('profile-confirm-password');
    
    if (currentPassword) currentPassword.type = showPassword ? 'text' : 'password';
    if (newPassword) newPassword.type = showPassword ? 'text' : 'password';
    if (confirmPassword) confirmPassword.type = showPassword ? 'text' : 'password';
}

// --- STATS FUNCTIONS ---

// --- STATS FUNCTIONS (แก้ไขใหม่) ---

async function loadStatsData() {
    const statsContent = document.getElementById('stats-content');
    const statsLoader = document.getElementById('stats-loader');
    
    if (!statsContent || !statsLoader) {
        console.error('Stats elements not found');
        return;
    }
    
    showLoadingState('stats-content');
    
    try {
        const [requestsResult, usersResult] = await Promise.all([
            apiCallWithRetry('GET', 'getAllRequests'),
            apiCallWithRetry('GET', 'getAllUsers')
        ]);
        
        const requests = requestsResult.data || [];
        const users = usersResult.data || [];
        
        renderStats(requests, users);
    } catch (error) {
        console.error("Error loading stats data:", error);
        showErrorState('stats-content', 'เกิดข้อผิดพลาดในการโหลดข้อมูลสถิติ: ' + error.message);
    }
}

function renderStats(requests, users) {
    const statsContent = document.getElementById('stats-content');
    const statsLoader = document.getElementById('stats-loader');
    
    if (!statsContent || !statsLoader) {
        console.error('Stats elements not found');
        return;
    }
    
    // ซ่อน loader และแสดง content
    if (statsLoader && statsLoader.classList) statsLoader.classList.add('hidden');
    if (statsContent && statsContent.classList) statsContent.classList.remove('hidden');
    
    // ตรวจสอบว่า element ต่างๆ มีอยู่จริงก่อนจะกำหนด innerHTML
    const statsByUser = document.getElementById('stats-by-user');
    const statsByDepartment = document.getElementById('stats-by-department');
    const statsByYear = document.getElementById('stats-by-year');
    const statsByExpense = document.getElementById('stats-by-expense');
    
    if (!statsByUser || !statsByDepartment || !statsByYear || !statsByExpense) {
        console.error('One or more stat cards not found');
        showErrorState('stats-content', 'ไม่พบองค์ประกอบสำหรับแสดงสถิติ');
        return;
    }
    
    try {
        // สถิติตามผู้ใช้
        const userStats = calculateUserStats(requests, users);
        statsByUser.innerHTML = `
            <h3 class="text-lg font-bold mb-4">สถิติตามผู้ใช้</h3>
            <div class="space-y-2">
                ${userStats.length > 0 ? userStats.map(stat => `
                    <div class="stat-item" data-type="user" data-value="${stat.user}">
                        <span>${sanitizeHTML(stat.user)}</span>
                        <span class="font-bold">${stat.count} รายการ</span>
                    </div>
                `).join('') : '<p class="text-gray-500 text-center">ไม่มีข้อมูล</p>'}
            </div>
        `;
        
        // สถิติตามกลุ่มสาระ
        const departmentStats = calculateDepartmentStats(requests, users);
        statsByDepartment.innerHTML = `
            <h3 class="text-lg font-bold mb-4">สถิติตามกลุ่มสาระ</h3>
            <div class="space-y-2">
                ${departmentStats.length > 0 ? departmentStats.map(stat => `
                    <div class="stat-item" data-type="department" data-value="${stat.department}">
                        <span>${sanitizeHTML(stat.department)}</span>
                        <span class="font-bold">${stat.count} รายการ</span>
                    </div>
                `).join('') : '<p class="text-gray-500 text-center">ไม่มีข้อมูล</p>'}
            </div>
        `;
        
        // สถิติตามปี
        const yearStats = calculateYearStats(requests);
        statsByYear.innerHTML = `
            <h3 class="text-lg font-bold mb-4">สถิติตามปี</h3>
            <div class="space-y-2">
                ${yearStats.length > 0 ? yearStats.map(stat => `
                    <div class="stat-item" data-type="year" data-value="${stat.year}">
                        <span>ปี ${stat.year}</span>
                        <span class="font-bold">${stat.count} รายการ</span>
                    </div>
                `).join('') : '<p class="text-gray-500 text-center">ไม่มีข้อมูล</p>'}
            </div>
        `;
        
        // สถิติตามประเภทค่าใช้จ่าย
        const expenseStats = calculateExpenseStats(requests);
        statsByExpense.innerHTML = `
            <h3 class="text-lg font-bold mb-4">สถิติตามประเภทค่าใช้จ่าย</h3>
            <div class="space-y-2">
                ${expenseStats.length > 0 ? expenseStats.map(stat => `
                    <div class="stat-item" data-type="expense" data-value="${stat.type}">
                        <span>${sanitizeHTML(stat.type)}</span>
                        <span class="font-bold">${stat.count} รายการ</span>
                    </div>
                `).join('') : '<p class="text-gray-500 text-center">ไม่มีข้อมูล</p>'}
            </div>
        `;
        
        // Add click event listeners for stat items
        setupStatsEventListeners();
        
    } catch (error) {
        console.error('Error rendering stats:', error);
        showErrorState('stats-content', 'เกิดข้อผิดพลาดในการแสดงสถิติ');
    }
}

function setupStatsEventListeners() {
    const statItems = document.querySelectorAll('.stat-item');
    statItems.forEach(item => {
        item.addEventListener('click', () => {
            const type = item.dataset.type;
            const value = item.dataset.value;
            const requests = allRequestsCache; // ใช้ข้อมูลจาก cache
            showStatsDetail(type, value, requests);
        });
    });
}

function calculateUserStats(requests, users) {
    try {
        const userMap = new Map();
        
        requests.forEach(request => {
            const username = request.username || request.createdBy;
            if (username) {
                userMap.set(username, (userMap.get(username) || 0) + 1);
            }
        });
        
        return Array.from(userMap.entries())
            .map(([username, count]) => {
                const user = users.find(u => u.username === username);
                return {
                    user: user ? user.fullName : username,
                    count: count
                };
            })
            .sort((a, b) => b.count - a.count)
            .slice(0, 10); // แสดงเฉพาะ 10 อันดับแรก
    } catch (error) {
        console.error('Error calculating user stats:', error);
        return [];
    }
}

function calculateDepartmentStats(requests, users) {
    try {
        const deptMap = new Map();
        
        requests.forEach(request => {
            const username = request.username || request.createdBy;
            const user = users.find(u => u.username === username);
            const department = user ? user.department : 'ไม่ทราบ';
            
            deptMap.set(department, (deptMap.get(department) || 0) + 1);
        });
        
        return Array.from(deptMap.entries())
            .map(([department, count]) => ({ 
                department: department || 'ไม่ระบุ', 
                count 
            }))
            .sort((a, b) => b.count - a.count);
    } catch (error) {
        console.error('Error calculating department stats:', error);
        return [];
    }
}

function calculateYearStats(requests) {
    try {
        const yearMap = new Map();
        
        requests.forEach(request => {
            try {
                const date = new Date(request.timestamp || request.createdAt || request.docDate || Date.now());
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear() + 543; // Buddhist year
                    yearMap.set(year, (yearMap.get(year) || 0) + 1);
                }
            } catch (dateError) {
                console.warn('Invalid date for request:', request.id);
            }
        });
        
        return Array.from(yearMap.entries())
            .map(([year, count]) => ({ year, count }))
            .sort((a, b) => b.year - a.year);
    } catch (error) {
        console.error('Error calculating year stats:', error);
        return [];
    }
}

function calculateExpenseStats(requests) {
    try {
        const expenseMap = new Map();
        expenseMap.set('ไม่เบิกค่าใช้จ่าย', 0);
        expenseMap.set('ขอเบิกค่าใช้จ่าย', 0);
        
        requests.forEach(request => {
            if (request.expenseOption === 'no') {
                expenseMap.set('ไม่เบิกค่าใช้จ่าย', expenseMap.get('ไม่เบิกค่าใช้จ่าย') + 1);
            } else if (request.expenseOption === 'partial') {
                expenseMap.set('ขอเบิกค่าใช้จ่าย', expenseMap.get('ขอเบิกค่าใช้จ่าย') + 1);
            } else {
                // ถ้าไม่มีข้อมูล ให้นับเป็นไม่เบิก
                expenseMap.set('ไม่เบิกค่าใช้จ่าย', expenseMap.get('ไม่เบิกค่าใช้จ่าย') + 1);
            }
        });
        
        return Array.from(expenseMap.entries())
            .map(([type, count]) => ({ type, count }));
    } catch (error) {
        console.error('Error calculating expense stats:', error);
        return [];
    }
}

function showStatsDetail(type, value, requests) {
    try {
        const statsDetailTitle = document.getElementById('stats-detail-title');
        const statsDetailContent = document.getElementById('stats-detail-content');
        const statsDetailModal = document.getElementById('stats-detail-modal');
        
        if (!statsDetailTitle || !statsDetailContent || !statsDetailModal) {
            showAlert('ข้อผิดพลาด', 'ไม่พบองค์ประกอบสำหรับแสดงรายละเอียดสถิติ');
            return;
        }
        
        const titleMap = {
            'user': `รายละเอียดคำขอของ ${value}`,
            'department': `รายละเอียดคำขอของกลุ่มสาระ ${value}`,
            'year': `รายละเอียดคำขอปี ${value}`,
            'expense': `รายละเอียดคำขอประเภท ${value}`
        };
        
        const filteredRequests = filterRequestsByType(requests, type, value);
        
        statsDetailTitle.textContent = titleMap[type] || 'รายละเอียด';
        
        let content = '';
        if (filteredRequests.length === 0) {
            content = '<p class="text-gray-500 text-center p-4">ไม่พบข้อมูล</p>';
        } else {
            content = `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${filteredRequests.slice(0, 50).map(request => `
                        <div class="p-3 border rounded-lg bg-white shadow-sm">
                            <h4 class="font-bold text-blue-800">${sanitizeHTML(request.purpose || 'ไม่มีชื่อ')}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-sm">
                                <div><strong>สถานที่:</strong> ${sanitizeHTML(request.location || '-')}</div>
                                <div><strong>ผู้ขอ:</strong> ${sanitizeHTML(request.requesterName || '-')}</div>
                                <div><strong>วันที่:</strong> ${formatDate(new Date(request.timestamp || request.createdAt || request.docDate))}</div>
                                <div><strong>สถานะ:</strong> ${request.status || 'กำลังดำเนินการ'}</div>
                            </div>
                            ${request.id ? `<div class="mt-1 text-xs text-gray-500"><strong>ID:</strong> ${request.id}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
                ${filteredRequests.length > 50 ? 
                    `<p class="text-center text-gray-500 mt-4">แสดง ${Math.min(filteredRequests.length, 50)} จาก ${filteredRequests.length} รายการ</p>` : 
                    ''
                }
            `;
        }
        
        statsDetailContent.innerHTML = content;
        statsDetailModal.style.display = 'flex';
        
    } catch (error) {
        console.error('Error showing stats detail:', error);
        showAlert('ข้อผิดพลาด', 'ไม่สามารถแสดงรายละเอียดสถิติได้');
    }
}

function filterRequestsByType(requests, type, value) {
    try {
        if (!requests || !Array.isArray(requests)) {
            return [];
        }
        
        switch (type) {
            case 'user':
                return requests.filter(req => {
                    const username = req.username || req.createdBy;
                    return username === value;
                });
            case 'department':
                return requests.filter(req => {
                    // ในกรณีนี้เราต้องการแสดงข้อมูลพื้นฐาน
                    return true; // แสดงทั้งหมดชั่วคราว
                }).slice(0, 20); // จำกัดจำนวน
            case 'year':
                return requests.filter(req => {
                    try {
                        const date = new Date(req.timestamp || req.createdAt || req.docDate || Date.now());
                        if (isNaN(date.getTime())) return false;
                        const year = date.getFullYear() + 543;
                        return year.toString() === value;
                    } catch (error) {
                        return false;
                    }
                });
            case 'expense':
                if (value === 'ไม่เบิกค่าใช้จ่าย') {
                    return requests.filter(req => req.expenseOption === 'no');
                } else {
                    return requests.filter(req => req.expenseOption === 'partial');
                }
            default:
                return [];
        }
    } catch (error) {
        console.error('Error filtering requests:', error);
        return [];
    }
}

// แก้ไขฟังก์ชัน formatDate ให้จัดการ error ได้
function formatDate(date) {
    try {
        if (!date || isNaN(date.getTime())) return '-';
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear() + 543; // Convert to Buddhist year
        
        return `${day}/${month}/${year}`;
    } catch (error) {
        return '-';
    }
}

// --- COMMAND APPROVAL ---

async function handleCommandApproval(e) {
    if (e) e.preventDefault();
    
    const requestId = document.getElementById('approval-request-id')?.value;
    const templateType = document.querySelector('input[name="templateType"]:checked')?.value;
    
    if (!templateType) {
        showAlert('ข้อมูลไม่ครบ', 'กรุณาเลือกรูปแบบคำสั่ง');
        return;
    }

    if (!requestId) {
        showAlert('ข้อมูลไม่ครบ', 'ไม่พบรหัสคำขอ');
        return;
    }

    toggleLoader('command-approval-submit-button', true);

    try {
        const result = await apiCallWithRetry('POST', 'approveCommand', {
            requestId: requestId,
            templateType: templateType
        });

        if (result.status === 'success') {
            document.getElementById('command-approval-modal').style.display = 'none';
            showAlert('สำเร็จ', result.message);
            cacheManager.clear('requests');
            await fetchAllRequestsForCommand();
        } else {
            showAlert('เกิดข้อผิดพลาด', result.message);
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', error.message);
    } finally {
        toggleLoader('command-approval-submit-button', false);
    }
}

// --- ADDITIONAL EVENT LISTENERS ---

function setupAdditionalEventListeners() {
    // Profile form
    const profileForm = document.getElementById('profile-form');
    if (profileForm) {
        profileForm.addEventListener('submit', handleProfileUpdate);
    }
    
    // Password form
    const passwordForm = document.getElementById('password-form');
    if (passwordForm) {
        passwordForm.addEventListener('submit', handlePasswordUpdate);
    }
    
    // Password visibility toggle
    const showPasswordToggle = document.getElementById('show-password-toggle');
    if (showPasswordToggle) {
        showPasswordToggle.addEventListener('change', togglePasswordVisibility);
    }
    
    // Admin memo action form
    const adminMemoActionForm = document.getElementById('admin-memo-action-form');
    if (adminMemoActionForm) {
        adminMemoActionForm.addEventListener('submit', handleAdminMemoActionSubmit);
    }
    
    // Send memo form
    const sendMemoForm = document.getElementById('send-memo-form');
    if (sendMemoForm) {
        sendMemoForm.addEventListener('submit', handleMemoSubmitFromModal);
    }
    
    // Memo type radio buttons
    document.querySelectorAll('input[name="modal_memo_type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const fileContainer = document.getElementById('modal-memo-file-container');
            const fileInput = document.getElementById('modal-memo-file');
            const isReimburse = e.target.value === 'reimburse';
            if (fileContainer && fileContainer.classList) {
                fileContainer.classList.toggle('hidden', isReimburse);
            }
            if (fileInput) {
                fileInput.required = !isReimburse;
            }
        });
    });

    // Preview buttons for command templates
    const previewSolo = document.getElementById('preview-solo');
    const previewSmall = document.getElementById('preview-small');
    const previewLarge = document.getElementById('preview-large');

    if (previewSolo) {
        previewSolo.addEventListener('click', () => {
            window.open(`https://drive.google.com/file/d/${COMMAND_TEMPLATE_SOLO_ID}/view`, '_blank');
        });
    }
    if (previewSmall) {
        previewSmall.addEventListener('click', () => {
            window.open(`https://drive.google.com/file/d/${COMMAND_TEMPLATE_GROUP_SMALL_ID}/view`, '_blank');
        });
    }
    if (previewLarge) {
        previewLarge.addEventListener('click', () => {
            window.open(`https://drive.google.com/file/d/${COMMAND_TEMPLATE_GROUP_LARGE_ID}/view`, '_blank');
        });
    }

    // Command approval form
    const commandApprovalForm = document.getElementById('command-approval-form');
    if (commandApprovalForm) {
        commandApprovalForm.addEventListener('submit', handleCommandApproval);
    }
}

// --- REQUEST FORM SUBMISSION ---

async function handleRequestFormSubmit(e) {
    if (e) e.preventDefault();
    
    toggleLoader('submit-request-button', true);

    try {
        const user = getCurrentUser();
        if (!user || !user.username || user.username.trim() === '') {
            showAlert("ข้อมูลไม่ครบ", "ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่");
            toggleLoader('submit-request-button', false);
            return;
        }

        // Collect form data
        const payload = {
            username: user.username,
            id: document.getElementById('form-request-id')?.value || '',
            docDate: document.getElementById('form-doc-date')?.value || '',
            requesterName: document.getElementById('form-requester-name')?.value || '',
            requesterPosition: document.getElementById('form-requester-position')?.value || '',
            location: document.getElementById('form-location')?.value || '',
            purpose: document.getElementById('form-purpose')?.value || '',
            startDate: document.getElementById('form-start-date')?.value || '',
            endDate: document.getElementById('form-end-date')?.value || '',
            attendees: getAttendeesFromForm(),
            expenseOption: document.querySelector('input[name="expense_option"]:checked')?.value || 'no',
            expenseItems: getExpenseItemsFromForm(),
            totalExpense: document.getElementById('form-total-expense')?.value || 0,
            vehicleOption: document.querySelector('input[name="vehicle_option"]:checked')?.value || 'gov',
            licensePlate: document.getElementById('form-license-plate')?.value || '',
            department: document.getElementById('form-department')?.value || '',
            headName: document.getElementById('form-head-name')?.value || ''
        };

        // Submit request
        const result = await apiCallWithRetry('POST', 'createRequest', payload);
        
        if (result.status === 'success') {
            document.getElementById('form-result-title').textContent = 'บันทึกข้อมูลสำเร็จ';
            document.getElementById('form-result-message').textContent = `คำขอของคุณถูกบันทึกเรียบร้อยแล้ว (ID: ${result.data.id})`;
            document.getElementById('form-result-link').href = result.data.pdfUrl;
            document.getElementById('form-result').classList.remove('hidden');
            
            // Clear cache and refresh requests list
            cacheManager.clear('requests');
            await fetchUserRequests();
            
            // Reset form
            await resetRequestForm();
        } else {
            showAlert('เกิดข้อผิดพลาด', result.message);
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message);
    } finally {
        toggleLoader('submit-request-button', false);
    }
}

// --- PLACEHOLDER FUNCTIONS FOR ADMIN USERS ---

async function fetchAllUsers() {
    showLoadingState('admin-users-list');
    try {
        const result = await apiCallWithRetry('GET', 'getAllUsers');
        allUsersCache = result.data || [];
        renderUsersList(allUsersCache);
    } catch (error) {
        console.error("Error fetching all users:", error);
        showErrorState('admin-users-list', 'เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้: ' + error.message);
    }
}

function renderUsersList(users) {
    const container = document.getElementById('admin-users-list');
    const loader = document.getElementById('admin-loader');
    
    if (!container) return;
    
    if (loader && loader.classList) loader.classList.add('hidden');
    
    if (!users || users.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 p-8">ไม่พบข้อมูลผู้ใช้</p>';
    } else {
        container.innerHTML = `
            <table class="min-w-full bg-white">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="py-2 px-4 border text-left">ชื่อผู้ใช้</th>
                        <th class="py-2 px-4 border text-left">ชื่อ-นามสกุล</th>
                        <th class="py-2 px-4 border text-left">ตำแหน่ง</th>
                        <th class="py-2 px-4 border text-left">กลุ่มสาระ</th>
                        <th class="py-2 px-4 border text-left">สิทธิ์</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(user => `
                        <tr>
                            <td class="py-2 px-4 border">${sanitizeHTML(user.username)}</td>
                            <td class="py-2 px-4 border">${sanitizeHTML(user.fullName)}</td>
                            <td class="py-2 px-4 border">${sanitizeHTML(user.position)}</td>
                            <td class="py-2 px-4 border">${sanitizeHTML(user.department)}</td>
                            <td class="py-2 px-4 border">${sanitizeHTML(user.role)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    container.classList.remove('hidden');
}

// Placeholder functions for other admin features
function openAddUserModal() {
    showAlert('ข้อมูล', 'ฟังก์ชันเพิ่มผู้ใช้จะถูกพัฒนาต่อไป');
}

function handleAdminUserSave(e) {
    if (e) e.preventDefault();
    showAlert('ข้อมูล', 'ฟังก์ชันบันทึกผู้ใช้จะถูกพัฒนาต่อไป');
}

function downloadUserTemplate() {
    showAlert('ข้อมูล', 'ฟังก์ชันดาวน์โหลดแม่แบบจะถูกพัฒนาต่อไป');
}

function handleUserImport(e) {
    showAlert('ข้อมูล', 'ฟังก์ชันนำเข้าผู้ใช้จะถูกพัฒนาต่อไป');
}

function downloadAttendeeTemplate() {
    showAlert('ข้อมูล', 'ฟังก์ชันดาวน์โหลดแม่แบบผู้ร่วมเดินทางจะถูกพัฒนาต่อไป');
}

function handleExcelImport(e) {
    showAlert('ข้อมูล', 'ฟังก์ชันนำเข้าจาก Excel จะถูกพัฒนาต่อไป');
}

function handleDispatchFormSubmit(e) {
    if (e) e.preventDefault();
    showAlert('ข้อมูล', 'ฟังก์ชันสร้างหนังสือส่งจะถูกพัฒนาต่อไป');
}

    </script>
</body>
</html>
