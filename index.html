<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f1f5f9; 
        }
        .main-container { 
            background-color: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
        }
        .form-input { 
            width: 100%; 
            padding: 0.5rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            transition: all 0.15s ease-in-out; 
        }
        .form-input:focus { 
            outline: none; 
            border-color: #4f46e5; 
            box-shadow: 0 0 0 2px #c7d2fe; 
        }
        .form-label { 
            font-weight: bold; 
            color: #374151; 
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-radius: 50%; 
            border-top: 4px solid #3b82f6; 
            width: 24px; 
            height: 24px; 
            animation: spin 2s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        fieldset { 
            border-color: #e5e7eb; 
        }
        legend { 
            background-color: #f3f4f6; 
            padding: 0.25rem 1rem; 
            border-radius: 9999px; 
            font-weight: 700; 
            color: #4f46e5; 
            font-size: 1.125rem; 
        }
        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
            font-weight: bold; 
            padding: 0.6rem 1.25rem; 
            border-radius: 0.5rem; 
            transition: all 0.2s ease-in-out; 
            cursor: pointer; 
            border: none; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
        }
        .btn:disabled { 
            background-color: #9ca3af; 
            cursor: not-allowed; 
        }
        .btn-primary { 
            background-color: #4f46e5; 
            color: white; 
        }
        .btn-danger { 
            background-color: #ef4444; 
            color: white; 
        }
        .btn-success { 
            background-color: #10b981; 
            color: white; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 50; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content { 
            background-color: #fefefe; 
            margin: auto; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 90%; 
            max-width: 800px; 
            border-radius: 0.75rem; 
        }
        .nav-button.active { 
            background-color: #e0e7ff; 
            border: 2px solid #4f46e5; 
        }
        .stat-card { 
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
        }
        .stat-card h3 { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: #111827; 
        }
        .stat-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 0.75rem 0; 
            border-bottom: 1px solid #f3f4f6; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .stat-item:hover { 
            background-color: #eff6ff; 
        }
        .stat-item:last-child { 
            border-bottom: none; 
        }
        .tab-button { 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            transition: all 0.2s; 
        }
        .tab-button.active { 
            background-color: #4f46e5; 
            color: white; 
        }
        .tab-button:not(.active) { 
            background-color: #e0e7ff; 
            color: #4f46e5; 
        }
        .chart-container { 
            position: relative; 
            margin: auto; 
        }
        .chart-tooltip { 
            background: rgba(255, 255, 255, 0.95); 
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem; 
            padding: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            pointer-events: none; 
        }
        .chart-legend { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.5rem; 
            margin-top: 1rem; 
            justify-content: center; 
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 0.25rem; 
            font-size: 0.75rem; 
            cursor: pointer; 
        }
        .legend-color { 
            width: 12px; 
            height: 12px; 
            border-radius: 2px; 
        }
        
        /* เพิ่ม CSS สำหรับแก้ไขปัญหาแสดงผล */
        #login-screen {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        #main-app {
            display: none;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <!-- Login Screen -->
        <div id="app" class="max-w-6xl mx-auto">
        <div id="login-screen" class="max-w-md mx-auto mt-10 p-8 rounded-2xl shadow-2xl main-container">
            <div class="text-center mb-8">
                <img src="https://www.wny.ac.th/wny/storage/2025/03/Branner-WNY-Thai.png" alt="Logo" class="mx-auto h-28 mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WNY App ไปราชการ</h1>
                <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
                </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="form-label">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">รหัสผ่าน (Password)</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" id="login-button" class="btn btn-primary w-full">
                    <div class="loader hidden"></div>
                    <span>เข้าสู่ระบบ</span>
                </button>
            </form>
            <button id="show-register-modal-button" class="btn bg-gray-500 text-white w-full mt-4">
                สมัครสมาชิก
            </button>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <header class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-indigo-700">พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี</h1>
                        <p class="text-gray-600">โรงเรียนวังน้ำเย็นวิทยาคม จังหวัดสระแก้ว</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold" id="user-fullname">-</p>
                        <p class="text-sm text-gray-600" id="user-position">-</p>
                        <button id="logout-button" class="btn btn-danger mt-2">ออกจากระบบ</button>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav id="navigation" class="bg-white rounded-2xl shadow-lg p-4 mb-6">
                <div class="flex flex-wrap gap-2">
                    <button class="nav-button active btn btn-primary" data-target="dashboard-page">แดชบอร์ด</button>
                    <button class="nav-button btn btn-primary" data-target="form-page">สร้างคำขอใหม่</button>
                    <button class="nav-button btn btn-primary" data-target="profile-page">โปรไฟล์</button>
                    <button class="nav-button btn btn-primary hidden" id="admin-nav-command" data-target="command-generation-page">จัดการคำสั่ง</button>
                    <button class="nav-button btn btn-primary hidden" id="admin-nav-users" data-target="admin-users-page">จัดการผู้ใช้</button>
                    <button class="nav-button btn btn-primary" data-target="stats-page">สถิติ</button>
                </div>
            </nav>

            <main id="page-content" class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page-view">
                    <h2 class="text-2xl font-bold mb-6">คำขอไปราชการของฉัน</h2>
                    <div class="mb-6">
                        <input type="text" id="search-requests" placeholder="ค้นหาคำขอ..." class="form-input max-w-md">
                    </div>
                    <div id="requests-loader" class="text-center p-8 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังโหลดข้อมูล...</p>
                    </div>
                    <div id="no-requests-message" class="text-center p-8 text-gray-500 hidden">
                        <p>ยังไม่มีคำขอไปราชการ</p>
                        <button class="btn btn-primary mt-4" data-target="form-page" onclick="switchPage('form-page')">สร้างคำขอใหม่</button>
                    </div>
                    <div id="requests-list" class="space-y-4"></div>
                </div>

                <!-- Form Page -->
                <div id="form-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">แบบฟอร์มขอไปราชการ</h2>
                    <form id="request-form" class="space-y-6">
                        <input type="hidden" id="form-request-id">
                        
                        <fieldset class="p-4 border rounded-lg">
                            <legend>ข้อมูลเอกสาร</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">วันที่เขียนหนังสือ</label>
                                    <input type="date" id="form-doc-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">ชื่อผู้ขอ</label>
                                    <input type="text" id="form-requester-name" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">ตำแหน่ง</label>
                                    <input type="text" id="form-requester-position" class="form-input" required>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="p-4 border rounded-lg">
                            <legend>ข้อมูลการเดินทาง</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">สถานที่ไปราชการ</label>
                                    <input type="text" id="form-location" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">วัตถุประสงค์</label>
                                    <input type="text" id="form-purpose" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">วันที่เริ่มต้น</label>
                                    <input type="date" id="form-start-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">วันที่สิ้นสุด</label>
                                    <input type="date" id="form-end-date" class="form-input" required>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="p-4 border rounded-lg">
                            <legend>ผู้ร่วมเดินทาง</legend>
                            <div class="mb-4">
                                <div class="flex gap-2 mb-4">
                                    <button type="button" id="form-add-attendee" class="btn btn-primary">เพิ่มผู้ร่วมเดินทาง</button>
                                    <button type="button" id="form-import-excel" class="btn bg-green-600 text-white">
                                        <div class="loader hidden"></div>
                                        <span>นำเข้าจาก Excel</span>
                                    </button>
                                    <button type="button" id="form-download-template" class="btn bg-gray-600 text-white">ดาวน์โหลดเทมเพลต</button>
                                </div>
                                <input type="file" id="excel-file-input" class="hidden" accept=".xlsx,.xls">
                            </div>
                            <div id="form-attendees-list" class="space-y-2"></div>
                        </fieldset>

                        <fieldset class="p-4 border rounded-lg">
                            <legend>ค่าใช้จ่าย</legend>
                            <div class="space-y-4">
                                <div class="flex gap-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="expense_option" id="expense_no" value="no" class="mr-2" checked>
                                        <span>ไม่เบิกค่าใช้จ่าย</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="expense_option" id="expense_partial" value="partial" class="mr-2">
                                        <span>เบิกค่าใช้จ่าย</span>
                                    </label>
                                </div>
                                
                                <div id="partial-expense-options" class="hidden grid grid-cols-2 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="expense_item" data-item-name="ค่าเบี้ยเลี้ยง" class="mr-2">
                                        <span>ค่าเบี้ยเลี้ยง</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="expense_item" data-item-name="ค่าอาหาร" class="mr-2">
                                        <span>ค่าอาหาร</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="expense_item" data-item-name="ค่าที่พัก" class="mr-2">
                                        <span>ค่าที่พัก</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="expense_item" data-item-name="ค่าพาหนะ" class="mr-2">
                                        <span>ค่าพาหนะ</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="expense_item" data-item-name="ค่าน้ำมัน" class="mr-2">
                                        <span>ค่าน้ำมัน</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="expense_item" data-item-name="ค่าใช้จ่ายอื่นๆ" class="mr-2">
                                        <span>ค่าใช้จ่ายอื่นๆ</span>
                                    </label>
                                </div>
                                
                                <div id="expense-other-details" class="hidden">
                                    <label class="form-label">ระบุค่าใช้จ่ายอื่นๆ</label>
                                    <input type="text" id="expense_other_text" class="form-input" placeholder="ระบุรายละเอียด">
                                </div>
                                
                                <div id="total-expense-container" class="hidden">
                                    <label class="form-label">จำนวนเงินรวม (บาท)</label>
                                    <input type="number" id="form-total-expense" class="form-input" min="0" step="0.01">
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="p-4 border rounded-lg">
                            <legend>ยานพาหนะ</legend>
                            <div class="space-y-4">
                                <div class="flex gap-4 flex-wrap">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="vehicle_option" id="vehicle_gov" value="gov" class="mr-2" checked>
                                        <span>ราชการ</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="vehicle_option" id="vehicle_private" value="private" class="mr-2">
                                        <span>ส่วนตัว</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="vehicle_option" id="vehicle_public" value="public" class="mr-2">
                                        <span>สาธารณะ</span>
                                    </label>
                                </div>
                                
                                <div id="private-vehicle-details" class="hidden">
                                    <label class="form-label">ทะเบียนรถ</label>
                                    <input type="text" id="form-license-plate" class="form-input" placeholder="กข 1234">
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="p-4 border rounded-lg">
                            <legend>ข้อมูลเพิ่มเติม</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">กลุ่มสาระการเรียนรู้</label>
                                    <select id="form-department" class="form-input" required>
                                        <option value="">กำลังโหลด...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">ชื่อหัวหน้ากลุ่มสาระฯ</label>
                                    <input type="text" id="form-head-name" class="form-input" required readonly>
                                </div>
                            </div>
                        </fieldset>

                        <div class="flex gap-4">
                            <button type="submit" id="submit-request-button" class="btn btn-primary">
                                <div class="loader hidden"></div>
                                <span id="submit-button-text">บันทึกและสร้างเอกสาร</span>
                            </button>
                            <button type="button" class="btn bg-gray-500 text-white" onclick="switchPage('dashboard-page')">ยกเลิก</button>
                        </div>

                        <div id="form-result" class="p-4 bg-green-50 border border-green-200 rounded-lg hidden">
                            <h3 id="form-result-title" class="font-bold text-green-800"></h3>
                            <p id="form-result-message" class="text-green-700"></p>
                            <a id="form-result-link" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 mt-2 inline-block">ดูเอกสาร PDF</a>
                        </div>
                    </form>
                </div>

                <!-- Profile Page -->
                <div id="profile-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">ข้อมูลส่วนตัว</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-bold mb-4">ข้อมูลพื้นฐาน</h3>
                            <form id="profile-form" class="space-y-4">
                                <div>
                                    <label class="form-label">ชื่อผู้ใช้</label>
                                    <input type="text" id="profile-username" class="form-input" readonly>
                                </div>
                                <div>
                                    <label class="form-label">ชื่อ-นามสกุล</label>
                                    <input type="text" id="profile-fullname" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">ตำแหน่ง</label>
                                    <input type="text" id="profile-position" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">กลุ่มสาระการเรียนรู้</label>
                                    <input type="text" id="profile-department" class="form-input" required>
                                </div>
                                <button type="submit" id="save-profile-button" class="btn btn-primary">
                                    <div class="loader hidden"></div>
                                    <span>บันทึกข้อมูล</span>
                                </button>
                                <p id="profile-message" class="text-green-600 hidden"></p>
                            </form>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-bold mb-4">เปลี่ยนรหัสผ่าน</h3>
                            <form id="password-form" class="space-y-4">
                                <div>
                                    <label class="form-label">รหัสผ่านปัจจุบัน</label>
                                    <input type="password" id="profile-current-password" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">รหัสผ่านใหม่</label>
                                    <input type="password" id="profile-new-password" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">ยืนยันรหัสผ่านใหม่</label>
                                    <input type="password" id="profile-confirm-password" class="form-input" required>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="show-password-toggle" class="mr-2">
                                    <label for="show-password-toggle">แสดงรหัสผ่าน</label>
                                </div>
                                <button type="submit" id="save-password-button" class="btn btn-primary">
                                    <div class="loader hidden"></div>
                                    <span>เปลี่ยนรหัสผ่าน</span>
                                </button>
                                <p id="password-error" class="text-red-600 hidden"></p>
                                <p id="password-message" class="text-green-600 hidden"></p>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Users Page -->
                <div id="admin-users-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">จัดการผู้ใช้</h2>
                    <div class="flex gap-4 mb-6">
                        <button id="add-user-button" class="btn btn-primary">เพิ่มผู้ใช้</button>
                        <button id="download-user-template-button" class="btn bg-green-600 text-white">ดาวน์โหลดเทมเพลต</button>
                        <button id="import-users-button" class="btn bg-blue-600 text-white">
                            <div class="loader hidden"></div>
                            <span>นำเข้าจาก Excel</span>
                        </button>
                        <input type="file" id="user-excel-input" class="hidden" accept=".xlsx,.xls">
                    </div>
                    
                    <div id="admin-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังโหลดข้อมูลผู้ใช้...</p>
                    </div>
                    <div id="admin-users-list"></div>
                </div>

                <!-- Command Generation Page -->
                <div id="command-generation-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">จัดการคำสั่งไปราชการ</h2>
                    
                    <div class="flex border-b-2 border-gray-200 mb-6">
                        <button id="admin-view-requests-tab" class="tab-button active">คำขอทั้งหมด</button>
                        <button id="admin-view-memos-tab" class="tab-button">บันทึกข้อความ</button>
                    </div>
                    
                    <!-- Requests View -->
                    <div id="admin-requests-view">
                        <div id="command-requests-loader" class="text-center p-8">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                        </div>
                        <div id="no-command-requests-message" class="text-center p-8 text-gray-500 hidden">
                            <p>ไม่มีคำขอไปราชการ</p>
                        </div>
                        <div id="command-requests-list"></div>
                    </div>
                    
                    <!-- Memos View -->
                    <div id="admin-memos-view" class="hidden">
                        <div id="admin-memos-loader" class="text-center p-8">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4">กำลังโหลดข้อมูลบันทึกข้อความ...</p>
                        </div>
                        <div id="no-admin-memos-message" class="text-center p-8 text-gray-500 hidden">
                            <p>ไม่มีบันทึกข้อความ</p>
                        </div>
                        <div id="admin-memos-list"></div>
                    </div>
                </div>
                
                <!-- Stats Page -->
                <div id="stats-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">สรุปสถิติข้อมูลทั้งหมด</h2>
                    
                    <!-- เพิ่มตัวเลือกการแสดงผล -->
                    <div class="flex space-x-2 border-b-2 border-gray-200 mb-6">
                        <button id="stats-chart-view" class="tab-button active">แสดงเป็นกราฟ</button>
                        <button id="stats-list-view" class="tab-button">แสดงเป็นรายการ</button>
                    </div>
                    
                    <div id="stats-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังประมวลผลข้อมูลสถิติ...</p>
                    </div>
                    
                    <!-- ส่วนแสดงผลเป็นกราฟ -->
                    <div id="stats-chart-content" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="stat-card">
                                <h3 class="text-lg font-bold mb-4">สรุปตามผู้ขอไปราชการ</h3>
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="user-chart"></canvas>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3 class="text-lg font-bold mb-4">สรุปตามกลุ่มสาระฯ</h3>
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="department-chart"></canvas>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3 class="text-lg font-bold mb-4">สรุปตามปี</h3>
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="year-chart"></canvas>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3 class="text-lg font-bold mb-4">สรุปการเบิกค่าใช้จ่าย</h3>
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="expense-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ตารางสรุปข้อมูล -->
                        <div class="stat-card">
                            <h3 class="text-lg font-bold mb-4">สรุปข้อมูลทั้งหมด</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="p-4 bg-blue-50 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600" id="total-requests">0</div>
                                    <div class="text-sm text-gray-600">คำขอทั้งหมด</div>
                                </div>
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600" id="total-users">0</div>
                                    <div class="text-sm text-gray-600">ผู้ใช้ทั้งหมด</div>
                                </div>
                                <div class="p-4 bg-purple-50 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600" id="total-departments">0</div>
                                    <div class="text-sm text-gray-600">กลุ่มสาระฯ</div>
                                </div>
                                <div class="p-4 bg-orange-50 rounded-lg">
                                    <div class="text-2xl font-bold text-orange-600" id="reimburse-percentage">0%</div>
                                    <div class="text-sm text-gray-600">เบิกค่าใช้จ่าย</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ส่วนแสดงผลเป็นรายการ (เดิม) -->
                    <div id="stats-list-content" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                        <div id="stats-by-user" class="stat-card"></div>
                        <div id="stats-by-department" class="stat-card"></div>
                        <div id="stats-by-year" class="stat-card"></div>
                        <div id="stats-by-expense" class="stat-card"></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Footer -->
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            <p> จัดทำโดย กลุ่มบริหารงานบุคคล พัฒนาระบบโดย นายกีรติ ประสพพรรังสี</p>
            <p>โรงเรียนวังน้ำเย็นวิทยาคม จังหวัดสระแก้ว</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">สมัครสมาชิก</h3>
            <form id="register-form">
                <div class="space-y-4">
                    <div>
                        <label class="form-label">ชื่อผู้ใช้</label>
                        <input type="text" id="register-username" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">รหัสผ่าน</label>
                        <input type="password" id="register-password" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">ชื่อ-นามสกุล</label>
                        <input type="text" id="register-fullname" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">ตำแหน่ง</label>
                        <input type="text" id="register-position" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">กลุ่มสาระการเรียนรู้</label>
                        <input type="text" id="register-department" class="form-input" required>
                    </div>
                </div>
                <p id="register-error" class="text-red-500 text-sm mt-4 hidden"></p>
                <div class="flex gap-4 mt-6">
                    <button type="submit" id="register-save-button" class="btn btn-primary">
                        <div class="loader hidden"></div>
                        <span>สมัครสมาชิก</span>
                    </button>
                    <button type="button" id="register-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 id="admin-modal-title" class="text-xl font-bold mb-4">เพิ่มผู้ใช้ใหม่</h3>
            <form id="admin-modal-form">
                <input type="hidden" id="modal-original-username">
                <div class="space-y-4">
                    <div>
                        <label class="form-label">ชื่อผู้ใช้</label>
                        <input type="text" id="modal-username" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">รหัสผ่าน</label>
                        <input type="password" id="modal-password" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">ชื่อ-นามสกุล</label>
                        <input type="text" id="modal-fullname" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">ตำแหน่ง</label>
                        <input type="text" id="modal-position" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">กลุ่มสาระการเรียนรู้</label>
                        <input type="text" id="modal-department" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">สิทธิ์</label>
                        <select id="modal-role" class="form-input" required>
                            <option value="user">ผู้ใช้ทั่วไป</option>
                            <option value="admin">ผู้ดูแลระบบ</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" id="admin-modal-save-button" class="btn btn-primary">
                        <div class="loader hidden"></div>
                        <span>บันทึก</span>
                    </button>
                    <button type="button" id="admin-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h3 id="alert-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="alert-modal-message"></p>
            <div class="flex justify-end mt-6">
                <button id="alert-modal-close-button" class="btn btn-primary">ตกลง</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="confirm-modal-message"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="confirm-modal-yes-button" class="btn btn-primary">ใช่</button>
                <button id="confirm-modal-no-button" class="btn bg-gray-300">ไม่</button>
            </div>
        </div>
    </div>

    <div id="command-approval-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">ออกคำสั่งไปราชการ</h3>
            <form id="command-approval-form">
                <input type="hidden" id="approval-request-id">
                <div class="space-y-4">
                    <p>เลือกรูปแบบคำสั่ง:</p>
                    <div class="space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="templateType" value="solo" class="mr-2" checked>
                            <span>เดินทาง 1 คน</span>
                            <button type="button" id="preview-solo" class="btn btn-sm bg-gray-500 text-white ml-2">ดูตัวอย่าง</button>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="templateType" value="groupSmall" class="mr-2">
                            <span>เดินทาง 2-5 คน</span>
                            <button type="button" id="preview-small" class="btn btn-sm bg-gray-500 text-white ml-2">ดูตัวอย่าง</button>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="templateType" value="groupLarge" class="mr-2">
                            <span>เดินทาง 6 คนขึ้นไป</span>
                            <button type="button" id="preview-large" class="btn btn-sm bg-gray-500 text-white ml-2">ดูตัวอย่าง</button>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="btn btn-primary">อนุมัติคำสั่ง</button>
                    <button type="button" id="command-approval-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-memo-action-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">จัดการบันทึกข้อความ</h3>
            <form id="admin-memo-action-form">
                <input type="hidden" id="action-memo-id">
                <div class="space-y-4">
                    <p><strong>สถานะ:</strong> เสร็จสิ้น/รับไฟล์ไปใช้งาน</p>
                    
                    <div>
                        <label class="form-label">ไฟล์บันทึกข้อความฉบับสมบูรณ์ (PDF)</label>
                        <input type="file" id="completed-memo-file" class="form-input" accept=".pdf">
                    </div>
                    
                    <div>
                        <label class="form-label">ไฟล์คำสั่งฉบับสมบูรณ์ (PDF)</label>
                        <input type="file" id="completed-command-file" class="form-input" accept=".pdf">
                    </div>
                    
                    <div>
                        <label class="form-label">ไฟล์หนังสือส่ง (PDF)</label>
                        <input type="file" id="dispatch-book-file" class="form-input" accept=".pdf">
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" id="admin-memo-action-submit-button" class="btn btn-primary">
                        <div class="loader hidden"></div>
                        <span>บันทึกและอัปโหลดไฟล์</span>
                    </button>
                    <button type="button" id="admin-memo-action-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <div id="stats-detail-modal" class="modal">
        <div class="modal-content">
            <h3 id="stats-detail-title" class="text-xl font-bold mb-4"></h3>
            <div id="stats-detail-content" class="max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="btn bg-gray-300" id="stats-detail-modal-close-button">ปิด</button>
            </div>
        </div>
    </div>

    <div id="dispatch-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">ออกหนังสือส่ง</h3>
            <form id="dispatch-form">
                <input type="hidden" id="dispatch-request-id">
                <div class="space-y-4">
                    <div>
                        <label class="form-label">เดือน</label>
                        <input type="text" id="dispatch-month" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">ปี (พ.ศ.)</label>
                        <input type="number" id="dispatch-year" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">จำนวนคำสั่ง</label>
                        <input type="number" id="dispatch-command-count" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">จำนวนบันทึกข้อความ</label>
                        <input type="number" id="dispatch-memo-count" class="form-input" required>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="btn btn-primary">สร้างหนังสือส่ง</button>
                    <button type="button" id="dispatch-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <div id="send-memo-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">ส่งบันทึกข้อความ</h3>
            <form id="send-memo-form">
                <input type="hidden" id="memo-modal-request-id">
                <div class="space-y-4">
                    <div>
                        <p class="form-label">ประเภทบันทึกข้อความ:</p>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="modal_memo_type" value="reimburse" class="mr-2" checked>
                                <span>ขอเบิกค่าใช้จ่าย</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="modal_memo_type" value="no_reimburse" class="mr-2">
                                <span>ไม่เบิกค่าใช้จ่าย</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="modal-memo-file-container" class="hidden">
                        <label class="form-label">ไฟล์บันทึกข้อความ (PDF)</label>
                        <input type="file" id="modal-memo-file" class="form-input" accept=".pdf">
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" id="send-memo-submit-button" class="btn btn-primary">
                        <div class="loader hidden"></div>
                        <span>ส่งบันทึกข้อความ</span>
                    </button>
                    <button type="button" id="send-memo-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ใช้ URL ของ Google Apps Script ที่คุณให้มา
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxq8fkHgDOyYjpZgy4dngT8n-Z3zSBjfJ0R7lomuUxoI63vqpdOP-7nlodlV-BsXnksaA/exec";

        // Global State
        let allRequestsCache = [];
        let allMemosCache = [];
        let userMemosCache = [];
        let allUsersCache = [];
        let specialPositionMap = {};
        let charts = {};

        // สีสำหรับกราฟ
        const chartColors = [
            '#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
            '#06b6d4', '#84cc16', '#f97316', '#6366f1', '#ec4899',
            '#14b8a6', '#f43f5e', '#a855f7', '#3b82f6', '#22c55e'
        ];

        const statusTranslations = {
            'Pending': 'กำลังดำเนินการ',
            'Submitted': 'กำลังดำเนินการ',
            'Approved': 'เสร็จสิ้นรอออกคำสั่งไปราชการ',
            'Pending Approval': 'กำลังดำเนินการ',
            'เสร็จสิ้น/รับไฟล์ไปใช้งาน': 'เสร็จสิ้น',
            'รอเอกสาร (เบิก)': 'รอตรวจสอบและออกคำสั่ง',
            'นำกลับไปแก้ไข': 'นำกลับไปแก้ไข'
        };

        function translateStatus(status) {
            return statusTranslations[status] || status;
        }

        // --- API HELPER FUNCTIONS ---
        
        async function apiCall(method, action, payload = {}) {
            let url = SCRIPT_URL;
            const options = {
                method: method,
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8', },
            };

            if (method === 'GET') {
                const params = new URLSearchParams({ action, ...payload, cacheBust: new Date().getTime() }); 
                url += `?${params}`;
            } else {
                options.body = JSON.stringify({ action, payload });
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                
                // ตรวจสอบว่าเป็น network error หรือไม่
                if (error.message.includes('Failed to fetch')) {
                    showAlert('การเชื่อมต่อล้มเหลว', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
                } else {
                    showAlert('เกิดข้อผิดพลาด', `Server error: ${error.message}`);
                }
                throw error;
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        
        function showAlert(title, message) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal').style.display = 'flex';
        }
        
        function showConfirm(title, message) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            document.getElementById('confirm-modal').style.display = 'flex';

            return new Promise((resolve) => {
                const yesButton = document.getElementById('confirm-modal-yes-button');
                const noButton = document.getElementById('confirm-modal-no-button');
                const onYes = () => { cleanup(); resolve(true); };
                const onNo = () => { cleanup(); resolve(false); };
                
                const cleanup = () => {
                    document.getElementById('confirm-modal').style.display = 'none';
                    yesButton.removeEventListener('click', onYes);
                    noButton.removeEventListener('click', onNo);
                };

                yesButton.addEventListener('click', onYes, { once: true });
                noButton.addEventListener('click', onNo, { once: true });
            });
        }
        
        function toggleLoader(buttonId, show) {
            const button = document.getElementById(buttonId);
            if (!button) {
                console.error(`Button with id '${buttonId}' not found`);
                return;
            }
            
            const loader = button.querySelector('.loader');
            const text = button.querySelector('span');
            
            if (show) {
                if (loader) loader.classList.remove('hidden');
                if (text) text.classList.add('hidden');
                button.disabled = true;
            } else {
                if (loader) loader.classList.add('hidden');
                if (text) text.classList.remove('hidden');
                button.disabled = false;
            }
        }
        
        function getCurrentUser() {
            const userJson = sessionStorage.getItem('currentUser');
            return userJson ? JSON.parse(userJson) : null;
        }

        function fileToObject(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const data = reader.result.toString().split(',')[1];
                    resolve({ filename: file.name, mimeType: file.type, data: data });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // --- PAGE NAVIGATION ---
        
        async function switchPage(targetPageId) {
            document.querySelectorAll('.page-view').forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(targetPageId);
            if (targetPage) {
                 targetPage.classList.remove('hidden');
            }

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.target === targetPageId) {
                    btn.classList.add('active');
                }
            });

            if (targetPageId === 'form-page') await resetRequestForm();
            if (targetPageId === 'dashboard-page') await fetchUserRequests();
            if (targetPageId === 'profile-page') loadProfileData();
            if (targetPageId === 'stats-page') await loadStatsData();
            if (targetPageId === 'admin-users-page') await fetchAllUsers();
            if (targetPageId === 'command-generation-page') {
                document.getElementById('admin-view-requests-tab').click(); // Default to requests tab
            }
        }

        // --- MAIN APP LOGIC ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log('App Initializing with Google Sheets Backend...');
            
            // แสดง login screen ก่อนเสมอ
            showLoginScreen();
            
            // ตรวจสอบ session storage
            const user = getCurrentUser();
            if (user) {
                initializeUserSession(user);
            }
            
            setupEventListeners();
        });

        // --- INITIALIZATION ---
        
        function initializeUserSession(user) {
            updateUIForUser(user);
            showMainApp();
            switchPage('dashboard-page');
        }

        function updateUIForUser(user) {
            document.getElementById('user-fullname').textContent = user.fullName || 'N/A';
            document.getElementById('user-position').textContent = user.position || 'N/A';

            const isAdmin = user.role === 'admin';
            document.getElementById('admin-nav-command').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-nav-users').classList.toggle('hidden', !isAdmin);
        }
        
        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }
        
        function showLoginScreen() {
            sessionStorage.removeItem('currentUser');
            clearAllCache();
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // --- EVENT LISTENER SETUP ---
        
        function setupEventListeners() {
            // Auth
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', showLoginScreen);
            document.getElementById('show-register-modal-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'flex');
            document.getElementById('register-form').addEventListener('submit', handleRegister);

            // Navigation
            document.getElementById('navigation').addEventListener('click', (e) => {
                const navButton = e.target.closest('.nav-button');
                if (navButton && navButton.dataset.target) {
                    switchPage(navButton.dataset.target);
                }
            });

            // Modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            });
            document.getElementById('register-modal-close-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'none');
            document.getElementById('admin-modal-close-button').addEventListener('click', () => document.getElementById('admin-modal').style.display = 'none');
            document.getElementById('alert-modal-close-button').addEventListener('click', () => document.getElementById('alert-modal').style.display = 'none');
            document.getElementById('command-approval-modal-close-button').addEventListener('click', () => document.getElementById('command-approval-modal').style.display = 'none');
            document.getElementById('admin-memo-action-modal-close-button').addEventListener('click', () => document.getElementById('admin-memo-action-modal').style.display = 'none');
            document.getElementById('stats-detail-modal-close-button').addEventListener('click', () => document.getElementById('stats-detail-modal').style.display = 'none');
            document.getElementById('dispatch-modal-close-button').addEventListener('click', () => document.getElementById('dispatch-modal').style.display = 'none');
            document.getElementById('send-memo-modal-close-button').addEventListener('click', () => document.getElementById('send-memo-modal').style.display = 'none');

            // Forms
            document.getElementById('request-form').addEventListener('submit', handleRequestFormSubmit);
            document.getElementById('form-add-attendee').addEventListener('click', () => addAttendeeField());
            document.getElementById('form-import-excel').addEventListener('click', () => document.getElementById('excel-file-input').click());
            document.getElementById('excel-file-input').addEventListener('change', handleExcelImport);
            document.getElementById('form-download-template').addEventListener('click', downloadAttendeeTemplate);
            document.querySelectorAll('input[name="expense_option"]').forEach(radio => radio.addEventListener('change', toggleExpenseOptions));
            document.querySelectorAll('input[name="vehicle_option"]').forEach(radio => radio.addEventListener('change', toggleVehicleOptions));
            
            document.getElementById('send-memo-form').addEventListener('submit', handleMemoSubmitFromModal);
            document.querySelectorAll('input[name="modal_memo_type"]').forEach(radio => radio.addEventListener('change', (e) => {
                const fileContainer = document.getElementById('modal-memo-file-container');
                const fileInput = document.getElementById('modal-memo-file');
                const isReimburse = e.target.value === 'reimburse';
                fileContainer.classList.toggle('hidden', isReimburse);
                fileInput.required = !isReimburse;
            }));

            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
            document.getElementById('password-form').addEventListener('submit', handlePasswordUpdate);
            document.getElementById('show-password-toggle').addEventListener('change', togglePasswordVisibility);
            document.getElementById('command-approval-form').addEventListener('submit', handleCommandApproval);
            document.getElementById('admin-memo-action-form').addEventListener('submit', handleAdminMemoActionSubmit);
            document.getElementById('dispatch-form').addEventListener('submit', handleDispatchFormSubmit);
            
            document.getElementById('form-department').addEventListener('change', (e) => {
                const selectedPosition = e.target.value;
                const headNameInput = document.getElementById('form-head-name');
                headNameInput.value = specialPositionMap[selectedPosition] || '';
            });
            
            // Search
            document.getElementById('search-requests').addEventListener('input', (e) => renderRequestsList(allRequestsCache, userMemosCache, e.target.value));

            // Admin
            document.getElementById('add-user-button').addEventListener('click', openAddUserModal);
            document.getElementById('admin-modal-form').addEventListener('submit', handleAdminUserSave);
            document.getElementById('download-user-template-button').addEventListener('click', downloadUserTemplate);
            document.getElementById('import-users-button').addEventListener('click', () => document.getElementById('user-excel-input').click());
            document.getElementById('user-excel-input').addEventListener('change', handleUserImport);
            
            // Admin Page Tabs
            document.getElementById('admin-view-requests-tab').addEventListener('click', (e) => {
                document.getElementById('admin-view-memos-tab').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('admin-requests-view').classList.remove('hidden');
                document.getElementById('admin-memos-view').classList.add('hidden');
                fetchAllRequestsForCommand();
            });
            document.getElementById('admin-view-memos-tab').addEventListener('click', (e) => {
                document.getElementById('admin-view-requests-tab').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('admin-memos-view').classList.remove('hidden');
                document.getElementById('admin-requests-view').classList.add('hidden');
                fetchAllMemos();
            });
            
            // Stats View Toggle
            setupStatsViewToggle();
            
            // Global Error Handler
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                showAlert("ข้อผิดพลาดระบบ", "เกิดข้อผิดพลาดที่ไม่คาดคิด กรุณารีเฟรชหน้าเว็บ");
            });
        }

        // --- STATISTICS FUNCTIONS WITH CHARTS ---

        async function loadStatsData() {
            const loader = document.getElementById('stats-loader');
            const chartContent = document.getElementById('stats-chart-content');
            const listContent = document.getElementById('stats-list-content');
            
            loader.classList.remove('hidden');
            chartContent.classList.add('hidden');
            listContent.classList.add('hidden');

            try {
                const [requestsResult, usersResult] = await Promise.all([
                    apiCall('GET', 'getAllRequests'),
                    apiCall('GET', 'getAllUsers')
                ]);
                const requests = requestsResult.data || [];
                const users = usersResult.data || [];
                
                allRequestsCache = requests; 
                allUsersCache = users; 
                
                // อัพเดทข้อมูลสรุป
                updateSummaryStats(requests, users);
                
                // สร้างกราฟ
                createCharts(requests, users);
                
                // สร้างรายการ (เดิม)
                renderStatsLists(requests, users);
                
            } catch(error) {
                console.error("Error loading stats data", error);
                showAlert("ข้อผิดพลาด", "ไม่สามารถโหลดข้อมูลสถิติได้");
            } finally {
                loader.classList.add('hidden');
                // แสดงกราฟเป็นค่าเริ่มต้น
                document.getElementById('stats-chart-content').classList.remove('hidden');
            }
        }

        function updateSummaryStats(requests, users) {
            // คำขอทั้งหมด
            document.getElementById('total-requests').textContent = requests.length;
            
            // ผู้ใช้ทั้งหมด
            document.getElementById('total-users').textContent = users.length;
            
            // กลุ่มสาระฯ ที่ไม่ซ้ำ
            const userDepartmentMap = users.reduce((map, user) => {
                map[user.username] = user.department || 'ไม่ระบุกลุ่มสาระฯ';
                return map;
            }, {});
            const uniqueDepartments = new Set(Object.values(userDepartmentMap));
            document.getElementById('total-departments').textContent = uniqueDepartments.size;
            
            // เปอร์เซ็นต์การเบิกค่าใช้จ่าย
            const reimburseCount = requests.filter(req => req.expenseOption === 'partial').length;
            const reimbursePercentage = requests.length > 0 ? 
                Math.round((reimburseCount / requests.length) * 100) : 0;
            document.getElementById('reimburse-percentage').textContent = `${reimbursePercentage}%`;
        }

        function createCharts(requests, users) {
            // ทำลายกราฟเก่าถ้ามี
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            const userDepartmentMap = users.reduce((map, user) => {
                map[user.username] = user.department || 'ไม่ระบุกลุ่มสาระฯ';
                return map;
            }, {});

            // 1. กราฟตามผู้ขอ
            createPieChart('user-chart', 'สรุปตามผู้ขอไปราชการ', 
                aggregateData(requests, 'requesterName', 'N/A'), 
                'user'
            );

            // 2. กราฟตามกลุ่มสาระฯ
            createPieChart('department-chart', 'สรุปตามกลุ่มสาระฯ',
                aggregateData(requests, (req) => userDepartmentMap[req.username] || 'ไม่ระบุกลุ่มสาระฯ'),
                'department'
            );

            // 3. กราฟตามปี
            createPieChart('year-chart', 'สรุปตามปี',
                aggregateData(requests, (req) => {
                    const year = new Date(req.docDate).getFullYear() + 543;
                    return isNaN(year) ? 'ไม่ระบุปี' : year.toString();
                }),
                'year'
            );

            // 4. กราฟตามการเบิกค่าใช้จ่าย
            createPieChart('expense-chart', 'สรุปการเบิกค่าใช้จ่าย',
                aggregateData(requests, (req) => req.expenseOption === 'no' ? 'ไม่เบิก' : 'เบิก'),
                'expense'
            );
        }

        function aggregateData(requests, keyExtractor, defaultValue = 'ไม่ระบุ') {
            const aggregated = {};
            
            requests.forEach(req => {
                const key = typeof keyExtractor === 'function' ? 
                    keyExtractor(req) : (req[keyExtractor] || defaultValue);
                aggregated[key] = (aggregated[key] || 0) + 1;
            });
            
            return Object.entries(aggregated)
                .sort((a, b) => b[1] - a[1])
                .reduce((acc, [key, value]) => {
                    acc[key] = value;
                    return acc;
                }, {});
        }

        function createPieChart(canvasId, title, data, type) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            // สุ่มสีสำหรับแต่ละข้อมูล (ใช้สีจาก palette)
            const backgroundColors = labels.map((_, index) => 
                chartColors[index % chartColors.length]
            );
            
            // สร้าง hover effect ด้วยสีที่เข้มขึ้น
            const hoverColors = backgroundColors.map(color => 
                ColorLuminance(color, -0.2) // ทำให้สีเข้มขึ้นเมื่อ hover
            );
            
            charts[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors,
                        hoverBackgroundColor: hoverColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: {
                                    family: "'Sarabun', sans-serif",
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} ครั้ง (${percentage}%)`;
                                }
                            },
                            titleFont: {
                                family: "'Sarabun', sans-serif"
                            },
                            bodyFont: {
                                family: "'Sarabun', sans-serif"
                            }
                        },
                        title: {
                            display: true,
                            text: title,
                            font: {
                                family: "'Sarabun', sans-serif",
                                size: 16,
                                weight: 'bold'
                            },
                            padding: 10
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const label = labels[index];
                            showStatsDetail(title, label, type);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        // ฟังก์ชันปรับความสว่างของสี
        function ColorLuminance(hex, lum) {
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }
            lum = lum || 0;
            let rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i * 2, 2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00" + c).substr(c.length);
            }
            return rgb;
        }

        // แก้ไขฟังก์ชัน renderStatsLists (เดิม)
        function renderStatsLists(requests, users) {
            const userDepartmentMap = users.reduce((map, user) => {
                map[user.username] = user.department || 'ไม่ระบุกลุ่มสาระฯ';
                return map;
            }, {});

            // 1. Stats by User
            const byUser = requests.reduce((acc, req) => {
                const user = req.requesterName || 'N/A';
                acc[user] = (acc[user] || 0) + 1;
                return acc;
            }, {});
            renderStatsCard('stats-by-user', 'สรุปตามผู้ขอไปราชการ', byUser, 'user');

            // 2. Stats by Department
            const byDept = requests.reduce((acc, req) => {
                const dept = userDepartmentMap[req.username] || 'ไม่ระบุกลุ่มสาระฯ';
                acc[dept] = (acc[dept] || 0) + 1;
                return acc;
            }, {});
            renderStatsCard('stats-by-department', 'สรุปตามกลุ่มสาระฯ', byDept, 'department');

            // 3. Stats by Year
            const byYear = requests.reduce((acc, req) => {
                const year = new Date(req.docDate).getFullYear() + 543;
                acc[year] = (acc[year] || 0) + 1;
                return acc;
            }, {});
            renderStatsCard('stats-by-year', 'สรุปตามปี', byYear, 'year');
            
            // 4. Stats by Expense
            const byExpense = requests.reduce((acc, req) => {
                const type = req.expenseOption === 'no' ? 'ไม่เบิก' : 'เบิก';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});
             renderStatsCard('stats-by-expense', 'สรุปการเบิกค่าใช้จ่าย', byExpense, 'expense');
        }

        // เพิ่ม Event Listeners สำหรับสลับมุมมอง
        function setupStatsViewToggle() {
            const chartViewBtn = document.getElementById('stats-chart-view');
            const listViewBtn = document.getElementById('stats-list-view');
            const chartContent = document.getElementById('stats-chart-content');
            const listContent = document.getElementById('stats-list-content');
            
            chartViewBtn.addEventListener('click', () => {
                chartViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                chartContent.classList.remove('hidden');
                listContent.classList.add('hidden');
            });
            
            listViewBtn.addEventListener('click', () => {
                listViewBtn.classList.add('active');
                chartViewBtn.classList.remove('active');
                listContent.classList.remove('hidden');
                chartContent.classList.add('hidden');
            });
        }

        // แก้ไขฟังก์ชัน showStatsDetail ให้แสดงข้อมูลละเอียด
        function showStatsDetail(title, key, type) {
            const modal = document.getElementById('stats-detail-modal');
            document.getElementById('stats-detail-title').textContent = `${title}: ${key}`;
            const content = document.getElementById('stats-detail-content');
            content.innerHTML = '<div class="loader mx-auto"></div>';

            let filteredRequests = [];
            if (type === 'user') {
                filteredRequests = allRequestsCache.filter(r => (r.requesterName || 'N/A') === key);
            } else if (type === 'department') {
                 const userDepartmentMap = allUsersCache.reduce((map, user) => {
                    map[user.username] = user.department || 'ไม่ระบุกลุ่มสาระฯ';
                    return map;
                }, {});
                 filteredRequests = allRequestsCache.filter(r => (userDepartmentMap[r.username] || 'ไม่ระบุกลุ่มสาระฯ') === key);
            } else if (type === 'year') {
                filteredRequests = allRequestsCache.filter(r => {
                    const year = new Date(r.docDate).getFullYear() + 543;
                    return year.toString() === key;
                });
            } else if (type === 'expense') {
                const expenseType = key === 'ไม่เบิก' ? 'no' : 'partial';
                filteredRequests = allRequestsCache.filter(r => r.expenseOption === expenseType);
            }

            // สร้างตารางแสดงข้อมูล
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID คำขอ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">วัตถุประสงค์</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานที่</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">วันที่</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (filteredRequests.length === 0) {
                content.innerHTML = '<p class="text-center text-gray-500 py-8">ไม่พบข้อมูล</p>';
            } else {
                filteredRequests.forEach(req => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${req.id}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${req.purpose || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${req.location || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${new Date(req.docDate).toLocaleDateString('th-TH')}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                req.status === 'เสร็จสิ้น' ? 'bg-green-100 text-green-800' :
                                req.status === 'กำลังดำเนินการ' ? 'bg-blue-100 text-blue-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${req.status || 'ไม่ระบุ'}
                            </span>
                        </td>
                    `;
                });

                content.innerHTML = '';
                
                // เพิ่มสรุปจำนวน
                const summary = document.createElement('div');
                summary.className = 'mb-4 p-4 bg-blue-50 rounded-lg';
                summary.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">จำนวนทั้งหมด: ${filteredRequests.length} รายการ</span>
                        <button onclick="exportToExcel('${type}', '${key}')" class="btn btn-primary btn-sm">
                            <span>📊 Export Excel</span>
                        </button>
                    </div>
                `;
                content.appendChild(summary);
                content.appendChild(table);
            }
            
            modal.style.display = 'flex';
        }

        // ฟังก์ชันส่งออกเป็น Excel
        function exportToExcel(type, key) {
            let filteredRequests = [];
            
            // กรองข้อมูลเหมือนใน showStatsDetail
            if (type === 'user') {
                filteredRequests = allRequestsCache.filter(r => (r.requesterName || 'N/A') === key);
            } else if (type === 'department') {
                const userDepartmentMap = allUsersCache.reduce((map, user) => {
                    map[user.username] = user.department || 'ไม่ระบุกลุ่มสาระฯ';
                    return map;
                }, {});
                filteredRequests = allRequestsCache.filter(r => (userDepartmentMap[r.username] || 'ไม่ระบุกลุ่มสาระฯ') === key);
            } else if (type === 'year') {
                filteredRequests = allRequestsCache.filter(r => {
                    const year = new Date(r.docDate).getFullYear() + 543;
                    return year.toString() === key;
                });
            } else if (type === 'expense') {
                const expenseType = key === 'ไม่เบิก' ? 'no' : 'partial';
                filteredRequests = allRequestsCache.filter(r => r.expenseOption === expenseType);
            }
            
            // สร้างข้อมูลสำหรับ Excel
            const excelData = filteredRequests.map(req => ({
                'ID คำขอ': req.id,
                'ผู้ขอ': req.requesterName,
                'วัตถุประสงค์': req.purpose,
                'สถานที่': req.location,
                'วันที่': new Date(req.docDate).toLocaleDateString('th-TH'),
                'สถานะ': req.status,
                'เบิกค่าใช้จ่าย': req.expenseOption === 'no' ? 'ไม่เบิก' : 'เบิก',
                'จำนวนเงิน': req.totalExpense || 0
            }));
            
            // สร้าง worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ข้อมูลสถิติ");
            
            // บันทึกไฟล์
            const fileName = `สถิติ_${type}_${key}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showAlert("ส่งออกสำเร็จ", `ไฟล์ ${fileName} ถูกดาวน์โหลดแล้ว`);
        }

        // --- CACHE MANAGEMENT ---
        function clearAllCache() {
            allRequestsCache = [];
            allMemosCache = [];
            userMemosCache = [];
            allUsersCache = [];
            specialPositionMap = {};
            
            // ทำลายกราฟทั้งหมด
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        // --- AUTHENTICATION HANDLERS ---
        
        // --- AUTHENTICATION HANDLERS ---
async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const errorP = document.getElementById('login-error');
  
  errorP.classList.add('hidden');
  
  // Validation
  if (!username || !password) {
    errorP.textContent = "กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
    errorP.classList.remove('hidden');
    return;
  }
  
  toggleLoader('login-button', true);

  try {
    console.log('Sending login request for:', username);
    const result = await apiCall('POST', 'verifyCredentials', { username, password });
    
    if (result.status === 'success') {
      console.log('Login successful, user:', result.user);
      sessionStorage.setItem('currentUser', JSON.stringify(result.user));
      initializeUserSession(result.user);
    } else {
      throw new Error(result.message || 'การเข้าสู่ระบบล้มเหลว');
    }
  } catch (error) {
    console.error('Login error:', error);
    errorP.textContent = error.message;
    errorP.classList.remove('hidden');
  } finally {
    toggleLoader('login-button', false);
  }
}

// แก้ไขฟังก์ชัน apiCall เพื่อ debug
async function apiCall(method, action, payload = {}) {
  let url = SCRIPT_URL;
  const options = {
    method: method,
    redirect: 'follow',
    headers: { 'Content-Type': 'text/plain;charset=utf-8', },
  };

  console.log(`API Call: ${method} ${action}`, payload);

  if (method === 'GET') {
    const params = new URLSearchParams({ action, ...payload, cacheBust: new Date().getTime() }); 
    url += `?${params}`;
  } else {
    options.body = JSON.stringify({ action, payload });
  }

  try {
    const response = await fetch(url, options);
    console.log('Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('API Response:', result);
    
    if (result.status === 'error') {
      throw new Error(result.message);
    }
    
    return result;
  } catch (error) {
    console.error('API Call Error:', error);
    
    if (error.message.includes('Failed to fetch')) {
      showAlert('การเชื่อมต่อล้มเหลว', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและ URL ของสคริปต์');
    } else {
      showAlert('เกิดข้อผิดพลาด', error.message);
    }
    throw error;
  }
}

        async function handleRegister(e) {
            e.preventDefault();
            const payload = {
                username: document.getElementById('register-username').value.trim(),
                password: document.getElementById('register-password').value,
                fullName: document.getElementById('register-fullname').value.trim(),
                position: document.getElementById('register-position').value.trim(),
                department: document.getElementById('register-department').value.trim(),
                role: 'user'
            };
            const errorP = document.getElementById('register-error');
            errorP.classList.add('hidden');
            
            if (payload.password.length < 6) {
                errorP.textContent = "รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร";
                errorP.classList.remove('hidden');
                return;
            }

            toggleLoader('register-save-button', true);
            
            try {
                const result = await apiCall('POST', 'registerUser', payload);
                document.getElementById('register-modal').style.display = 'none';
                e.target.reset();
                showAlert("สมัครสำเร็จ", result.message);
            } catch (error) {
                errorP.textContent = error.message;
                errorP.classList.remove('hidden');
            } finally {
                toggleLoader('register-save-button', false);
            }
        }
        
        // --- DATA FETCHING & RENDERING (USER) ---
        
        async function fetchUserRequests() {
            const user = getCurrentUser();
            if (!user) return;
            const loader = document.getElementById('requests-loader');
            const list = document.getElementById('requests-list');
            loader.classList.remove('hidden');
            list.classList.add('hidden');

            try {
                 const [requestsResult, memosResult] = await Promise.all([
                    apiCall('GET', 'getUserRequests', { username: user.username }),
                    apiCall('GET', 'getSentMemos', { username: user.username })
                ]);
                allRequestsCache = requestsResult.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) || [];
                userMemosCache = memosResult.data || []; // Populate the global cache
                renderRequestsList(allRequestsCache, userMemosCache);
            } catch (error) {
                console.error("Error fetching user requests:", error);
                document.getElementById('no-requests-message').classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        function renderRequestsList(requests, memos = [], searchTerm = '') {
            const listContainer = document.getElementById('requests-list');
            const noDataMsg = document.getElementById('no-requests-message');
            listContainer.innerHTML = '';

            let filteredRequests = requests;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                filteredRequests = requests.filter(req => 
                    req.purpose?.toLowerCase().includes(lowerCaseSearch) ||
                    req.location?.toLowerCase().includes(lowerCaseSearch) ||
                    req.id?.toLowerCase().includes(lowerCaseSearch)
                );
            }
            
            if (filteredRequests.length === 0) {
                noDataMsg.classList.remove('hidden');
                listContainer.classList.add('hidden');
            } else {
                noDataMsg.classList.add('hidden');
                const list = document.createElement('div');
                list.className = 'space-y-4';

                const memoMap = new Map(memos.map(memo => [memo.refNumber, memo]));

                filteredRequests.forEach(req => {
                    const memo = memoMap.get(req.id);
                    let completedFilesHTML = '';
                    if (memo) {
                        if (memo.completedMemoUrl) {
                            completedFilesHTML += `<a href="${memo.completedMemoUrl}" target="_blank" class="text-green-600 hover:text-green-900 text-sm font-semibold">ไฟล์บันทึก</a>`;
                        }
                        if (memo.completedCommandUrl) {
                            completedFilesHTML += `<a href="${memo.completedCommandUrl}" target="_blank" class="text-blue-600 hover:text-blue-900 text-sm font-semibold ml-4">ไฟล์คำสั่ง</a>`;
                        }
                        if (memo.dispatchBookUrl) {
                            completedFilesHTML += `<a href="${memo.dispatchBookUrl}" target="_blank" class="text-purple-600 hover:text-purple-900 text-sm font-semibold ml-4">หนังสือส่ง</a>`;
                        }
                    }

                    const card = document.createElement('div');
                    card.className = 'p-4 border rounded-lg shadow-sm hover:shadow-md transition bg-white';
                    card.innerHTML = `
                        <div class="flex flex-wrap justify-between items-start gap-2">
                            <div>
                                <h4 class="font-bold text-lg text-indigo-700">${req.purpose}</h4>
                                <p class="text-sm text-gray-600"><strong>สถานที่:</strong> ${req.location}</p>
                                <p class="text-xs text-gray-400 mt-1"><strong>ID:</strong> ${req.id}</p>
                            </div>
                            <div class="text-right text-xs space-y-1">
                                <p>สถานะ: <span class="font-bold px-2 py-1 rounded-full bg-blue-100 text-blue-800">${memo ? translateStatus(memo.status) : 'ยังไม่ส่ง'}</span></p>
                            </div>
                        </div>

                        ${completedFilesHTML ? `
                        <div class="border-t mt-3 pt-3">
                            <h5 class="text-sm font-bold text-gray-700 mb-2">ไฟล์ฉบับสมบูรณ์:</h5>
                            <div class="flex flex-wrap gap-4">
                                ${completedFilesHTML}
                            </div>
                        </div>
                        ` : ''}

                        <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 justify-end">
                            ${req.pdfUrl ? `<a href="${req.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูร่างบันทึก</a>` : ''}
                            <button class="btn text-sm bg-blue-500 text-white" data-id="${req.id}" data-action="send-memo">ส่งบันทึก</button>
                            <button class="btn text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900" data-id="${req.id}" data-action="edit">แก้ไข</button>
                            <button class="btn text-sm btn-danger" data-id="${req.id}" data-action="delete">ลบ</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
                listContainer.innerHTML = '';
                listContainer.appendChild(list);
                listContainer.addEventListener('click', handleRequestAction);
                listContainer.classList.remove('hidden');
            }
        }
        
        async function handleRequestAction(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const requestId = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'edit') {
                await editRequest(requestId);
            } else if (action === 'delete') {
                const confirmed = await showConfirm("ยืนยันการลบ", "คุณแน่ใจหรือไม่ว่าต้องการลบรายการคำขอนี้? การกระทำนี้ไม่สามารถย้อนกลับได้");
                if (confirmed) {
                    try {
                       await apiCall('POST', 'deleteRequest', { id: requestId });
                       clearAllCache();
                       showAlert("ลบสำเร็จ", "รายการคำขอถูกลบเรียบร้อยแล้ว");
                       await fetchUserRequests(); // Refresh list
                    } catch(error) {
                        showAlert("เกิดข้อผิดพลาด", "ไม่สามารถลบรายการได้: " + error.message);
                    }
                }
            } else if (action === 'send-memo') {
                document.getElementById('memo-modal-request-id').value = requestId;
                document.getElementById('send-memo-modal').style.display = 'flex';
            }
        }
        
        async function editRequest(requestId) {
            const requestData = allRequestsCache.find(r => r.id === requestId);
            if (!requestData) {
                showAlert("ผิดพลาด", "ไม่พบข้อมูลคำขอ");
                return;
            }
            
            try {
                // โหลด attendees ก่อน
                const attendeesResult = await apiCall('GET', 'getAttendeesForRequest', { requestId });
                const attendees = attendeesResult.data || [];
                
                // ล้าง form แต่ไม่ล้าง attendees
                document.getElementById('request-form').reset();
                document.getElementById('form-request-id').value = requestId;
                document.getElementById('form-attendees-list').innerHTML = ''; // ล้างเฉพาะ attendees list
                
                // เติมข้อมูลพื้นฐาน
                if(requestData.docDate) document.getElementById('form-doc-date').value = new Date(requestData.docDate).toISOString().split('T')[0];
                document.getElementById('form-requester-name').value = requestData.requesterName;
                document.getElementById('form-requester-position').value = requestData.requesterPosition;
                document.getElementById('form-location').value = requestData.location;
                document.getElementById('form-purpose').value = requestData.purpose;
                if(requestData.startDate) document.getElementById('form-start-date').value = new Date(requestData.startDate).toISOString().split('T')[0];
                if(requestData.endDate) document.getElementById('form-end-date').value = new Date(requestData.endDate).toISOString().split('T')[0];

                // เติมข้อมูล attendees ใหม่
                attendees.forEach(att => addAttendeeField(att.name, att.position));
                
                // เติมข้อมูลอื่นๆ...
                document.querySelector(`input[name="expense_option"][value="${requestData.expenseOption}"]`).checked = true;
                toggleExpenseOptions();
                
                if(requestData.expenseOption === 'partial') {
                    const expenseItems = JSON.parse(requestData.expenseItems || '[]');
                    expenseItems.forEach(item => {
                        const chk = document.querySelector(`input[data-item-name="${item.name}"]`);
                        if(chk) {
                            chk.checked = true;
                            if(item.name === 'ค่าใช้จ่ายอื่นๆ') {
                               document.getElementById('expense_other_text').value = item.detail;
                            }
                        }
                    });
                   document.getElementById('form-total-expense').value = requestData.totalExpense;
                }
                
                document.querySelector(`input[name="vehicle_option"][value="${requestData.vehicleOption}"]`).checked = true;
                toggleVehicleOptions();
                if (requestData.vehicleOption === 'private') {
                    document.getElementById('form-license-plate').value = requestData.licensePlate;
                }
                
                const departmentSelect = document.getElementById('form-department');
                departmentSelect.value = requestData.department;
                departmentSelect.dispatchEvent(new Event('change'));

                document.getElementById('submit-button-text').textContent = 'อัปเดตเอกสารใหม่';
                switchPage('form-page');

            } catch(error) {
                 console.error("Error loading attendees:", error);
                 showAlert("คำเตือน", "โหลดข้อมูลผู้ร่วมเดินทางไม่สมบูรณ์");
            }
        }
       
        // --- FORM HANDLING ---

        async function resetRequestForm() {
            const user = getCurrentUser();
            document.getElementById('request-form').reset();
            document.getElementById('form-request-id').value = '';
            document.getElementById('form-attendees-list').innerHTML = '';
            document.getElementById('form-doc-date').valueAsDate = new Date();
            document.getElementById('form-requester-name').value = user.fullName;
            document.getElementById('form-requester-position').value = user.position;
            
            await populateDepartmentDropdownFromUsers();
            const departmentSelect = document.getElementById('form-department');
            if (user.department && Array.from(departmentSelect.options).some(opt => opt.value === user.department)) {
                departmentSelect.value = user.department;
            }
            departmentSelect.dispatchEvent(new Event('change'));

            toggleExpenseOptions();
            toggleVehicleOptions();
            document.getElementById('form-result').classList.add('hidden');
            document.getElementById('submit-button-text').textContent = 'บันทึกและสร้างเอกสาร';
        }
        
        function addAttendeeField(name = '', position = '') {
            const list = document.getElementById('form-attendees-list');
            const attendeeDiv = document.createElement('div');
            attendeeDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-2';
            attendeeDiv.innerHTML = `
                <input type="text" class="form-input attendee-name md:col-span-1" placeholder="ชื่อ-นามสกุล" required>
                <div class="attendee-position-wrapper md:col-span-1">
                     <select class="form-input attendee-position-select">
                        <option value="">-- เลือกตำแหน่ง --</option>
                        <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                        <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                        <option value="ครู">ครู</option>
                        <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                        <option value="พนักงานราชการ">พนักงานราชการ</option>
                        <option value="ครูอัตราจ้าง">ครูอัตราจ้าง</option>
                        <option value="พนักงานขับรถ">พนักงานขับรถ</option>
                        <option value="นักเรียน">นักเรียน</option>
                        <option value="other">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" class="form-input attendee-position-other hidden mt-1" placeholder="ระบุตำแหน่ง">
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ลบ</button>
            `;
            list.appendChild(attendeeDiv);
            
            const nameInput = attendeeDiv.querySelector('.attendee-name');
            const select = attendeeDiv.querySelector('.attendee-position-select');
            const otherInput = attendeeDiv.querySelector('.attendee-position-other');

            nameInput.value = name;
            
            const optionExists = Array.from(select.options).some(opt => opt.value === position);
            if (optionExists) {
                select.value = position;
            } else if (position) {
                select.value = 'other';
                otherInput.value = position;
                otherInput.classList.remove('hidden');
            }

            select.addEventListener('change', () => {
                otherInput.classList.toggle('hidden', select.value !== 'other');
            });
        }
        
        async function handleRequestFormSubmit(e) {
            e.preventDefault();
            
            // Validation
            const startDate = new Date(document.getElementById('form-start-date').value);
            const endDate = new Date(document.getElementById('form-end-date').value);
            if (startDate > endDate) {
                showAlert("ข้อมูลไม่ถูกต้อง", "วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด");
                return;
            }
            
            const attendees = Array.from(document.querySelectorAll('#form-attendees-list > div'));
            const hasEmptyAttendees = attendees.some(div => {
                const name = div.querySelector('.attendee-name').value.trim();
                const select = div.querySelector('.attendee-position-select');
                let position = select.value;
                if (position === 'other') {
                    position = div.querySelector('.attendee-position-other').value.trim();
                }
                return !name || !position;
            });
            
            if (hasEmptyAttendees) {
                showAlert("ข้อมูลไม่ครบ", "กรุณากรอกข้อมูลผู้ร่วมเดินทางให้ครบถ้วน");
                return;
            }
            
            toggleLoader('submit-request-button', true);

            const expenseItems = [];
            if (document.querySelector('input[name="expense_option"]:checked').value === 'partial') {
                document.querySelectorAll('input[name="expense_item"]:checked').forEach(chk => {
                    const item = { name: chk.dataset.itemName };
                    if (item.name === 'ค่าใช้จ่ายอื่นๆ') {
                        item.detail = document.getElementById('expense_other_text').value.trim();
                    }
                    expenseItems.push(item);
                });
            }

            const payload = {
                // --- When updating, this ID is sent to the backend to identify which row to update. ---
                id: document.getElementById('form-request-id').value || null,
                username: getCurrentUser().username,
                docDate: document.getElementById('form-doc-date').value,
                requesterName: document.getElementById('form-requester-name').value.trim(),
                requesterPosition: document.getElementById('form-requester-position').value.trim(),
                location: document.getElementById('form-location').value.trim(),
                purpose: document.getElementById('form-purpose').value.trim(),
                startDate: document.getElementById('form-start-date').value,
                endDate: document.getElementById('form-end-date').value,
                attendees: Array.from(document.querySelectorAll('#form-attendees-list > div')).map(div => {
                    const select = div.querySelector('.attendee-position-select');
                    let position = select.value;
                    if (position === 'other') {
                        position = div.querySelector('.attendee-position-other').value.trim();
                    }
                    return {
                        name: div.querySelector('.attendee-name').value.trim(),
                        position: position
                    };
                }),
                expenseOption: document.querySelector('input[name="expense_option"]:checked').value,
                expenseItems: expenseItems,
                totalExpense: document.getElementById('form-total-expense').value || 0,
                vehicleOption: document.querySelector('input[name="vehicle_option"]:checked').value,
                licensePlate: document.getElementById('form-license-plate').value.trim(),
                department: document.getElementById('form-department').value,
                headName: document.getElementById('form-head-name').value,
            };

            try {
                const result = await apiCall('POST', 'createRequest', payload);
                
                document.getElementById('form-result-title').textContent = 'สร้างเอกสารสำเร็จ!';
                document.getElementById('form-result-message').textContent = `บันทึกข้อความสำหรับ ID ${result.data.id} ถูกสร้าง/อัปเดตแล้ว`;
                document.getElementById('form-result-link').href = result.data.pdfUrl;
                document.getElementById('form-result').classList.remove('hidden');
                
                clearAllCache();
                await fetchUserRequests();
            } catch (error) {
                showAlert("เกิดข้อผิดพลาด", "ไม่สามารถบันทึกข้อมูลได้: " + error.message);
            } finally {
                toggleLoader('submit-request-button', false);
            }
        }

        async function populateDepartmentDropdownFromUsers() {
            const select = document.getElementById('form-department');
            select.disabled = true;
            select.innerHTML = '<option value="">กำลังโหลด...</option>';
            
            try {
                const result = await apiCall('GET', 'getAllUsers');
                const users = result.data || [];
                specialPositionMap = {};
                const specialPositions = new Set();

                users.forEach(user => {
                    if (user.specialPosition && user.specialPosition.trim() !== '') {
                        const pos = user.specialPosition.trim();
                        specialPositions.add(pos);
                        if (!specialPositionMap[pos]) {
                            specialPositionMap[pos] = user.fullName;
                        }
                    }
                });

                select.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
                Array.from(specialPositions).sort().forEach(pos => {
                    const option = document.createElement('option');
                    option.value = pos;
                    option.textContent = pos;
                    select.appendChild(option);
                });

                // เลือก department ของผู้ใช้ถ้ามี
                const user = getCurrentUser();
                if (user.department && Array.from(select.options).some(opt => opt.value === user.department)) {
                    select.value = user.department;
                }
                select.dispatchEvent(new Event('change'));

            } catch (error) {
                console.error("Error populating departments from users:", error);
                select.innerHTML = '<option value="">โหลดข้อมูลไม่สำเร็จ</option>';
            } finally {
                select.disabled = false;
            }
        }
        
        function toggleExpenseOptions() {
            const partialOptions = document.getElementById('partial-expense-options');
            const totalContainer = document.getElementById('total-expense-container');
            if (document.getElementById('expense_partial').checked) {
                partialOptions.classList.remove('hidden');
                totalContainer.classList.remove('hidden');
            } else {
                partialOptions.classList.add('hidden');
                totalContainer.classList.add('hidden');
            }
        }
        
        function toggleVehicleOptions() {
            const privateDetails = document.getElementById('private-vehicle-details');
            if (document.getElementById('vehicle_private').checked) {
                privateDetails.classList.remove('hidden');
            } else {
                privateDetails.classList.add('hidden');
            }
        }

        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            toggleLoader('form-import-excel', true); // <-- [MODIFIED] Show loader
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    json.forEach(row => {
                        const name = row['ชื่อ-นามสกุล'] || row['FullName'];
                        const position = row['ตำแหน่ง'] || row['Position'];
                        if (name && position) addAttendeeField(name, position);
                    });
                    showAlert("นำเข้าสำเร็จ", `เพิ่มผู้ร่วมเดินทางจำนวน ${json.length} คนเรียบร้อยแล้ว`);
                } catch (error) {
                    showAlert("ผิดพลาด", "ไม่สามารถอ่านไฟล์ Excel ได้ กรุณาตรวจสอบรูปแบบไฟล์");
                } finally {
                    toggleLoader('form-import-excel', false); // <-- [MODIFIED] Hide loader
                }
            };
            reader.onerror = () => { // <-- [MODIFIED] Added error handler
                showAlert("ผิดพลาด", "เกิดข้อผิดพลาดในการอ่านไฟล์");
                toggleLoader('form-import-excel', false);
            };
            reader.readAsArrayBuffer(file);
             e.target.value = ''; // Reset input
        }
        
        function downloadAttendeeTemplate() {
            const data = [{ "ชื่อ-นามสกุล": "นายสมชาย ใจดี", "ตำแหน่ง": "ครู" }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendees");
            XLSX.writeFile(wb, "attendee_template.xlsx");
        }
        
        function togglePasswordVisibility() {
            const isChecked = document.getElementById('show-password-toggle').checked;
            const type = isChecked ? 'text' : 'password';
            document.getElementById('profile-current-password').type = type;
            document.getElementById('profile-new-password').type = type;
            document.getElementById('profile-confirm-password').type = type;
        }

        // --- MEMO FUNCTIONS ---
        async function handleMemoSubmitFromModal(e) {
            e.preventDefault();
            const form = e.target;
            const refNumber = form.querySelector('#memo-modal-request-id').value;
            const memoType = form.querySelector('input[name="modal_memo_type"]:checked').value;
            const fileInput = form.querySelector('#modal-memo-file');

            if (memoType === 'no_reimburse' && fileInput.files.length === 0) {
                showAlert("ข้อมูลไม่ครบ", "กรุณาแนบไฟล์ PDF");
                return;
            }
            
            // เพิ่ม confirmation
            const confirmMessage = memoType === 'reimburse' 
                ? "ยืนยันการส่งบันทึกข้อความแบบขอเบิกค่าใช้จ่าย?"
                : "ยืนยันการส่งบันทึกข้อความแบบไม่เบิกค่าใช้จ่าย?";
            
            const confirmed = await showConfirm("ยืนยันการส่ง", confirmMessage);
            if (!confirmed) return;
            
            toggleLoader('send-memo-submit-button', true); // <-- [MODIFIED] Show loader

            try {
                const payload = {
                    refNumber: refNumber,
                    username: getCurrentUser().username,
                    memoType: memoType,
                    file: null
                };

                if (memoType === 'no_reimburse') {
                    payload.file = await fileToObject(fileInput.files[0]);
                }

                await apiCall('POST', 'uploadMemo', payload);
                showAlert('สำเร็จ', 'ส่งบันทึกข้อความเรียบร้อยแล้ว');
                document.getElementById('send-memo-modal').style.display = 'none';
                form.reset();
                clearAllCache();
                await fetchUserRequests(); // Refresh dashboard to update status
            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถส่งบันทึกข้อความได้: ' + error.message);
            } finally {
                toggleLoader('send-memo-submit-button', false); // <-- [MODIFIED] Hide loader
            }
        }

        // --- PROFILE FUNCTIONS ---
        function loadProfileData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('profile-username').value = user.username;
                document.getElementById('profile-fullname').value = user.fullName;
                document.getElementById('profile-position').value = user.position;
                document.getElementById('profile-department').value = user.department;
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            toggleLoader('save-profile-button', true);
            const payload = {
                username: document.getElementById('profile-username').value,
                fullName: document.getElementById('profile-fullname').value,
                position: document.getElementById('profile-position').value,
                department: document.getElementById('profile-department').value
            };

            try {
                const result = await apiCall('POST', 'updateUserProfile', payload); 
                // Update session storage
                const user = getCurrentUser();
                const updatedUser = {...user, ...payload};
                sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
                updateUIForUser(updatedUser); // Update header
                
                const msg = document.getElementById('profile-message');
                msg.textContent = result.message;
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถอัปเดตข้อมูลได้: ' + error.message);
            } finally {
                toggleLoader('save-profile-button', false);
            }
        }

        async function handlePasswordUpdate(e) {
            e.preventDefault();
            const newPassword = document.getElementById('profile-new-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;
            const errorP = document.getElementById('password-error');
            errorP.classList.add('hidden');
            
            if (newPassword !== confirmPassword) {
                errorP.textContent = 'รหัสผ่านใหม่ไม่ตรงกัน';
                errorP.classList.remove('hidden');
                return;
            }
            if (newPassword.length < 6) {
                errorP.textContent = 'รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร';
                errorP.classList.remove('hidden');
                return;
            }

            toggleLoader('save-password-button', true);
            const payload = {
                username: getCurrentUser().username,
                oldPassword: document.getElementById('profile-current-password').value,
                newPassword: newPassword,
            };

            try {
                const result = await apiCall('POST', 'updatePassword', payload);
                const msg = document.getElementById('password-message');
                msg.textContent = result.message;
                msg.classList.remove('hidden');
                e.target.reset();
                setTimeout(() => msg.classList.add('hidden'), 3000);
            } catch(error) {
                errorP.textContent = error.message;
                errorP.classList.remove('hidden');
            } finally {
                toggleLoader('save-password-button', false);
            }
        }
        
        // --- ADMIN FUNCTIONS ---

        async function fetchAllUsers() {
            document.getElementById('admin-loader').classList.remove('hidden');
            document.getElementById('admin-users-list').classList.add('hidden');
            try {
                const result = await apiCall('GET', 'getAllUsers');
                allUsersCache = result.data || [];
                renderAdminUsersList(allUsersCache);
            } finally {
                 document.getElementById('admin-loader').classList.add('hidden');
            }
        }

        function renderAdminUsersList(users) {
            const container = document.getElementById('admin-users-list');
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อผู้ใช้</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สิทธิ์</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                </tbody>`;
            const tbody = table.querySelector('tbody');
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.fullName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900" data-username="${user.username}" data-action="admin-edit-user">แก้ไข</button>
                        <button class="text-red-600 hover:text-red-900 ml-4" data-username="${user.username}" data-action="admin-delete-user">ลบ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            container.innerHTML = '';
            container.appendChild(table);
            container.classList.remove('hidden');
            container.addEventListener('click', handleAdminUserAction);
        }
        
        async function handleAdminUserAction(e) {
            const target = e.target;
            const action = target.dataset.action;
            const username = target.dataset.username;
            if (!action || !username) return;

            if (action === 'admin-edit-user') {
                const user = allUsersCache.find(u => u.username === username);
                if (user) {
                    document.getElementById('admin-modal-title').textContent = 'แก้ไขผู้ใช้';
                    document.getElementById('modal-original-username').value = user.username;
                    document.getElementById('modal-username').value = user.username;
                    document.getElementById('modal-username').readOnly = true;
                    document.getElementById('modal-password').value = '';
                    document.getElementById('modal-fullname').value = user.fullName;
                    document.getElementById('modal-position').value = user.position;
                    document.getElementById('modal-department').value = user.department;
                    document.getElementById('modal-role').value = user.role;
                    document.getElementById('admin-modal').style.display = 'flex';
                }
            } else if (action === 'admin-delete-user') {
                if (await showConfirm('ยืนยันการลบ', `คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ "${username}"?`)) {
                    try {
                        await apiCall('POST', 'deleteUser', { username });
                        showAlert('สำเร็จ', 'ลบผู้ใช้สำเร็จ');
                        await fetchAllUsers();
                    } catch (error) {
                        showAlert('ผิดพลาด', 'ไม่สามารถลบผู้ใช้ได้: ' + error.message);
                    }
                }
            }
        }

        function openAddUserModal() {
            document.getElementById('admin-modal-form').reset();
            document.getElementById('admin-modal-title').textContent = 'เพิ่มผู้ใช้ใหม่';
            document.getElementById('modal-original-username').value = '';
            document.getElementById('modal-username').readOnly = false;
            document.getElementById('admin-modal').style.display = 'flex';
        }

        async function handleAdminUserSave(e) {
            e.preventDefault();
            toggleLoader('admin-modal-save-button', true);
            const isUpdate = !!document.getElementById('modal-original-username').value;
            const payload = {
                username: document.getElementById('modal-username').value,
                password: document.getElementById('modal-password').value,
                fullName: document.getElementById('modal-fullname').value,
                position: document.getElementById('modal-position').value,
                department: document.getElementById('modal-department').value,
                role: document.getElementById('modal-role').value,
            };
            try {
                const action = isUpdate ? 'updateUserProfile' : 'addUser'; 
                if(isUpdate && !payload.password) delete payload.password; // Don't update password if blank
                await apiCall('POST', action, payload);
                showAlert('สำเร็จ', `ผู้ใช้ถูก${isUpdate ? 'อัปเดต' : 'เพิ่ม'}เรียบร้อยแล้ว`);
                document.getElementById('admin-modal').style.display = 'none';
                await fetchAllUsers();
            } catch(error) {
                showAlert('ผิดพลาด', `ไม่สามารถบันทึกข้อมูลผู้ใช้ได้: ${error.message}`);
            } finally {
                toggleLoader('admin-modal-save-button', false);
            }
        }
        
        function downloadUserTemplate() {
            const data = [{ Username: "testuser", Password: "password123", FullName: "Test User", Position: "Teacher", Department: "Science", Role: "user" }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Users");
            XLSX.writeFile(wb, "user_import_template.xlsx");
        }

        async function handleUserImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            toggleLoader('import-users-button', true); // <-- [MODIFIED] Show loader

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const users = XLSX.utils.sheet_to_json(worksheet);
                    
                    const result = await apiCall('POST', 'importUsers', { users });
                    showAlert('นำเข้าสำเร็จ', result.message);
                    await fetchAllUsers();
                } catch(error) {
                    showAlert('เกิดข้อผิดพลาดในการนำเข้า', error.message);
                } finally {
                    toggleLoader('import-users-button', false); // <-- [MODIFIED] Hide loader
                }
            };
            reader.onerror = () => { // <-- [MODIFIED] Added error handler
                showAlert("ผิดพลาด", "เกิดข้อผิดพลาดในการอ่านไฟล์");
                toggleLoader('import-users-button', false);
            };
            reader.readAsArrayBuffer(file);
            e.target.value = ''; // Reset input
        }

        async function fetchAllMemos() {
            const loader = document.getElementById('admin-memos-loader');
            loader.classList.remove('hidden');
            document.getElementById('admin-memos-list').classList.add('hidden');
            try {
                const results = await Promise.all([apiCall('GET', 'getAllMemos'), apiCall('GET', 'getAllRequests')]);
                allMemosCache = results[0].data.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)) || [];
                allRequestsCache = results[1].data || [];
                renderAdminMemosList(allMemosCache, allRequestsCache);
            } catch (e) {
                document.getElementById('no-admin-memos-message').classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderAdminMemosList(memos, requests) {
            const container = document.getElementById('admin-memos-list');
            const noDataMsg = document.getElementById('no-admin-memos-message');
            if (memos.length === 0) {
                noDataMsg.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');
            container.classList.remove('hidden');

            const requestMap = requests.reduce((map, req) => {
                map[req.id] = req;
                return map;
            }, {});

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID บันทึก</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้ส่ง</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID คำขอ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            memos.forEach(memo => {
                const request = requestMap[memo.refNumber];
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">${memo.id}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${memo.submittedBy}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${memo.refNumber}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${translateStatus(memo.status)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right space-x-2">
                        ${memo.fileURL ? `<a href="${memo.fileURL}" target="_blank" class="text-indigo-600 hover:text-indigo-900 text-sm">ไฟล์ต้นฉบับ</a>` : ''}
                        ${memo.completedMemoUrl ? `<a href="${memo.completedMemoUrl}" target="_blank" class="text-green-600 hover:text-green-900 text-sm font-semibold">ไฟล์บันทึก</a>` : ''}
                        ${memo.completedCommandUrl ? `<a href="${memo.completedCommandUrl}" target="_blank" class="text-blue-600 hover:text-blue-900 text-sm font-semibold">ไฟล์คำสั่ง</a>` : ''}
                        ${memo.dispatchBookUrl ? `<a href="${memo.dispatchBookUrl}" target="_blank" class="text-purple-600 hover:text-purple-900 text-sm font-semibold">หนังสือส่ง</a>` : ''}
                        <button class="btn btn-sm btn-primary" data-action="manage-memo" data-id="${memo.id}">จัดการ</button>
                        <button class="btn btn-sm btn-danger" data-action="reject-memo" data-id="${memo.id}">ปฏิเสธ</button>
                    </td>
                `;
            });
            container.innerHTML = '';
            container.appendChild(table);

            container.addEventListener('click', async (e) => {
                const button = e.target.closest('button[data-action]');
                if(!button) return;

                const action = button.dataset.action;
                if(action === "manage-memo") {
                    document.getElementById('action-memo-id').value = button.dataset.id;
                    document.getElementById('admin-memo-action-modal').style.display = 'flex';
                } else if (action === "reject-memo") {
                    const memoId = button.dataset.id;
                    if (await showConfirm('ยืนยันการปฏิเสธ', 'คุณต้องการส่งบันทึกนี้กลับไปแก้ไขใช่หรือไม่?')) {
                        try {
                            await apiCall('POST', 'updateMemoStatus', { id: memoId, status: 'นำกลับไปแก้ไข' });
                            showAlert('สำเร็จ', 'สถานะถูกเปลี่ยนเป็น "นำกลับไปแก้ไข" แล้ว');
                            await fetchAllMemos();
                        } catch (error) {
                            showAlert('ผิดพลาด', 'ไม่สามารถอัปเดตสถานะได้: ' + error.message);
                        }
                    }
                }
            })
        }

        async function fetchAllRequestsForCommand() {
            const loader = document.getElementById('command-requests-loader');
            loader.classList.remove('hidden');
            document.getElementById('command-requests-list').classList.add('hidden');
            try {
                const result = await apiCall('GET', 'getAllRequests');
                allRequestsCache = result.data.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)) || [];
                renderCommandRequestsList(allRequestsCache);
            } catch (e) {
                document.getElementById('no-command-requests-message').classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }
        function renderCommandRequestsList(requests) {
            const container = document.getElementById('command-requests-list');
            const noDataMsg = document.getElementById('no-command-requests-message');
             if (requests.length === 0) {
                noDataMsg.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');
            container.classList.remove('hidden');
            
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID คำขอ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้ขอ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">วัตถุประสงค์</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            requests.forEach(req => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">${req.id}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${req.requesterName}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${req.purpose}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right space-x-2">
                        ${req.dispatchBookPdfUrl ? `<a href="${req.dispatchBookPdfUrl}" target="_blank" class="btn btn-sm bg-gray-500 text-white">ดูหนังสือส่ง</a>` : ''}
                        <button class="btn btn-sm bg-purple-600 text-white" data-action="create-dispatch" data-request-id="${req.id}">ออกหนังสือส่ง</button>
                        
                        ${req.commandPdfUrl ? `<a href="${req.commandPdfUrl}" target="_blank" class="btn btn-sm bg-gray-500 text-white">ดูคำสั่ง</a>` : ''}
                        <button class="btn btn-sm btn-success" data-action="issue-command" data-id="${req.id}">ออกคำสั่ง</button>
                    </td>
                `;
            });

            container.innerHTML = '';
            container.appendChild(table);

            container.addEventListener('click', async (e) => {
                const button = e.target.closest('button[data-action]');
                 if(!button) return;

                const requestId = button.dataset.id || button.dataset.requestId;
                const action = button.dataset.action;

                const requestData = allRequestsCache.find(r => r.id === requestId);
                if (!requestData) {
                    showAlert('ผิดพลาด', 'ไม่พบข้อมูลคำขอ');
                    return;
                }
                
                if (action === 'issue-command') {
                    document.getElementById('approval-request-id').value = requestId;
                    document.getElementById('preview-solo').onclick = () => { if (requestData.commandPdfUrlSolo) window.open(requestData.commandPdfUrlSolo, '_blank'); };
                    document.getElementById('preview-small').onclick = () => { if (requestData.commandPdfUrlGroupSmall) window.open(requestData.commandPdfUrlGroupSmall, '_blank'); };
                    document.getElementById('preview-large').onclick = () => { if (requestData.commandPdfUrlGroupLarge) window.open(requestData.commandPdfUrlGroupLarge, '_blank'); };
                    document.getElementById('command-approval-modal').style.display = 'flex';
                } else if (action === 'create-dispatch') {
                     document.getElementById('dispatch-request-id').value = requestId;
                    const now = new Date();
                    const thaiYear = now.getFullYear() + 543;
                    const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                    document.getElementById('dispatch-month').value = thaiMonths[now.getMonth()];
                    document.getElementById('dispatch-year').value = thaiYear;
                    document.getElementById('dispatch-modal').style.display = 'flex';
                }
            })
        }
        async function handleCommandApproval(e) {
            e.preventDefault();
            const payload = {
                requestId: document.getElementById('approval-request-id').value,
                templateType: document.querySelector('input[name="templateType"]:checked').value
            };

            try {
                await apiCall('POST', 'approveCommand', payload);
                showAlert('สำเร็จ', 'ออกคำสั่งเรียบร้อยแล้ว และสถานะถูกเปลี่ยนเป็น "เสร็จสิ้นรอออกคำสั่งไปราชการ"');
                document.getElementById('command-approval-modal').style.display = 'none';
                await fetchAllRequestsForCommand();
            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถออกคำสั่งได้: ' + error.message);
            }
        }

        async function updateRequestStatusCommand(requestId, newStatus) {
             try {
                await apiCall('POST', 'updateRequestStatusCommand', { requestId, status: newStatus });
                showAlert('สำเร็จ', 'อัปเดตสถานะเรียบร้อยแล้ว');
                await fetchAllRequestsForCommand();
            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถอัปเดตสถานะได้: ' + error.message);
            }
        }


        async function handleAdminMemoActionSubmit(e) {
            e.preventDefault();
            toggleLoader('admin-memo-action-submit-button', true); // <-- [MODIFIED] Show loader

            const payload = {
                id: document.getElementById('action-memo-id').value,
                status: 'เสร็จสิ้น/รับไฟล์ไปใช้งาน',
                completedMemoFile: null,
                completedCommandFile: null,
                dispatchBookFile: null,
            };

            const memoFile = document.getElementById('completed-memo-file').files[0];
            const commandFile = document.getElementById('completed-command-file').files[0];
            const dispatchFile = document.getElementById('dispatch-book-file').files[0];
            
            try {
                if (memoFile) payload.completedMemoFile = await fileToObject(memoFile);
                if (commandFile) payload.completedCommandFile = await fileToObject(commandFile);
                if (dispatchFile) payload.dispatchBookFile = await fileToObject(dispatchFile);

                await apiCall('POST', 'updateMemoStatus', payload);
                showAlert('สำเร็จ', 'อัปเดตสถานะและอัปโหลดไฟล์เรียบร้อยแล้ว');
                document.getElementById('admin-memo-action-modal').style.display = 'none';
                e.target.reset();
                await fetchAllMemos();

            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถดำเนินการได้: ' + error.message);
            } finally {
                toggleLoader('admin-memo-action-submit-button', false); // <-- [MODIFIED] Hide loader
            }
        }
        
        async function handleDispatchFormSubmit(e) {
            e.preventDefault();
            const payload = {
                requestId: document.getElementById('dispatch-request-id').value,
                dispatchMonth: document.getElementById('dispatch-month').value,
                dispatchYear: document.getElementById('dispatch-year').value,
                memoCount: document.getElementById('dispatch-memo-count').value,
                commandCount: document.getElementById('dispatch-command-count').value,
            };
            try {
                const result = await apiCall('POST', 'generateDispatchBook', payload);
                document.getElementById('dispatch-modal').style.display = 'none';
                showAlert('สำเร็จ', `สร้างหนังสือส่งสำเร็จ!`);
                window.open(result.url, '_blank');
                await fetchAllRequestsForCommand();
            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถสร้างหนังสือส่งได้: ' + error.message);
            }
        }

        function renderStatsCard(elementId, title, data, type) {
            const container = document.getElementById(elementId);
            container.innerHTML = `<h3>${title}</h3>`;
            const list = document.createElement('div');
            list.className = 'mt-4';
            
            const sortedKeys = Object.keys(data).sort((a,b) => data[b] - data[a]);

            for (const key of sortedKeys) {
                const item = document.createElement('div');
                item.className = 'stat-item';
                item.innerHTML = `
                    <span class="text-gray-700">${key}</span>
                    <span class="font-bold text-indigo-600">${data[key]} ครั้ง</span>
                `;
                item.addEventListener('click', () => showStatsDetail(title, key, type));
                list.appendChild(item);
            }
            container.appendChild(list);
        }

    </script>

</body>
</html>
