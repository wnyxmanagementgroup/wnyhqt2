<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.15s ease-in-out; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .form-label { font-weight: bold; color: #374151; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        fieldset { border-color: #e5e7eb; }
        legend { background-color: #f3f4f6; padding: 0.25rem 1rem; border-radius: 9999px; font-weight: 700; color: #4f46e5; font-size: 1.125rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; padding: 0.6rem 1.25rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 0.75rem; }
        .nav-button.active { background-color: #e0e7ff; border: 2px solid #4f46e5; }
        .stat-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; }
        .stat-card h3 { font-size: 1.25rem; font-weight: 700; color: #111827; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.2s; }
        .stat-item:hover { background-color: #eff6ff; }
        .stat-item:last-child { border-bottom: none; }
        .tab-button { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .tab-button:not(.active) { background-color: #e0e7ff; color: #4f46e5; }
        .info-section { margin-top: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; background-color: #f9fafb; }
        .info-section h3 { font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 1rem; }
        .info-section ul { list-style-type: disc; margin-left: 1.5rem; }
        .info-section li { margin-bottom: 0.5rem; }
        .info-note { background-color: #fef3cd; border-left: 4px solid #f59e0b; padding: 0.75rem; margin-top: 1rem; border-radius: 0.375rem; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <!-- กล่องล็อกอินด้านบนสุด -->
        <div id="login-screen" class="max-w-4xl mx-auto mt-10">
            <!-- กล่องล็อกอิน -->
            <div class="p-8 rounded-2xl shadow-2xl main-container mb-6">
                <div class="text-center mb-8">
                    <img src="https://www.wny.ac.th/wny/storage/2025/03/Branner-WNY-Thai.png" alt="Logo" class="mx-auto h-28 mb-4">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WNY App ไปราชการ</h1>
                    <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="form-label">ชื่อผู้ใช้ (Username)</label>
                        <input type="text" id="username" class="form-input" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="form-label">รหัสผ่าน (Password)</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>
                    <button type="submit" id="login-button" class="btn btn-primary w-full text-lg">
                        <div id="login-loader" class="loader hidden"></div>
                        <span id="login-button-text">เข้าสู่ระบบ</span>
                    </button>
                    <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
                </form>
                <p class="text-center mt-4 text-sm text-gray-600">
                    ยังไม่มีบัญชี? <button type="button" id="show-register-modal-button" class="font-semibold text-indigo-600 hover:text-indigo-500">สมัครใช้งานที่นี่</button>
                </p>
            </div>
            
            <!-- กล่องข้อมูลประชาสัมพันธ์ 2 กล่องด้านล่าง -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- กล่องที่ 1: การขออนุญาตไปราชการ (เบิกค่าใช้จ่าย) -->
                <div class="info-section">
                    <h3 class="text-lg font-bold text-blue-700 mb-4">1. การขออนุญาตไปราชการ (เบิกค่าใช้จ่าย)</h3>
                    <p class="font-medium mb-2">เอกสารที่ต้องเตรียม:</p>
                    <ul class="list-disc pl-5 mb-2">
                        <li>ร่างบันทึกข้อความ และกดส่งร่างข้อความในระบบ</li> 
                        <p class="font-medium mb-2"></pclass>(ปริ้นส่ง 1 ชุด)</p>
                        <li>หนังสือราชการต้นเรื่อง</li>
                        <li>บันทึกขออนุญาตวิชาการ (กรณีที่มีนักเรียนไปด้วย)</li>
                    </ul>
                    <div class="info-note">
                        <p class="font-medium">กรณีที่นำนักเรียนไปพักค้างคืนส่งเอกสารเพิ่มเติม:</p> 
                         <span class="font-bold">ปริ้นส่ง 1 ชุด</span>
                        <ul class="list-disc pl-5 mt-1">
                            <li>หนังสือกำหนดการการเดินทาง</li>
                            <li>หนังสือขออนุญาตผู้ปกครอง</li>
                            <li>แผนที่การเดินทาง (Google map)</li>
                        </ul>
                    </div>
                </div>
                
                <!-- กล่องที่ 2: การขออนุญาตไปราชการ (ไม่เบิกค่าใช้จ่าย) -->
                <div class="info-section">
                    <h3 class="text-lg font-bold text-green-700 mb-4">2. การขออนุญาตไปราชการ (ไม่เบิกค่าใช้จ่าย)</h3>
                    <p class="font-medium mb-2">เอกสารที่ต้องเตรียม:</p>
                    <ul class="list-disc pl-5 mb-2">
                        <li>ร่างบันทึกข้อความ กดส่งร่างข้อความในระบบ (อัพโหลดไฟล์ที่เซ็นเสร็จแล้ว)</li>
                        <li>หนังสือราชการต้นเรื่อง</li>
                        <li>บันทึกขออนุญาตวิชาการ (กรณีที่มีนักเรียนไปด้วย)</li>
                    </ul>
                    <div class="info-note">
                        <p class="font-medium">กรณีที่นำนักเรียนไปพักค้างคืนส่งเอกสารเพิ่มเติม:</p> 
                        <span class="font-bold">ปริ้นส่ง 1 ชุด</span>
                        <ul class="list-disc pl-5 mt-1">
                            <li>หนังสือกำหนดการการเดินทาง</li>
                            <li>หนังสือขออนุญาตผู้ปกครอง</li>
                            <li>แผนที่การเดินทาง (Google map)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="main-app" class="hidden">
            <header class="p-4 bg-white rounded-xl shadow-lg mb-6 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">ยินดีต้อนรับ, <span id="user-fullname"></span></h2>
                    <p class="text-sm text-gray-500">ตำแหน่ง: <span id="user-position"></span></p>
                </div>
                <button id="logout-button" class="btn btn-danger">ออกจากระบบ</button>
            </header>

            <div id="navigation" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-6">
                <button data-target="dashboard-page" id="user-nav-dashboard" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition active">
                    <h3 class="font-bold text-indigo-700">แดชบอร์ด</h3>
                    <p class="text-xs text-gray-500">ภาพรวมของคุณ</p>
                </button>
                <button data-target="form-page" id="user-nav-form" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ร่างคำขอไปราชการ</h3>
                    <p class="text-xs text-gray-500">สร้างบันทึกข้อความ</p>
                </button>
                <button data-target="edit-page" id="nav-edit" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-orange-700">แก้ไขคำขอ</h3>
                    <p class="text-xs text-gray-500">แก้ไขคำขอไปราชการ</p>
                </button>
                 <button data-target="command-generation-page" id="admin-nav-command" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-purple-700">จัดการบันทึกและคำสั่ง</h3>
                    <p class="text-xs text-gray-500">สำหรับผู้ดูแลระบบ</p>
                </button>
                 <button data-target="stats-page" id="nav-stats" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-green-700">สถิติข้อมูล</h3>
                    <p class="text-xs text-gray-500">สรุปภาพรวม</p>
                </button>
                <button data-target="profile-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ข้อมูลส่วนตัว</h3>
                    <p class="text-xs text-gray-500">จัดการข้อมูลของคุณ</p>
                </button>
                <button id="admin-nav-users" data-target="admin-users-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการผู้ใช้</h3>
                    <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
                </button>
            </div>

            <main id="page-content" class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg">
                <!-- หน้าแดชบอร์ด -->
                <div id="dashboard-page" class="page-view">
                    <h2 class="text-2xl font-bold mb-4">รายการคำขอไปราชการของฉัน</h2>
                    <input type="text" id="search-requests" class="form-input mb-4" placeholder="ค้นหาตามวัตถุประสงค์, สถานที่, เลขอ้างอิง...">
                    <div id="requests-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                    </div>
                    <div id="requests-list" class="hidden"></div>
                    <p id="no-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบรายการคำขอของคุณ</p>
                </div>

                <!-- หน้าสร้างคำขอใหม่ -->
                <div id="form-page" class="page-view hidden">
                     <form id="request-form">
                          <input type="hidden" id="form-request-id">
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ข้อมูลทั่วไป</legend>
                                <div><label for="form-doc-date" class="form-label">วันที่</label><input type="date" id="form-doc-date" class="form-input" required></div>
                          </fieldset>
                         <fieldset class="border p-4 rounded-lg mb-6"><legend>1. รายละเอียดการไปราชการ</legend>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                   <div><label for="form-requester-name" class="form-label">ชื่อ-นามสกุลผู้ขอ</label><input type="text" id="form-requester-name" class="form-input" required></div>
                                   <div><label for="form-requester-position" class="form-label">ตำแหน่ง</label><input type="text" id="form-requester-position" class="form-input" required></div>
                              </div>
                             <div class="mt-4"><label for="form-location" class="form-label">ขออนุญาตไปราชการ ณ สถานที่</label><input type="text" id="form-location" class="form-input" required></div>
                             <div class="mt-4"><label for="form-purpose" class="form-label">เพื่อ</label><textarea id="form-purpose" rows="2" class="form-input" required></textarea></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                   <div><label for="form-start-date" class="form-label">ตั้งแต่วันที่</label><input type="date" id="form-start-date" class="form-input" required></div>
                                   <div><label for="form-end-date" class="form-label">ถึงวันที่</label><input type="date" id="form-end-date" class="form-input" required></div>
                              </div>
                         </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ผู้ร่วมเดินทาง (ถ้ามี)</legend>
                                <div id="form-attendees-list"></div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button type="button" id="form-add-attendee" class="btn btn-success w-full sm:w-auto"><span>+ เพิ่มผู้ร่วมเดินทาง</span></button>
                                    <button type="button" id="form-import-excel" class="btn btn-primary w-full sm:w-auto">
                                        <div id="import-excel-loader" class="loader hidden"></div>
                                        <span>นำเข้าจาก Excel</span>
                                    </button>
                                    <button type="button" id="form-download-template" class="btn bg-gray-500 text-white hover:bg-gray-600 w-full sm:w-auto"><span>ดาวน์โหลดแม่แบบ</span></button>
                                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                                </div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>2. การเบิกค่าใช้จ่าย</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="expense_no" name="expense_option" value="no" checked class="h-4 w-4"><label for="expense_no" class="ml-2">ไม่ขอเบิกค่าใช้จ่าย</label></div>
                                    <div><input type="radio" id="expense_partial" name="expense_option" value="partial" class="h-4 w-4"><label for="expense_partial" class="ml-2">ขอเบิกเฉพาะค่าใช้จ่าย</label></div>
                              </div>
                             <div id="partial-expense-options" class="pl-6 mt-3 hidden space-y-2">
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าเบี้ยเลี้ยง" data-item-name="ค่าเบี้ยเลี้ยง" class="rounded"> ค่าเบี้ยเลี้ยง</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าอาหาร" data-item-name="ค่าอาหาร" class="rounded"> ค่าอาหาร</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าที่พัก" data-item-name="ค่าที่พัก" class="rounded"> ค่าที่พัก</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าพาหนะ" data-item-name="ค่าพาหนะ" class="rounded"> ค่าพาหนะ</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าน้ำมัน" data-item-name="ค่าน้ำมัน" class="rounded"> ค่าน้ำมัน</label>
                                  <div class="flex items-center gap-2"><label><input type="checkbox" name="expense_item" id="expense_other_check" data-item-name="ค่าใช้จ่ายอื่นๆ" class="rounded"> ค่าใช้จ่ายอื่นๆ</label><input type="text" id="expense_other_text" class="form-input text-sm p-1 flex-grow" placeholder="ระบุ"></div>
                             </div>
                             <div id="total-expense-container" class="mt-4 hidden"><label for="form-total-expense" class="form-label">รวมเป็นจำนวนเงิน (บาท)</label><input type="number" id="form-total-expense" class="form-input w-full md:w-1/2" placeholder="0.00" step="0.01"></div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>3. การเดินทาง</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="vehicle_gov" name="vehicle_option" value="gov" checked class="h-4 w-4"><label for="vehicle_gov" class="ml-2">รถยนต์ราชการ (รถโรงเรียน)</label></div>
                                    <div><input type="radio" id="vehicle_private" name="vehicle_option" value="private" class="h-4 w-4"><label for="vehicle_private" class="ml-2">รถยนต์ส่วนตัว</label></div>
                                    <div id="private-vehicle-details" class="pl-8 mt-2 hidden"><label for="form-license-plate" class="form-label">หมายเลขทะเบียน</label><input type="text" id="form-license-plate" class="form-input w-full md:w-1/2"></div>
                                    <div><input type="radio" id="vehicle_public" name="vehicle_option" value="public" class="h-4 w-4"><label for="vehicle_public" class="ml-2">พาหนะอื่นๆ</label></div>
                              </div>
                         </fieldset>
                          <fieldset id="signer-fieldset" class="border p-4 rounded-lg mb-6"><legend>5. ข้อมูลผู้ลงนาม</legend>
                                <div class="mb-4">
                                    <label for="form-department" class="form-label">กลุ่มสาระฯ / งาน</label>
                                    <select id="form-department" class="form-input" required>
                                        <option value="">-- เลือกกลุ่มสาระ/งาน --</option>
                                        <option value="กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี">กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี</option>
                                        <option value="กลุ่มสาระการเรียนรู้คณิตศาสตร์">กลุ่มสาระการเรียนรู้คณิตศาสตร์</option>
                                        <option value="กลุ่มสาระการเรียนรู้ภาษาไทย">กลุ่มสาระการเรียนรู้ภาษาไทย</option>
                                        <option value="กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ">กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ</option>
                                        <option value="กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม">กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม</option>
                                        <option value="กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา">กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา</option>
                                        <option value="กลุ่มสาระการเรียนรู้ศิลปะ">กลุ่มสาระการเรียนรู้ศิลปะ</option>
                                        <option value="กลุ่มสาระการเรียนรู้การงานอาชีพ">กลุ่มสาระการเรียนรู้การงานอาชีพ</option>
                                        <option value="งานบริหารวิชาการ">งานบริหารวิชาการ</option>
                                        <option value="งานบริหารงบประมาณ">งานบริหารงบประมาณ</option>
                                        <option value="งานบริหารบุคคล">งานบริหารบุคคล</option>
                                        <option value="งานบริหารทั่วไป">งานบริหารทั่วไป</option>
                                    </select>
                                </div>
                                <div><label for="form-head-name" class="form-label">ชื่อหัวหน้ากลุ่มสาระ / หัวหน้างาน</label><input type="text" id="form-head-name" class="form-input bg-gray-200" readonly></div>
                         </fieldset>
                         <div class="text-center mt-10 border-t pt-6 border-gray-200">
                              <button type="submit" id="submit-request-button" class="btn btn-primary w-full sm:w-auto text-lg">
                                <div id="submit-loader" class="loader hidden"></div>
                                <span id="submit-button-text">บันทึกและสร้างเอกสาร</span>
                             </button>
                         </div>
                    </form>
                      <div id="form-result" class="hidden mt-6 p-6 text-center">
                          <h3 id="form-result-title" class="font-bold text-lg"></h3>
                          <p id="form-result-message" class="mt-2 text-gray-700"></p>
                            <div class="flex justify-center flex-wrap gap-4 mt-4">
                                <a id="form-result-link" href="#" target="_blank" class="btn btn-success">เปิดไฟล์ PDF</a>
                             </div>
                      </div>
                </div>

                <!-- หน้าแก้ไขคำขอ -->
                <div id="edit-page" class="page-view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">แก้ไขคำขอไปราชการ</h2>
                        <button id="back-to-dashboard" class="btn bg-gray-500 text-white">← กลับสู่แดชบอร์ด</button>
                    </div>
                    
                    <form id="edit-request-form">
                        <input type="hidden" id="edit-draft-id">
                        <input type="hidden" id="edit-request-id">
                        
                        <fieldset class="border p-4 rounded-lg mb-6">
                            <legend>ข้อมูลทั่วไป</legend>
                            <div>
                                <label for="edit-doc-date" class="form-label">วันที่</label>
                                <input type="date" id="edit-doc-date" class="form-input" required>
                            </div>
                        </fieldset>
                        
                        <fieldset class="border p-4 rounded-lg mb-6">
                            <legend>1. รายละเอียดการไปราชการ</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="edit-requester-name" class="form-label">ชื่อ-นามสกุลผู้ขอ</label>
                                    <input type="text" id="edit-requester-name" class="form-input" required>
                                </div>
                                <div>
                                    <label for="edit-requester-position" class="form-label">ตำแหน่ง</label>
                                    <input type="text" id="edit-requester-position" class="form-input" required>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="edit-location" class="form-label">ขออนุญาตไปราชการ ณ สถานที่</label>
                                <input type="text" id="edit-location" class="form-input" required>
                            </div>
                            <div class="mt-4">
                                <label for="edit-purpose" class="form-label">เพื่อ</label>
                                <textarea id="edit-purpose" rows="2" class="form-input" required></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="edit-start-date" class="form-label">ตั้งแต่วันที่</label>
                                    <input type="date" id="edit-start-date" class="form-input" required>
                                </div>
                                <div>
                                    <label for="edit-end-date" class="form-label">ถึงวันที่</label>
                                    <input type="date" id="edit-end-date" class="form-input" required>
                                </div>
                            </div>
                        </fieldset>
                        
                        <fieldset class="border p-4 rounded-lg mb-6">
                            <legend>ผู้ร่วมเดินทาง (ถ้ามี)</legend>
                            <div id="edit-attendees-list"></div>
                            <div class="flex flex-wrap gap-2 mt-4">
                                <button type="button" id="edit-add-attendee" class="btn btn-success w-full sm:w-auto">
                                    <span>+ เพิ่มผู้ร่วมเดินทาง</span>
                                </button>
                            </div>
                        </fieldset>
                        
                        <fieldset class="border p-4 rounded-lg mb-6">
                            <legend>2. การเบิกค่าใช้จ่าย</legend>
                            <div class="space-y-3">
                                <div><input type="radio" id="edit-expense_no" name="edit-expense_option" value="no" checked class="h-4 w-4"><label for="edit-expense_no" class="ml-2">ไม่ขอเบิกค่าใช้จ่าย</label></div>
                                <div><input type="radio" id="edit-expense_partial" name="edit-expense_option" value="partial" class="h-4 w-4"><label for="edit-expense_partial" class="ml-2">ขอเบิกเฉพาะค่าใช้จ่าย</label></div>
                            </div>
                            <div id="edit-partial-expense-options" class="pl-6 mt-3 hidden space-y-2">
                                <label class="block"><input type="checkbox" name="edit-expense_item" value="ค่าเบี้ยเลี้ยง" data-item-name="ค่าเบี้ยเลี้ยง" class="rounded"> ค่าเบี้ยเลี้ยง</label>
                                <label class="block"><input type="checkbox" name="edit-expense_item" value="ค่าอาหาร" data-item-name="ค่าอาหาร" class="rounded"> ค่าอาหาร</label>
                                <label class="block"><input type="checkbox" name="edit-expense_item" value="ค่าที่พัก" data-item-name="ค่าที่พัก" class="rounded"> ค่าที่พัก</label>
                                <label class="block"><input type="checkbox" name="edit-expense_item" value="ค่าพาหนะ" data-item-name="ค่าพาหนะ" class="rounded"> ค่าพาหนะ</label>
                                <label class="block"><input type="checkbox" name="edit-expense_item" value="ค่าน้ำมัน" data-item-name="ค่าน้ำมัน" class="rounded"> ค่าน้ำมัน</label>
                                <div class="flex items-center gap-2"><label><input type="checkbox" name="edit-expense_item" id="edit-expense_other_check" data-item-name="ค่าใช้จ่ายอื่นๆ" class="rounded"> ค่าใช้จ่ายอื่นๆ</label><input type="text" id="edit-expense_other_text" class="form-input text-sm p-1 flex-grow" placeholder="ระบุ"></div>
                            </div>
                            <div id="edit-total-expense-container" class="mt-4 hidden"><label for="edit-total-expense" class="form-label">รวมเป็นจำนวนเงิน (บาท)</label><input type="number" id="edit-total-expense" class="form-input w-full md:w-1/2" placeholder="0.00" step="0.01"></div>
                        </fieldset>
                        
                        <fieldset class="border p-4 rounded-lg mb-6">
                            <legend>3. การเดินทาง</legend>
                            <div class="space-y-3">
                                <div><input type="radio" id="edit-vehicle_gov" name="edit-vehicle_option" value="gov" checked class="h-4 w-4"><label for="edit-vehicle_gov" class="ml-2">รถยนต์ราชการ (รถโรงเรียน)</label></div>
                                <div><input type="radio" id="edit-vehicle_private" name="edit-vehicle_option" value="private" class="h-4 w-4"><label for="edit-vehicle_private" class="ml-2">รถยนต์ส่วนตัว</label></div>
                                <div id="edit-private-vehicle-details" class="pl-8 mt-2 hidden"><label for="edit-license-plate" class="form-label">หมายเลขทะเบียน</label><input type="text" id="edit-license-plate" class="form-input w-full md:w-1/2"></div>
                                <div><input type="radio" id="edit-vehicle_public" name="edit-vehicle_option" value="public" class="h-4 w-4"><label for="edit-vehicle_public" class="ml-2">พาหนะอื่นๆ</label></div>
                            </div>
                        </fieldset>
                        
                        <!-- แก้ไข: เปลี่ยน ID ให้ไม่ซ้ำกับฟอร์มหลัก -->
                        <fieldset class="border p-4 rounded-lg mb-6">
                            <legend>5. ข้อมูลผู้ลงนาม</legend>
                            <div class="mb-4">
                                <label for="edit-department" class="form-label">กลุ่มสาระฯ / งาน</label>
                                <select id="edit-department" class="form-input" required>
                                    <option value="">-- เลือกกลุ่มสาระ/งาน --</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี">กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี</option>
                                    <option value="รองหัวหน้ากลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี">รองกลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้คณิตศาสตร์">กลุ่มสาระการเรียนรู้คณิตศาสตร์</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้ภาษาไทย">กลุ่มสาระการเรียนรู้ภาษาไทย</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้ภาษาต่างประเทศ">กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม">กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา">กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้ศิลปะ">กลุ่มสาระการเรียนรู้ศิลปะ</option>
                                    <option value="หัวหน้ากลุ่มสาระการเรียนรู้การงานอาชีพ">กลุ่มสาระการเรียนรู้การงานอาชีพ</option>
                                    <option value="หัวหน้ากลุ่มบริหารวิชาการ">งานบริหารวิชาการ</option>
                                    <option value="รองผู้อำนวยการกลุ่มงานบริหารงบประมาณ">งานบริหารงบประมาณ</option>
                                    <option value="รองผู้อำนวยการกลุ่มบริหารงานบุคคล">งานบริหารบุคคล</option>
                                    <option value="รองผู้อำนวยการกลุ่มบริหารทั่วไป">งานบริหารทั่วไป</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-head-name" class="form-label">ชื่อหัวหน้ากลุ่มสาระ / หัวหน้างาน</label>
                                <input type="text" id="edit-head-name" class="form-input bg-gray-200" readonly>
                            </div>
                        </fieldset>
                        
                        <div class="flex justify-center gap-4 mt-10 border-t pt-6 border-gray-200">
                            <button type="button" id="save-draft-button" class="btn bg-yellow-500 text-white text-lg">
                                <div id="save-draft-loader" class="loader hidden"></div>
                                <span id="save-draft-button-text">บันทึกข้อมูลคำขอ</span>
                            </button>
                            <button type="button" id="generate-document-button" class="btn btn-primary text-lg">
                                <div id="generate-doc-loader" class="loader hidden"></div>
                                <span id="generate-doc-button-text">บันทึกและสร้างเอกสาร</span>
                            </button>
                        </div>
                    </form>
                    
                    <div id="edit-result" class="hidden mt-6 p-6 text-center">
                        <h3 id="edit-result-title" class="font-bold text-lg"></h3>
                        <p id="edit-result-message" class="mt-2 text-gray-700"></p>
                        <div class="flex justify-center flex-wrap gap-4 mt-4">
                            <a id="edit-result-link" href="#" target="_blank" class="btn btn-success">เปิดไฟล์ PDF</a>
                        </div>
                    </div>
                </div>

                <!-- หน้าโปรไฟล์ -->
                <div id="profile-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">ข้อมูลส่วนตัว</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- แก้ไขข้อมูลส่วนตัว -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4">แก้ไขข้อมูลส่วนตัว</h3>
                            <form id="profile-form">
                                <div class="mb-4">
                                    <label for="profile-username" class="form-label">ชื่อผู้ใช้</label>
                                    <input type="text" id="profile-username" class="form-input bg-gray-200" readonly>
                                </div>
                                <div class="mb-4">
                                    <label for="profile-fullname" class="form-label">ชื่อ-นามสกุล</label>
                                    <input type="text" id="profile-fullname" class="form-input" required>
                                </div>
                                <div class="mb-4">
                                    <label for="profile-position" class="form-label">ตำแหน่ง</label>
                                    <input type="text" id="profile-position" class="form-input" required>
                                </div>
                                <div class="mb-4">
                                    <label for="profile-department" class="form-label">กลุ่มสาระ/งาน</label>
                                    <input type="text" id="profile-department" class="form-input" required>
                                </div>
                                <button type="submit" id="profile-submit-button" class="btn btn-primary w-full">
                                    <div id="profile-loader" class="loader hidden"></div>
                                    <span>อัพเดทข้อมูล</span>
                                </button>
                            </form>
                        </div>
                        
                        <!-- เปลี่ยนรหัสผ่าน -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4">เปลี่ยนรหัสผ่าน</h3>
                            <form id="password-form">
                                <div class="mb-4">
                                    <label for="current-password" class="form-label">รหัสผ่านปัจจุบัน</label>
                                    <input type="password" id="current-password" class="form-input" required>
                                </div>
                                <div class="mb-4">
                                    <label for="new-password" class="form-label">รหัสผ่านใหม่</label>
                                    <input type="password" id="new-password" class="form-input" required>
                                </div>
                                <div class="mb-4 flex items-center">
                                    <input type="checkbox" id="show-password-toggle" class="h-4 w-4">
                                    <label for="show-password-toggle" class="ml-2 text-sm">แสดงรหัสผ่าน</label>
                                </div>
                                <button type="submit" id="password-submit-button" class="btn btn-primary w-full">
                                    <div id="password-loader" class="loader hidden"></div>
                                    <span>เปลี่ยนรหัสผ่าน</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- หน้าจัดการผู้ใช้ (Admin) -->
                <div id="admin-users-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">จัดการผู้ใช้</h2>
                    
                    <div class="mb-6 flex flex-wrap gap-4">
                        <button id="add-user-button" class="btn btn-primary">เพิ่มผู้ใช้</button>
                        <button id="download-user-template-button" class="btn bg-green-500 text-white">ดาวน์โหลดแม่แบบ</button>
                        <button id="import-users-button" class="btn bg-blue-500 text-white">นำเข้าจาก Excel</button>
                        <input type="file" id="user-excel-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                    
                    <div id="users-list" class="bg-white rounded-lg shadow">
                        <div class="p-4 border-b">
                            <h3 class="font-bold">รายชื่อผู้ใช้ทั้งหมด</h3>
                        </div>
                        <div id="users-content" class="p-4">
                            <div class="text-center p-8">
                                <div class="loader mx-auto"></div>
                                <p class="mt-4">กำลังโหลดข้อมูลผู้ใช้...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- หน้าจัดการคำสั่ง (Admin) -->
                <div id="command-generation-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">จัดการบันทึกและคำสั่ง</h2>
                    
                    <div class="flex gap-4 mb-6">
                        <button id="admin-view-requests-tab" class="tab-button active">คำขอไปราชการ</button>
                        <button id="admin-view-memos-tab" class="tab-button">บันทึกข้อความ</button>
                    </div>
                    
                    <!-- คำขอไปราชการ -->
                    <div id="admin-requests-view">
                        <div class="mb-4">
                            <input type="text" id="admin-search-requests" class="form-input" placeholder="ค้นหาคำขอ...">
                        </div>
                        <div id="admin-requests-list" class="space-y-4">
                            <div class="text-center p-8">
                                <div class="loader mx-auto"></div>
                                <p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- บันทึกข้อความ -->
                    <div id="admin-memos-view" class="hidden">
                        <div class="mb-4">
                            <input type="text" id="admin-search-memos" class="form-input" placeholder="ค้นหาบันทึกข้อความ...">
                        </div>
                        <div id="admin-memos-list" class="space-y-4">
                            <div class="text-center p-8">
                                <div class="loader mx-auto"></div>
                                <p class="mt-4">กำลังโหลดข้อมูลบันทึกข้อความ...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- หน้าสถิติ -->
<div id="stats-page" class="page-view hidden">
    <h2 class="text-2xl font-bold mb-6">สถิติข้อมูล</h2>
    
    <div class="mb-6 flex flex-wrap gap-4">
        <button id="refresh-stats" class="btn btn-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            รีเฟรชข้อมูล
        </button>
        <button id="export-stats" class="btn bg-green-500 text-white">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            ส่งออกรายงาน
        </button>
    </div>

    <div id="stats-overview" class="space-y-6">
        <div class="text-center p-8">
            <div class="loader mx-auto"></div>
            <p class="mt-4">กำลังโหลดสถิติ...</p>
        </div>
    </div>

    <!-- กราฟสถิติ (สามารถเพิ่มในอนาคต) -->
    <div id="stats-charts" class="mt-8 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-800">กราฟสถิติคำขอ</h3>
                <canvas id="requests-chart" width="400" height="200"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-800">กราฟสถานะคำขอ</h3>
                <canvas id="status-chart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            <p>จัดทำโดยกลุ่มบริหารงานบุคคล โรงเรียนวังน้ำเย็นวิทยาคม </p>
            <p>พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี </p>
        </footer>
    </div>

    <!-- Modal ลงทะเบียน -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ลงทะเบียนผู้ใช้ใหม่</h3>
                <button id="register-modal-close-button" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <form id="register-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="register-username" class="form-label">ชื่อผู้ใช้</label>
                        <input type="text" id="register-username" class="form-input" required>
                    </div>
                    <div>
                        <label for="register-password" class="form-label">รหัสผ่าน</label>
                        <input type="password" id="register-password" class="form-input" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="register-fullname" class="form-label">ชื่อ-นามสกุล</label>
                    <input type="text" id="register-fullname" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="register-position" class="form-label">ตำแหน่ง</label>
                    <input type="text" id="register-position" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="register-department" class="form-label">กลุ่มสาระ/งาน</label>
                    <input type="text" id="register-department" class="form-input" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="register-modal-close-button2" class="btn bg-gray-500 text-white">ยกเลิก</button>
                    <button type="submit" id="register-submit-button" class="btn btn-primary">
                        <div id="register-loader" class="loader hidden"></div>
                        <span>ลงทะเบียน</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal แจ้งเตือน -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="alert-modal-title" class="text-xl font-bold">แจ้งเตือน</h3>
                <button id="alert-modal-close-button" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <p id="alert-modal-message" class="mb-6"></p>
            <div class="flex justify-end">
                <button id="alert-modal-ok-button" class="btn btn-primary">ตกลง</button>
            </div>
        </div>
    </div>

    <!-- Modal ยืนยัน -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="confirm-modal-title" class="text-xl font-bold">ยืนยันการดำเนินการ</h3>
                <button id="confirm-modal-close-button" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <p id="confirm-modal-message" class="mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-no-button" class="btn bg-gray-500 text-white">ไม่</button>
                <button id="confirm-modal-yes-button" class="btn btn-primary">ใช่</button>
            </div>
        </div>
    </div>

    <!-- Modal ส่งบันทึกข้อความ -->
    <div id="send-memo-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ส่งบันทึกข้อความ</h3>
                <button id="send-memo-modal-close-button" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <form id="send-memo-form">
                <input type="hidden" id="memo-modal-request-id">
                <div class="mb-4">
                    <label class="form-label">ประเภทบันทึกข้อความ</label>
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="memo_type_reimburse" name="modal_memo_type" value="reimburse" class="h-4 w-4">
                            <label for="memo_type_reimburse" class="ml-2">เบิกค่าใช้จ่าย</label>
                        </div>
                        <div>
                            <input type="radio" id="memo_type_non_reimburse" name="modal_memo_type" value="non_reimburse" class="h-4 w-4" checked>
                            <label for="memo_type_non_reimburse" class="ml-2">ไม่เบิกค่าใช้จ่าย</label>
                        </div>
                    </div>
                </div>
                <div id="modal-memo-file-container" class="mb-4">
                    <label for="modal-memo-file" class="form-label">ไฟล์บันทึกข้อความ</label>
                    <input type="file" id="modal-memo-file" class="form-input" accept=".pdf,.doc,.docx">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="send-memo-cancel-button" class="btn bg-gray-500 text-white">ยกเลิก</button>
                    <button type="submit" id="send-memo-submit-button" class="btn btn-primary">
                        <div id="send-memo-loader" class="loader hidden"></div>
                        <span>ส่งบันทึกข้อความ</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal อนุมัติคำสั่ง -->
    <div id="command-approval-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">อนุมัติคำสั่งไปราชการ</h3>
                <button id="command-approval-modal-close-button" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <form id="command-approval-form">
                <input type="hidden" id="command-request-id">
                <div class="mb-4">
                    <label class="form-label">เลือกรูปแบบคำสั่ง</label>
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="command_type_solo" name="command_type" value="solo" class="h-4 w-4">
                            <label for="command_type_solo" class="ml-2">คำสั่งเดี่ยว (1 คน)</label>
                        </div>
                        <div>
                            <input type="radio" id="command_type_group_small" name="command_type" value="groupSmall" class="h-4 w-4">
                            <label for="command_type_group_small" class="ml-2">คำสั่งกลุ่มเล็ก (2-5 คน)</label>
                        </div>
                        <div>
                            <input type="radio" id="command_type_group_large" name="command_type" value="groupLarge" class="h-4 w-4">
                            <label for="command_type_group_large" class="ml-2">คำสั่งกลุ่มใหญ่ (6 คนขึ้นไป)</label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="command-approval-cancel-button" class="btn bg-gray-500 text-white">ยกเลิก</button>
                    <button type="submit" id="command-approval-submit-button" class="btn btn-primary">
                        <div id="command-approval-loader" class="loader hidden"></div>
                        <span>อนุมัติคำสั่ง</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal ส่งหนังสือส่ง -->
    <div id="dispatch-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">สร้างหนังสือส่ง</h3>
                <button id="dispatch-modal-close-button" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <form id="dispatch-form">
                <input type="hidden" id="dispatch-request-id">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="dispatch-month" class="form-label">เดือน</label>
                        <select id="dispatch-month" class="form-input" required>
                            <option value="">-- เลือกเดือน --</option>
                            <option value="มกราคม">มกราคม</option>
                            <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                            <option value="มีนาคม">มีนาคม</option>
                            <option value="เมษายน">เมษายน</option>
                            <option value="พฤษภาคม">พฤษภาคม</option>
                            <option value="มิถุนายน">มิถุนายน</option>
                            <option value="กรกฎาคม">กรกฎาคม</option>
                            <option value="สิงหาคม">สิงหาคม</option>
                            <option value="กันยายน">กันยายน</option>
                            <option value="ตุลาคม">ตุลาคม</option>
                            <option value="พฤศจิกายน">พฤศจิกายน</option>
                            <option value="ธันวาคม">ธันวาคม</option>
                        </select>
                    </div>
                    <div>
                        <label for="dispatch-year" class="form-label">ปี พ.ศ.</label>
                        <input type="number" id="dispatch-year" class="form-input" min="2560" max="2580" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="command-count" class="form-label">จำนวนคำสั่ง</label>
                        <input type="number" id="command-count" class="form-input" min="0" required>
                    </div>
                    <div>
                        <label for="memo-count" class="form-label">จำนวนบันทึก</label>
                        <input type="number" id="memo-count" class="form-input" min="0" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="dispatch-cancel-button" class="btn bg-gray-500 text-white">ยกเลิก</button>
                    <button type="submit" id="dispatch-submit-button" class="btn btn-primary">
                        <div id="dispatch-loader" class="loader hidden"></div>
                        <span>สร้างหนังสือส่ง</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal อัพโหลดไฟล์ให้ผู้ใช้ -->
    <div id="admin-memo-action-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">จัดการบันทึกข้อความ</h3>
                <button id="admin-memo-action-modal-close-button" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <form id="admin-memo-action-form">
                <input type="hidden" id="admin-memo-id">
                <div class="mb-4">
                    <label for="admin-memo-status" class="form-label">สถานะ</label>
                    <select id="admin-memo-status" class="form-input" required>
                        <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                        <option value="รอเอกสาร (เบิก)">รอเอกสาร (เบิก)</option>
                        <option value="เสร็จสิ้นรอออกคำสั่งไปราชการ">เสร็จสิ้นรอออกคำสั่งไปราชการ</option>
                        <option value="นำกลับไปแก้ไข">นำกลับไปแก้ไข</option>
                        <option value="เสร็จสิ้น/รับไฟล์ไปใช้งาน">เสร็จสิ้น/รับไฟล์ไปใช้งาน</option>
                    </select>
                </div>
                
                <div id="admin-file-uploads" class="space-y-4 hidden">
                    <div>
                        <label class="form-label">ไฟล์บันทึกข้อความที่สมบูรณ์</label>
                        <input type="file" id="admin-completed-memo-file" class="form-input" accept=".pdf,.doc,.docx">
                    </div>
                    <div>
                        <label class="form-label">ไฟล์คำสั่งที่สมบูรณ์</label>
                        <input type="file" id="admin-completed-command-file" class="form-input" accept=".pdf,.doc,.docx">
                    </div>
                    <div>
                        <label class="form-label">ไฟล์หนังสือส่ง</label>
                        <input type="file" id="admin-dispatch-book-file" class="form-input" accept=".pdf,.doc,.docx">
                    </div>
                </div>
                
                <div class="flex justify-end gap-4">
                    <button type="button" id="admin-memo-cancel-button" class="btn bg-gray-500 text-white">ยกเลิก</button>
                    <button type="submit" id="admin-memo-submit-button" class="btn btn-primary">
                        <div id="admin-memo-loader" class="loader hidden"></div>
                        <span>อัพเดทสถานะ</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ใช้ URL ของ Google Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxq8fkHgDOyYjpZgy4dngT8n-Z3zSBjfJ0R7lomuUxoI63vqpdOP-7nlodlV-BsXnksaA/exec";

        // Global State
        let allRequestsCache = [];
        let allMemosCache = [];
        let userMemosCache = [];
        let allUsersCache = [];
        let specialPositionMap = {
            'รองผู้อำนวยการกลุ่มบริหารทั่วไป':'นางวชิรินทรา พัฒนกุลเดช',
            'รองผู้อำนวยการกลุ่มบริหารงานบุคคล':'นางปณิชา ภัสสิรากุล',
            'รองผู้อำนวยการกลุ่มบริหารงบประมาณ':'นางจันทิมา นกอยู่',
            'หัวหน้ากลุ่มบริหารวิชาการ': 'นายมงคล เกตมณี',
            'หัวหน้ากลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี': 'นางสาวปิยราช พันธุ์กมลศิลป์',
            'รองหัวหน้ากลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี':'นายอำนาจ ทัศนา',
            'หัวหน้ากลุ่มสาระการเรียนรู้คณิตศาสตร์': 'นายสมฤทธิ์ ชาญสมร',
            'หัวหน้ากลุ่มสาระการเรียนรู้ภาษาไทย': 'นายอานนท์ วรวงค์',
            'หัวหน้ากลุ่มสาระการเรียนรู้ภาษาต่างประเทศ': 'นางธรรมรักษ์ วัฒนพลาชัยกูร',
            'หัวหน้ากลุ่มสาระการเรียนรู้สังคมศึกษาฯ': 'นางเกศริน ทองโพธิกุล',
            'หัวหน้ากลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา': 'นางสาวเกษร เขจรลาภ',
            'หัวหน้ากลุ่มสาระการเรียนรู้ศิลปะ': 'นางสาวปิยลักษณ์ ขันทา',
            'หัวหน้ากลุ่มสาระการเรียนรู้การงานอาชีพ': 'นายสุชาติ สินทร',
            'หัวหน้างานแนะแนว':'นายเริงศักดิ์ จันทร์นวล',
        };

       const statusTranslations = {
    'Pending': 'กำลังดำเนินการ',
    'Submitted': 'รอการตรวจสอบ',
    'Approved': 'เสร็จสิ้น',
    'Pending Approval': 'รอการตรวจสอบ',
    'เสร็จสิ้น/รับไฟล์ไปใช้งาน': 'เสร็จสิ้น',
    'เสร็จสิ้น': 'เสร็จสิ้น',
    'รอเอกสาร (เบิก)': 'รอเอกสาร (เบิก)',
    'นำกลับไปแก้ไข': 'นำกลับไปแก้ไข',
    'เสร็จสิ้นรอออกคำสั่งไปราชการ': 'เสร็จสิ้นรอออกคำสั่ง',
    'รอตรวจสอบและออกคำสั่งไปราชการ': 'รอตรวจสอบและออกคำสั่ง',
    'กำลังดำเนินการ': 'กำลังดำเนินการ'
};

function translateStatus(status) {
    return statusTranslations[status] || status;
}

        // --- API HELPER FUNCTIONS ---
        
        async function apiCall(method, action, payload = {}) {
            let url = SCRIPT_URL;
            const options = {
                method: method,
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8', },
            };

            if (method === 'GET') {
                const params = new URLSearchParams({ action, ...payload, cacheBust: new Date().getTime() }); 
                url += `?${params}`;
            } else {
                options.body = JSON.stringify({ action, payload });
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                
                if (error.message.includes('Failed to fetch')) {
                    showAlert('การเชื่อมต่อล้มเหลว', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
                } else {
                    showAlert('เกิดข้อผิดพลาด', `Server error: ${error.message}`);
                }
                throw error;
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        
        function showAlert(title, message) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal').style.display = 'flex';
        }
        
        function showConfirm(title, message) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            document.getElementById('confirm-modal').style.display = 'flex';

            return new Promise((resolve) => {
                const yesButton = document.getElementById('confirm-modal-yes-button');
                const noButton = document.getElementById('confirm-modal-no-button');
                const onYes = () => { cleanup(); resolve(true); };
                const onNo = () => { cleanup(); resolve(false); };
                
                const cleanup = () => {
                    document.getElementById('confirm-modal').style.display = 'none';
                    yesButton.removeEventListener('click', onYes);
                    noButton.removeEventListener('click', onNo);
                };

                yesButton.addEventListener('click', onYes, { once: true });
                noButton.addEventListener('click', onNo, { once: true });
            });
        }
        
        function toggleLoader(buttonId, show) {
            const button = document.getElementById(buttonId);
            if (!button) {
                console.error(`Button with id '${buttonId}' not found`);
                return;
            }
            
            const loader = button.querySelector('.loader');
            const text = button.querySelector('span');
            
            if (show) {
                if (loader) loader.classList.remove('hidden');
                if (text) text.classList.add('hidden');
                button.disabled = true;
            } else {
                if (loader) loader.classList.add('hidden');
                if (text) text.classList.remove('hidden');
                button.disabled = false;
            }
        }
        
        function getCurrentUser() {
            const userJson = sessionStorage.getItem('currentUser');
            return userJson ? JSON.parse(userJson) : null;
        }

        function fileToObject(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const data = reader.result.toString().split(',')[1];
                    resolve({ filename: file.name, mimeType: file.type, data: data });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function formatDisplayDate(dateString) {
            if (!dateString) return 'ไม่ระบุ';
            try {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('th-TH', options);
            } catch (e) {
                return 'ไม่ระบุ';
            }
        }

        function clearRequestsCache() {
            allRequestsCache = [];
            allMemosCache = [];
            userMemosCache = [];
        }

        function checkAdminAccess() {
            const user = getCurrentUser();
            return user && user.role === 'admin';
        }

        async function loadSpecialPositions() {
            return new Promise(resolve => {
                // ใช้ข้อมูล static ที่มีอยู่แล้ว
                // สามารถเพิ่มการโหลดจาก API ได้ในอนาคต
                console.log('Special positions loaded:', Object.keys(specialPositionMap).length);
                resolve();
            });
        }
        
        // --- PAGE NAVIGATION ---
        
        async function switchPage(targetPageId) {
            document.querySelectorAll('.page-view').forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(targetPageId);
            if (targetPage) {
                 targetPage.classList.remove('hidden');
            }

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.target === targetPageId) {
                    btn.classList.add('active');
                }
            });

            if (targetPageId === 'form-page') await resetRequestForm();
            if (targetPageId === 'dashboard-page') await fetchUserRequests();
            if (targetPageId === 'profile-page') loadProfileData();
            if (targetPageId === 'stats-page') await loadStatsData();
            if (targetPageId === 'admin-users-page') await fetchAllUsers();
            if (targetPageId === 'command-generation-page') {
                document.getElementById('admin-view-requests-tab').click();
            }
        }

        // --- AUTH FUNCTIONS ---

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showAlert('ผิดพลาด', 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน');
                return;
            }

            toggleLoader('login-button', true);
            document.getElementById('login-error').classList.add('hidden');
            
            try {
                console.log('Attempting login for:', username);
                const result = await apiCall('POST', 'verifyCredentials', { 
                    username: username, 
                    password: password 
                });
                
                console.log('Login result:', result);
                
                if (result.status === 'success') {
                    sessionStorage.setItem('currentUser', JSON.stringify(result.user));
                    initializeUserSession(result.user);
                    showMainApp();
                    switchPage('dashboard-page');
                    await fetchUserRequests();
                    showAlert('สำเร็จ', 'เข้าสู่ระบบสำเร็จ');
                } else {
                    document.getElementById('login-error').textContent = result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('login-error').textContent = 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ: ' + error.message;
                document.getElementById('login-error').classList.remove('hidden');
            } finally {
                toggleLoader('login-button', false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('register-username').value.trim(),
                password: document.getElementById('register-password').value,
                fullName: document.getElementById('register-fullname').value.trim(),
                position: document.getElementById('register-position').value.trim(),
                department: document.getElementById('register-department').value.trim(),
                role: 'user'
            };

            if (!formData.username || !formData.password || !formData.fullName) {
                showAlert('ผิดพลาด', 'กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            toggleLoader('register-submit-button', true);

            try {
                const result = await apiCall('POST', 'registerUser', formData);
                
                if (result.status === 'success') {
                    showAlert('สำเร็จ', 'ลงทะเบียนสำเร็จ! กรุณาเข้าสู่ระบบ');
                    document.getElementById('register-modal').style.display = 'none';
                    document.getElementById('register-form').reset();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการลงทะเบียน: ' + error.message);
            } finally {
                toggleLoader('register-submit-button', false);
            }
        }

        // --- MAIN APP LOGIC ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log('App Initializing with Google Sheets Backend...');
            setupEventListeners();
            const user = getCurrentUser();
            if (user) {
                initializeUserSession(user);
            } else {
                showLoginScreen();
            }
        });

        // --- INITIALIZATION ---
        
        function initializeUserSession(user) {
            updateUIForUser(user);
            showMainApp();
            switchPage('dashboard-page');
        }

        function updateUIForUser(user) {
            document.getElementById('user-fullname').textContent = user.fullName || 'N/A';
            document.getElementById('user-position').textContent = user.position || 'N/A';

            const isAdmin = user.role === 'admin';
            document.getElementById('admin-nav-command').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-nav-users').classList.toggle('hidden', !isAdmin);
        }
        
        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }
        
        function showLoginScreen() {
            sessionStorage.removeItem('currentUser');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // --- EVENT LISTENER SETUP ---
        
        function setupEventListeners() {
            // Auth
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', showLoginScreen);
            document.getElementById('show-register-modal-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'flex');
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            // Stats page events
            document.getElementById('refresh-stats').addEventListener('click', async () => {
            await loadStatsData();
            showAlert('สำเร็จ', 'อัพเดทข้อมูลสถิติเรียบร้อยแล้ว');
            });

            document.getElementById('export-stats').addEventListener('click', exportStatsReport);

            // Navigation
            document.getElementById('navigation').addEventListener('click', (e) => {
                const navButton = e.target.closest('.nav-button');
                if (navButton && navButton.dataset.target) {
                    switchPage(navButton.dataset.target);
                }
            });

            // Modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            });
            document.getElementById('register-modal-close-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'none');
            document.getElementById('register-modal-close-button2').addEventListener('click', () => document.getElementById('register-modal').style.display = 'none');
            document.getElementById('alert-modal-close-button').addEventListener('click', () => document.getElementById('alert-modal').style.display = 'none');
            document.getElementById('alert-modal-ok-button').addEventListener('click', () => document.getElementById('alert-modal').style.display = 'none');
            document.getElementById('confirm-modal-close-button').addEventListener('click', () => document.getElementById('confirm-modal').style.display = 'none');
            document.getElementById('send-memo-modal-close-button').addEventListener('click', () => document.getElementById('send-memo-modal').style.display = 'none');
            document.getElementById('send-memo-cancel-button').addEventListener('click', () => document.getElementById('send-memo-modal').style.display = 'none');

            // Modal Event Listeners ใหม่
            document.getElementById('command-approval-form').addEventListener('submit', handleCommandApproval);
            document.getElementById('command-approval-modal-close-button').addEventListener('click', () => document.getElementById('command-approval-modal').style.display = 'none');
            document.getElementById('command-approval-cancel-button').addEventListener('click', () => document.getElementById('command-approval-modal').style.display = 'none');
            
            document.getElementById('dispatch-form').addEventListener('submit', handleDispatchFormSubmit);
            document.getElementById('dispatch-modal-close-button').addEventListener('click', () => document.getElementById('dispatch-modal').style.display = 'none');
            document.getElementById('dispatch-cancel-button').addEventListener('click', () => document.getElementById('dispatch-modal').style.display = 'none');
            
            document.getElementById('admin-memo-action-form').addEventListener('submit', handleAdminMemoActionSubmit);
            document.getElementById('admin-memo-action-modal-close-button').addEventListener('click', () => document.getElementById('admin-memo-action-modal').style.display = 'none');
            document.getElementById('admin-memo-cancel-button').addEventListener('click', () => document.getElementById('admin-memo-action-modal').style.display = 'none');
            
            // Event listener สำหรับแสดง/ซ่อนส่วนอัพโหลดไฟล์
            document.getElementById('admin-memo-status').addEventListener('change', function(e) {
                const fileUploads = document.getElementById('admin-file-uploads');
                if (e.target.value === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน') {
                    fileUploads.classList.remove('hidden');
                } else {
                    fileUploads.classList.add('hidden');
                }
            });

            // Forms
            document.getElementById('request-form').addEventListener('submit', handleRequestFormSubmit);
            document.getElementById('form-add-attendee').addEventListener('click', () => addAttendeeField());
            document.getElementById('form-import-excel').addEventListener('click', () => document.getElementById('excel-file-input').click());
            document.getElementById('excel-file-input').addEventListener('change', handleExcelImport);
            document.getElementById('form-download-template').addEventListener('click', downloadAttendeeTemplate);
            document.querySelectorAll('input[name="expense_option"]').forEach(radio => radio.addEventListener('change', toggleExpenseOptions));
            document.querySelectorAll('input[name="vehicle_option"]').forEach(radio => radio.addEventListener('change', toggleVehicleOptions));
            
            document.getElementById('send-memo-form').addEventListener('submit', handleMemoSubmitFromModal);
            document.querySelectorAll('input[name="modal_memo_type"]').forEach(radio => radio.addEventListener('change', (e) => {
                const fileContainer = document.getElementById('modal-memo-file-container');
                const fileInput = document.getElementById('modal-memo-file');
                const isReimburse = e.target.value === 'reimburse';
                fileContainer.classList.toggle('hidden', isReimburse);
                fileInput.required = !isReimburse;
            }));

            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
            document.getElementById('password-form').addEventListener('submit', handlePasswordUpdate);
            document.getElementById('show-password-toggle').addEventListener('change', togglePasswordVisibility);
            
            document.getElementById('form-department').addEventListener('change', (e) => {
                const selectedPosition = e.target.value;
                const headNameInput = document.getElementById('form-head-name');
                headNameInput.value = specialPositionMap[selectedPosition] || '';
            });
            
            // Search
            document.getElementById('search-requests').addEventListener('input', (e) => renderRequestsList(allRequestsCache, userMemosCache, e.target.value));

            // Admin
            document.getElementById('add-user-button').addEventListener('click', openAddUserModal);
            document.getElementById('download-user-template-button').addEventListener('click', downloadUserTemplate);
            document.getElementById('import-users-button').addEventListener('click', () => document.getElementById('user-excel-input').click());
            document.getElementById('user-excel-input').addEventListener('change', handleUserImport);
            
            // Admin Page Tabs
            document.getElementById('admin-view-requests-tab').addEventListener('click', (e) => {
                document.getElementById('admin-view-memos-tab').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('admin-requests-view').classList.remove('hidden');
                document.getElementById('admin-memos-view').classList.add('hidden');
                fetchAllRequestsForCommand();
            });
            document.getElementById('admin-view-memos-tab').addEventListener('click', (e) => {
                document.getElementById('admin-view-requests-tab').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('admin-memos-view').classList.remove('hidden');
                document.getElementById('admin-requests-view').classList.add('hidden');
                fetchAllMemos();
            });
            
            // Edit Page Event Listeners
            setupEditPageEventListeners();

            // Global Error Handler
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                showAlert("ข้อผิดพลาดระบบ", "เกิดข้อผิดพลาดที่ไม่คาดคิด กรุณารีเฟรชหน้าเว็บ");
            });

            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
                showAlert("ข้อผิดพลาดระบบ", "เกิดข้อผิดพลาดในการทำงาน กรุณารีเฟรชหน้าเว็บ");
            });
        }

        // --- EDIT PAGE FUNCTIONS ---
        
        function setupEditPageEventListeners() {
            document.getElementById('back-to-dashboard').addEventListener('click', () => switchPage('dashboard-page'));
            document.getElementById('save-draft-button').addEventListener('click', saveDraft);
            document.getElementById('generate-document-button').addEventListener('click', generateDocumentFromDraft);
            document.getElementById('edit-add-attendee').addEventListener('click', () => addEditAttendeeField());
            
            // Expense options
            document.querySelectorAll('input[name="edit-expense_option"]').forEach(radio => {
                radio.addEventListener('change', toggleEditExpenseOptions);
            });
            
            // Vehicle options
            document.querySelectorAll('input[name="edit-vehicle_option"]').forEach(radio => {
                radio.addEventListener('change', toggleEditVehicleOptions);
            });
            
            // Department change
            document.getElementById('edit-department').addEventListener('change', (e) => {
                const selectedPosition = e.target.value;
                const headNameInput = document.getElementById('edit-head-name');
                headNameInput.value = specialPositionMap[selectedPosition] || '';
            });
        }

        // ฟังก์ชันเปิดหน้าแก้ไข
        async function openEditPage(requestId) {
            try {
                const result = await apiCall('GET', 'getDraftRequest', { requestId: requestId });
                const requestData = result.data;
                
                if (!requestData) {
                    showAlert("ผิดพลาด", "ไม่พบข้อมูลคำขอ");
                    return;
                }
                
                await populateEditForm(requestData);
                switchPage('edit-page');
                
            } catch (error) {
                console.error("Error loading edit data:", error);
                showAlert("ผิดพลาด", "ไม่สามารถโหลดข้อมูลสำหรับแก้ไขได้");
            }
        }

        // เติมข้อมูลในฟอร์มแก้ไข
        async function populateEditForm(requestData) {
            // รอให้ special positions โหลดเสร็จ
            await loadSpecialPositions();
            
            // ล้าง attendees ก่อน
            document.getElementById('edit-attendees-list').innerHTML = '';
            
            // เติมข้อมูลพื้นฐาน
            document.getElementById('edit-draft-id').value = requestData.draftId || '';
            document.getElementById('edit-request-id').value = requestData.requestId || '';
            
            if(requestData.docDate) {
                document.getElementById('edit-doc-date').value = new Date(requestData.docDate).toISOString().split('T')[0];
            }
            document.getElementById('edit-requester-name').value = requestData.requesterName || '';
            document.getElementById('edit-requester-position').value = requestData.requesterPosition || '';
            document.getElementById('edit-location').value = requestData.location || '';
            document.getElementById('edit-purpose').value = requestData.purpose || '';
            
            if(requestData.startDate) {
                document.getElementById('edit-start-date').value = new Date(requestData.startDate).toISOString().split('T')[0];
            }
            if(requestData.endDate) {
                document.getElementById('edit-end-date').value = new Date(requestData.endDate).toISOString().split('T')[0];
            }
            
            // เติมข้อมูล attendees
            if (requestData.attendees && requestData.attendees.length > 0) {
                requestData.attendees.forEach(att => {
                    addEditAttendeeField(att.name, att.position);
                });
            }
            
            // เติมข้อมูลค่าใช้จ่าย
            const expenseRadio = document.querySelector(`input[name="edit-expense_option"][value="${requestData.expenseOption}"]`);
            if (expenseRadio) {
                expenseRadio.checked = true;
            }
            toggleEditExpenseOptions();
            
            if(requestData.expenseOption === 'partial') {
                const expenseItems = JSON.parse(requestData.expenseItems || '[]');
                expenseItems.forEach(item => {
                    const chk = document.querySelector(`input[name="edit-expense_item"][data-item-name="${item.name}"]`);
                    if(chk) {
                        chk.checked = true;
                        if(item.name === 'ค่าใช้จ่ายอื่นๆ') {
                           document.getElementById('edit-expense_other_text').value = item.detail || '';
                        }
                    }
                });
                document.getElementById('edit-total-expense').value = requestData.totalExpense || 0;
            }
            
            // เติมข้อมูลยานพาหนะ
            const vehicleRadio = document.querySelector(`input[name="edit-vehicle_option"][value="${requestData.vehicleOption}"]`);
            if (vehicleRadio) {
                vehicleRadio.checked = true;
            }
            toggleEditVehicleOptions();
            
            if (requestData.vehicleOption === 'private') {
                document.getElementById('edit-license-plate').value = requestData.licensePlate || '';
            }
            
            // เติมข้อมูลแผนก - ใช้ข้อมูลจาก specialPositionMap
            const departmentSelect = document.getElementById('edit-department');
            departmentSelect.value = requestData.department || '';
            
            // ตั้งค่าชื่อหัวหน้าแผนก
            const headNameInput = document.getElementById('edit-head-name');
            headNameInput.value = specialPositionMap[requestData.department] || requestData.headName || '';
        }

        // ฟังก์ชันบันทึกข้อมูลคำขอ (ไม่สร้างเอกสาร)
        async function saveDraft() {
            const formData = getEditFormData();
            
            if (!validateEditForm(formData)) {
                return;
            }
            
            toggleLoader('save-draft-button', true);
            
            try {
                const result = await apiCall('POST', 'saveDraftRequest', formData);
                document.getElementById('edit-draft-id').value = result.data.draftId;
                
                showAlert("สำเร็จ", "บันทึกข้อมูลคำขอเรียบร้อยแล้ว");
            } catch (error) {
                showAlert("ผิดพลาด", "ไม่สามารถบันทึกข้อมูลได้: " + error.message);
            } finally {
                toggleLoader('save-draft-button', false);
            }
        }

        // ฟังก์ชันสร้างเอกสารจากข้อมูลที่บันทึก
        async function generateDocumentFromDraft() {
            const draftId = document.getElementById('edit-draft-id').value;
            const requestId = document.getElementById('edit-request-id').value;
            
            if (!draftId && !requestId) {
                showAlert("ผิดพลาด", "กรุณาบันทึกข้อมูลคำขอก่อน");
                return;
            }
            
            const formData = getEditFormData();
            formData.draftId = draftId;
            formData.requestId = requestId;
            
            toggleLoader('generate-document-button', true);
            
            try {
                const result = await apiCall('POST', 'generateDocumentFromDraft', formData);
                
                document.getElementById('edit-result-title').textContent = 'สร้างเอกสารสำเร็จ!';
                document.getElementById('edit-result-message').textContent = `บันทึกข้อความสำหรับ ID ${result.data.id} ถูกสร้างแล้ว`;
                document.getElementById('edit-result-link').href = result.data.pdfUrl;
                document.getElementById('edit-result').classList.remove('hidden');
                
                clearRequestsCache();
                await fetchUserRequests();
                
            } catch (error) {
                showAlert("เกิดข้อผิดพลาด", "ไม่สามารถสร้างเอกสารได้: " + error.message);
            } finally {
                toggleLoader('generate-document-button', false);
            }
        }

        // ฟังก์ชันดึงข้อมูลจากฟอร์มแก้ไข
        function getEditFormData() {
            const expenseItems = [];
            const expenseOption = document.querySelector('input[name="edit-expense_option"]:checked');
            
            if (expenseOption && expenseOption.value === 'partial') {
                document.querySelectorAll('input[name="edit-expense_item"]:checked').forEach(chk => {
                    const item = { name: chk.dataset.itemName };
                    if (item.name === 'ค่าใช้จ่ายอื่นๆ') {
                        item.detail = document.getElementById('edit-expense_other_text').value.trim();
                    }
                    expenseItems.push(item);
                });
            }

            return {
                draftId: document.getElementById('edit-draft-id').value,
                requestId: document.getElementById('edit-request-id').value,
                username: getCurrentUser().username,
                docDate: document.getElementById('edit-doc-date').value,
                requesterName: document.getElementById('edit-requester-name').value.trim(),
                requesterPosition: document.getElementById('edit-requester-position').value.trim(),
                location: document.getElementById('edit-location').value.trim(),
                purpose: document.getElementById('edit-purpose').value.trim(),
                startDate: document.getElementById('edit-start-date').value,
                endDate: document.getElementById('edit-end-date').value,
                attendees: Array.from(document.querySelectorAll('#edit-attendees-list > div')).map(div => {
                    const select = div.querySelector('.attendee-position-select');
                    let position = select ? select.value : '';
                    if (position === 'other') {
                        const otherInput = div.querySelector('.attendee-position-other');
                        position = otherInput ? otherInput.value.trim() : '';
                    }
                    const nameInput = div.querySelector('.attendee-name');
                    return {
                        name: nameInput ? nameInput.value.trim() : '',
                        position: position
                    };
                }).filter(att => att.name && att.position),
                expenseOption: expenseOption ? expenseOption.value : 'no',
                expenseItems: expenseItems,
                totalExpense: document.getElementById('edit-total-expense').value || 0,
                vehicleOption: document.querySelector('input[name="edit-vehicle_option"]:checked')?.value || 'gov',
                licensePlate: document.getElementById('edit-license-plate').value.trim(),
                department: document.getElementById('edit-department').value,
                headName: document.getElementById('edit-head-name').value,
            };
        }

        // ฟังก์ชันเพิ่มผู้ร่วมเดินทางในหน้าแก้ไข
        function addEditAttendeeField(name = '', position = '') {
            const list = document.getElementById('edit-attendees-list');
            const attendeeDiv = document.createElement('div');
            attendeeDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-2';
            attendeeDiv.innerHTML = `
                <input type="text" class="form-input attendee-name md:col-span-1" placeholder="ชื่อ-นามสกุล" value="${name}" required>
                <div class="attendee-position-wrapper md:col-span-1">
                     <select class="form-input attendee-position-select">
                        <option value="">-- เลือกตำแหน่ง --</option>
                        <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                        <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                        <option value="ครู">ครู</option>
                        <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                        <option value="พนักงานราชการ">พนักงานราชการ</option>
                        <option value="ครูอัตราจ้าง">ครูอัตราจ้าง</option>
                        <option value="พนักงานขับรถ">พนักงานขับรถ</option>
                        <option value="นักเรียน">นักเรียน</option>
                        <option value="other">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" class="form-input attendee-position-other hidden mt-1" placeholder="ระบุตำแหน่ง" value="${position === 'other' ? '' : position}">
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ลบ</button>
            `;
            list.appendChild(attendeeDiv);
            
            const select = attendeeDiv.querySelector('.attendee-position-select');
            const otherInput = attendeeDiv.querySelector('.attendee-position-other');

            const optionExists = Array.from(select.options).some(opt => opt.value === position);
            if (optionExists) {
                select.value = position;
            } else if (position) {
                select.value = 'other';
                otherInput.value = position;
                otherInput.classList.remove('hidden');
            }

            select.addEventListener('change', () => {
                otherInput.classList.toggle('hidden', select.value !== 'other');
            });
        }

        // ฟังก์ชัน validation
        function validateEditForm(formData) {
            const startDate = new Date(formData.startDate);
            const endDate = new Date(formData.endDate);
            
            if (startDate > endDate) {
                showAlert("ข้อมูลไม่ถูกต้อง", "วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด");
                return false;
            }
            
            const hasEmptyAttendees = formData.attendees.some(att => !att.name || !att.position);
            if (hasEmptyAttendees) {
                showAlert("ข้อมูลไม่ครบ", "กรุณากรอกข้อมูลผู้ร่วมเดินทางให้ครบถ้วน");
                return false;
            }
            
            return true;
        }

        // ฟังก์ชัน toggle สำหรับหน้าแก้ไข
        function toggleEditExpenseOptions() {
            const partialOptions = document.getElementById('edit-partial-expense-options');
            const totalContainer = document.getElementById('edit-total-expense-container');
            if (document.getElementById('edit-expense_partial')?.checked) {
                partialOptions.classList.remove('hidden');
                totalContainer.classList.remove('hidden');
            } else {
                partialOptions.classList.add('hidden');
                totalContainer.classList.add('hidden');
            }
        }

        function toggleEditVehicleOptions() {
            const privateDetails = document.getElementById('edit-private-vehicle-details');
            if (document.getElementById('edit-vehicle_private')?.checked) {
                privateDetails.classList.remove('hidden');
            } else {
                privateDetails.classList.add('hidden');
            }
        }

        // --- PROFILE FUNCTIONS ---

        function loadProfileData() {
            const user = getCurrentUser();
            if (!user) return;

            document.getElementById('profile-fullname').value = user.fullName || '';
            document.getElementById('profile-position').value = user.position || '';
            document.getElementById('profile-department').value = user.department || '';
            document.getElementById('profile-username').value = user.username || '';
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            const user = getCurrentUser();
            if (!user) return;

            const formData = {
                username: user.username,
                fullName: document.getElementById('profile-fullname').value,
                position: document.getElementById('profile-position').value,
                department: document.getElementById('profile-department').value
            };

            toggleLoader('profile-submit-button', true);

            try {
                const result = await apiCall('POST', 'updateUserProfile', formData);
                
                if (result.status === 'success') {
                    const updatedUser = { ...user, ...formData };
                    sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    updateUIForUser(updatedUser);
                    
                    showAlert('สำเร็จ', 'อัพเดทข้อมูลส่วนตัวสำเร็จ');
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการอัพเดทข้อมูล: ' + error.message);
            } finally {
                toggleLoader('profile-submit-button', false);
            }
        }

        async function handlePasswordUpdate(e) {
            e.preventDefault();
            
            const user = getCurrentUser();
            if (!user) return;

            const formData = {
                username: user.username,
                oldPassword: document.getElementById('current-password').value,
                newPassword: document.getElementById('new-password').value
            };

            if (!formData.oldPassword || !formData.newPassword) {
                showAlert('ผิดพลาด', 'กรุณากรอกรหัสผ่านปัจจุบันและรหัสผ่านใหม่');
                return;
            }

            toggleLoader('password-submit-button', true);

            try {
                const result = await apiCall('POST', 'updatePassword', formData);
                
                if (result.status === 'success') {
                    showAlert('สำเร็จ', 'เปลี่ยนรหัสผ่านสำเร็จ');
                    document.getElementById('password-form').reset();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการเปลี่ยนรหัสผ่าน: ' + error.message);
            } finally {
                toggleLoader('password-submit-button', false);
            }
        }

        function togglePasswordVisibility() {
            const showPassword = document.getElementById('show-password-toggle').checked;
            const currentPassword = document.getElementById('current-password');
            const newPassword = document.getElementById('new-password');
            
            currentPassword.type = showPassword ? 'text' : 'password';
            newPassword.type = showPassword ? 'text' : 'password';
        }

        // --- REQUEST FUNCTIONS ---

        async function fetchUserRequests() {
    try {
        const user = getCurrentUser();
        if (!user) return;

        document.getElementById('requests-loader').classList.remove('hidden');
        document.getElementById('requests-list').classList.add('hidden');
        document.getElementById('no-requests-message').classList.add('hidden');

        // โหลดทั้ง Requests และ Memos พร้อมกัน
        const [requestsResult, memosResult] = await Promise.all([
            apiCall('GET', 'getUserRequests', { username: user.username }),
            apiCall('GET', 'getSentMemos', { username: user.username })
        ]);
        
        if (requestsResult.status === 'success') {
            allRequestsCache = requestsResult.data;
            userMemosCache = memosResult.data || [];
            renderRequestsList(allRequestsCache, userMemosCache);
        }
    } catch (error) {
        console.error('Error fetching requests:', error);
        showAlert('ผิดพลาด', 'ไม่สามารถโหลดข้อมูลคำขอได้');
    } finally {
        document.getElementById('requests-loader').classList.add('hidden');
    }
}

     function renderRequestsList(requests, memos, searchTerm = '') {
    const container = document.getElementById('requests-list');
    const noRequestsMessage = document.getElementById('no-requests-message');
    
    if (!requests || requests.length === 0) {
        container.classList.add('hidden');
        noRequestsMessage.classList.remove('hidden');
        return;
    }

    let filteredRequests = requests;
    if (searchTerm) {
        filteredRequests = requests.filter(req => 
            (req.purpose && req.purpose.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (req.location && req.location.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (req.id && req.id.toLowerCase().includes(searchTerm.toLowerCase()))
        );
    }

    if (filteredRequests.length === 0) {
        container.classList.add('hidden');
        noRequestsMessage.classList.remove('hidden');
        noRequestsMessage.textContent = 'ไม่พบคำขอที่ตรงกับการค้นหา';
        return;
    }

    container.innerHTML = filteredRequests.map(request => {
        // หาบันทึกข้อความที่เกี่ยวข้อง
        const relatedMemo = memos.find(memo => memo.refNumber === request.id);
        
        // 🔄 กำหนดสถานะที่จะแสดง - ถ้ามีบันทึกให้ใช้สถานะจากบันทึกเป็นหลัก
        let displayRequestStatus = request.status;
        let displayCommandStatus = request.commandStatus;
        
        if (relatedMemo) {
            // ถ้ามีบันทึก ให้สถานะทั้งหมดตามสถานะบันทึก
            displayRequestStatus = relatedMemo.status;
            displayCommandStatus = relatedMemo.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน' ? 'เสร็จสิ้น' : relatedMemo.status;
        }
        
        const hasCompletedFiles = relatedMemo && (
            relatedMemo.completedMemoUrl || 
            relatedMemo.completedCommandUrl || 
            relatedMemo.dispatchBookUrl
        );
        
        // ตรวจสอบสถานะทั้งหมด
        const isFullyCompleted = relatedMemo && relatedMemo.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน';
        
        return `
            <div class="border rounded-lg p-4 mb-4 bg-white shadow-sm ${isFullyCompleted ? 'border-green-300 bg-green-50' : ''}">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="font-bold text-lg">${request.id || 'ไม่มีรหัส'}</h3>
                            ${isFullyCompleted ? `
                                <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                                    ✅ เสร็จสิ้นทั้งหมด
                                </span>
                            ` : ''}
                            ${relatedMemo && relatedMemo.status === 'นำกลับไปแก้ไข' ? `
                                <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                                    ⚠️ ต้องแก้ไข
                                </span>
                            ` : ''}
                        </div>
                        <p class="text-gray-600">${request.purpose || 'ไม่มีวัตถุประสงค์'}</p>
                        <p class="text-sm text-gray-500">สถานที่: ${request.location || 'ไม่ระบุ'} | วันที่: ${formatDisplayDate(request.startDate)} - ${formatDisplayDate(request.endDate)}</p>
                        
                        <div class="mt-2 space-y-1">
                            <p class="text-sm">
                                <span class="font-medium">สถานะคำขอ:</span> 
                                <span class="${getStatusColor(displayRequestStatus)}">${translateStatus(displayRequestStatus)}</span>
                                ${relatedMemo ? `<span class="text-xs text-gray-500 ml-1">` : ''}
                            </p>
                            <p class="text-sm">
                                <span class="font-medium">สถานะคำสั่ง:</span> 
                                <span class="${getStatusColor(displayCommandStatus)}">${translateStatus(displayCommandStatus || 'กำลังดำเนินการ')}</span>
                                ${relatedMemo ? `<span class="text-xs text-gray-500 ml-1">` : ''}
                            </p>
                            
                            ${relatedMemo ? `
                                <p class="text-sm">
                                    <span class="font-medium">สถานะบันทึก:</span> 
                                    <span class="${getStatusColor(relatedMemo.status)}">${translateStatus(relatedMemo.status)}</span>
                                    <span class="text-xs text-blue-500 ml-1">
                                </p>
                            ` : ''}
                        </div>
                        
                        ${hasCompletedFiles ? `
                            <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                                <p class="text-sm font-medium text-green-800 mb-2">📁 ไฟล์ที่พร้อมดาวน์โหลด:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${relatedMemo.completedMemoUrl ? `
                                        <a href="${relatedMemo.completedMemoUrl}" target="_blank" class="btn btn-success btn-sm text-xs">
                                            📄 บันทึกข้อความสมบูรณ์
                                        </a>
                                    ` : ''}
                                    ${relatedMemo.completedCommandUrl ? `
                                        <a href="${relatedMemo.completedCommandUrl}" target="_blank" class="btn bg-blue-500 text-white btn-sm text-xs">
                                            📋 คำสั่งไปราชการสมบูรณ์
                                        </a>
                                    ` : ''}
                                    ${relatedMemo.dispatchBookUrl ? `
                                        <a href="${relatedMemo.dispatchBookUrl}" target="_blank" class="btn bg-purple-500 text-white btn-sm text-xs">
                                            📦 หนังสือส่งสมบูรณ์
                                        </a>
                                    ` : ''}
                                </div>
                                ${isFullyCompleted ? `
                                    <p class="text-xs text-green-600 mt-2">
                                        ✅ งานทั้งหมดเสร็จสมบูรณ์และพร้อมใช้งาน
                                    </p>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex gap-2 flex-col ml-4">
                        ${request.pdfUrl ? `
                            <a href="${request.pdfUrl}" target="_blank" class="btn btn-success btn-sm">
                                📄 ดูคำขอ
                            </a>
                        ` : ''}
                        
                        ${!isFullyCompleted ? `
                            <button data-action="edit" data-id="${request.id}" class="btn bg-blue-500 text-white btn-sm">
                                ✏️ แก้ไข
                            </button>
                        ` : ''}
                        
                        ${!isFullyCompleted ? `
                            <button data-action="delete" data-id="${request.id}" class="btn btn-danger btn-sm">
                                🗑️ ลบ
                            </button>
                        ` : ''}
                        
                        ${!relatedMemo && !isFullyCompleted ? `
                            <button data-action="send-memo" data-id="${request.id}" class="btn bg-green-500 text-white btn-sm">
                                📤 ส่งบันทึก
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.classList.remove('hidden');
    noRequestsMessage.classList.add('hidden');

    container.addEventListener('click', handleRequestAction);
}

/// ฟังก์ชันช่วยเหลือสำหรับสีสถานะ
function getStatusColor(status) {
    const statusColors = {
        'เสร็จสิ้น/รับไฟล์ไปใช้งาน': 'text-green-600 font-semibold',
        'เสร็จสิ้น': 'text-green-600 font-semibold',
        'Approved': 'text-green-600 font-semibold',
        'เสร็จสิ้นรอออกคำสั่งไปราชการ': 'text-blue-600',
        'กำลังดำเนินการ': 'text-yellow-600',
        'Pending': 'text-yellow-600',
        'Submitted': 'text-blue-600',
        'รอเอกสาร (เบิก)': 'text-orange-600',
        'นำกลับไปแก้ไข': 'text-red-600',
        'รอตรวจสอบและออกคำสั่งไปราชการ': 'text-purple-600'
    };
    return statusColors[status] || 'text-gray-600';
}

       // ในฟังก์ชัน handleRequestAction
async function handleRequestAction(e) {
    const button = e.target.closest('button[data-action]');
    if (!button) return;

    const requestId = button.dataset.id;
    const action = button.dataset.action;

    if (action === 'edit') {
        await openEditPage(requestId);
    } else if (action === 'delete') {
        const confirmed = await showConfirm("ยืนยันการลบ", "คุณแน่ใจหรือไม่ว่าต้องการลบรายการคำขอนี้? การกระทำนี้ไม่สามารถย้อนกลับได้");
        if (confirmed) {
            try {
               await apiCall('POST', 'deleteRequest', { id: requestId });
               clearRequestsCache();
               showAlert("ลบสำเร็จ", "รายการคำขอถูกลบเรียบร้อยแล้ว");
               await fetchUserRequests();
            } catch(error) {
                showAlert("เกิดข้อผิดพลาด", "ไม่สามารถลบรายการได้: " + error.message);
            }
        }
    } else if (action === 'send-memo') {
        document.getElementById('memo-modal-request-id').value = requestId;
        document.getElementById('send-memo-modal').style.display = 'flex';
    }
}

        // --- BASIC FORM FUNCTIONS ---

        async function resetRequestForm() {
            document.getElementById('request-form').reset();
            document.getElementById('form-request-id').value = '';
            document.getElementById('form-attendees-list').innerHTML = '';
            document.getElementById('form-result').classList.add('hidden');
            
            // ตั้งค่าวันเริ่มต้นเป็นวันนี้
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('form-doc-date').value = today;
            document.getElementById('form-start-date').value = today;
            document.getElementById('form-end-date').value = today;
            
            // ตั้งค่า department change handler
            document.getElementById('form-department').addEventListener('change', (e) => {
                const selectedDept = e.target.value;
                document.getElementById('form-head-name').value = specialPositionMap[selectedDept] || '';
            });
        }

        function addAttendeeField() {
            const list = document.getElementById('form-attendees-list');
            const attendeeDiv = document.createElement('div');
            attendeeDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-2';
            attendeeDiv.innerHTML = `
                <input type="text" class="form-input attendee-name md:col-span-1" placeholder="ชื่อ-นามสกุล" required>
                <div class="attendee-position-wrapper md:col-span-1">
                     <select class="form-input attendee-position-select">
                        <option value="">-- เลือกตำแหน่ง --</option>
                        <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                        <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                        <option value="ครู">ครู</option>
                        <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                        <option value="พนักงานราชการ">พนักงานราชการ</option>
                        <option value="ครูอัตราจ้าง">ครูอัตราจ้าง</option>
                        <option value="พนักงานขับรถ">พนักงานขับรถ</option>
                        <option value="นักเรียน">นักเรียน</option>
                        <option value="other">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" class="form-input attendee-position-other hidden mt-1" placeholder="ระบุตำแหน่ง">
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ลบ</button>
            `;
            list.appendChild(attendeeDiv);
            
            const select = attendeeDiv.querySelector('.attendee-position-select');
            const otherInput = attendeeDiv.querySelector('.attendee-position-other');

            select.addEventListener('change', () => {
                otherInput.classList.toggle('hidden', select.value !== 'other');
            });
        }

        function toggleExpenseOptions() {
            const partialOptions = document.getElementById('partial-expense-options');
            const totalContainer = document.getElementById('total-expense-container');
            if (document.getElementById('expense_partial').checked) {
                partialOptions.classList.remove('hidden');
                totalContainer.classList.remove('hidden');
            } else {
                partialOptions.classList.add('hidden');
                totalContainer.classList.add('hidden');
            }
        }

        function toggleVehicleOptions() {
            const privateDetails = document.getElementById('private-vehicle-details');
            if (document.getElementById('vehicle_private').checked) {
                privateDetails.classList.remove('hidden');
            } else {
                privateDetails.classList.add('hidden');
            }
        }

        async function handleRequestFormSubmit(e) {
            e.preventDefault();
            
            const user = getCurrentUser();
            if (!user) {
                showAlert('ผิดพลาด', 'กรุณาเข้าสู่ระบบก่อน');
                return;
            }

            const formData = {
                username: user.username,
                docDate: document.getElementById('form-doc-date').value,
                requesterName: document.getElementById('form-requester-name').value,
                requesterPosition: document.getElementById('form-requester-position').value,
                location: document.getElementById('form-location').value,
                purpose: document.getElementById('form-purpose').value,
                startDate: document.getElementById('form-start-date').value,
                endDate: document.getElementById('form-end-date').value,
                attendees: Array.from(document.querySelectorAll('#form-attendees-list > div')).map(div => {
                    const select = div.querySelector('.attendee-position-select');
                    let position = select.value;
                    if (position === 'other') {
                        position = div.querySelector('.attendee-position-other').value;
                    }
                    return {
                        name: div.querySelector('.attendee-name').value,
                        position: position
                    };
                }).filter(att => att.name && att.position),
                expenseOption: document.querySelector('input[name="expense_option"]:checked').value,
                expenseItems: [],
                totalExpense: document.getElementById('form-total-expense').value || 0,
                vehicleOption: document.querySelector('input[name="vehicle_option"]:checked').value,
                licensePlate: document.getElementById('form-license-plate').value,
                department: document.getElementById('form-department').value,
                headName: document.getElementById('form-head-name').value
            };

            if (formData.expenseOption === 'partial') {
                document.querySelectorAll('input[name="expense_item"]:checked').forEach(chk => {
                    const item = { name: chk.dataset.itemName };
                    if (item.name === 'ค่าใช้จ่ายอื่นๆ') {
                        item.detail = document.getElementById('expense_other_text').value;
                    }
                    formData.expenseItems.push(item);
                });
            }

            toggleLoader('submit-request-button', true);

            try {
                const result = await apiCall('POST', 'createRequest', formData);
                
                if (result.status === 'success') {
                    document.getElementById('form-result-title').textContent = 'สร้างเอกสารสำเร็จ!';
                    document.getElementById('form-result-message').textContent = `บันทึกข้อความสำหรับ ID ${result.data.id} ถูกสร้างแล้ว`;
                    document.getElementById('form-result-link').href = result.data.pdfUrl;
                    document.getElementById('form-result').classList.remove('hidden');
                    
                    document.getElementById('request-form').reset();
                    document.getElementById('form-attendees-list').innerHTML = '';
                    
                    clearRequestsCache();
                    await fetchUserRequests();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถสร้างเอกสารได้: ' + error.message);
            } finally {
                toggleLoader('submit-request-button', false);
            }
        }

        // --- BASIC ADMIN FUNCTIONS ---

        async function fetchAllUsers() {
            try {
                if (!checkAdminAccess()) {
                    showAlert('ผิดพลาด', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                    return;
                }

                const result = await apiCall('GET', 'getAllUsers');
                if (result.status === 'success') {
                    allUsersCache = result.data;
                    renderUsersList(allUsersCache);
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                showAlert('ผิดพลาด', 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้');
            }
        }

        function renderUsersList(users) {
            const container = document.getElementById('users-content');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ไม่พบข้อมูลผู้ใช้</p>';
                return;
            }

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-4 py-2 text-left">ชื่อผู้ใช้</th>
                                <th class="px-4 py-2 text-left">ชื่อ-นามสกุล</th>
                                <th class="px-4 py-2 text-left">ตำแหน่ง</th>
                                <th class="px-4 py-2 text-left">กลุ่มสาระ/งาน</th>
                                <th class="px-4 py-2 text-left">บทบาท</th>
                                <th class="px-4 py-2 text-left">การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr class="border-b">
                                    <td class="px-4 py-2">${user.username}</td>
                                    <td class="px-4 py-2">${user.fullName}</td>
                                    <td class="px-4 py-2">${user.position}</td>
                                    <td class="px-4 py-2">${user.department}</td>
                                    <td class="px-4 py-2">${user.role}</td>
                                    <td class="px-4 py-2">
                                        <button onclick="deleteUser('${user.username}')" class="btn btn-danger btn-sm">ลบ</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function deleteUser(username) {
            const confirmed = await showConfirm("ยืนยันการลบ", `คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ ${username}?`);
            if (confirmed) {
                try {
                    await apiCall('POST', 'deleteUser', { username });
                    showAlert('สำเร็จ', 'ลบผู้ใช้สำเร็จ');
                    await fetchAllUsers();
                } catch (error) {
                    showAlert('ผิดพลาด', 'ไม่สามารถลบผู้ใช้ได้: ' + error.message);
                }
            }
        }

        function openAddUserModal() {
            document.getElementById('register-modal').style.display = 'flex';
        }

        function downloadUserTemplate() {
            const template = [
                ['Username', 'Password', 'FullName', 'Position', 'Department', 'Role', 'SpecialPosition']
            ];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'user_template.xlsx');
        }

        async function handleUserImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                const result = await apiCall('POST', 'importUsers', { users: jsonData });
                
                if (result.status === 'success') {
                    showAlert('สำเร็จ', result.message);
                    await fetchAllUsers();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message);
            } finally {
                e.target.value = '';
            }
        }

        // --- MEMO FUNCTIONS ---

        async function handleMemoSubmitFromModal(e) {
            e.preventDefault();
            
            const user = getCurrentUser();
            if (!user) return;

            const requestId = document.getElementById('memo-modal-request-id').value;
            const memoType = document.querySelector('input[name="modal_memo_type"]:checked').value;
            const fileInput = document.getElementById('modal-memo-file');
            
            let fileObject = null;
            if (memoType === 'non_reimburse' && fileInput.files.length > 0) {
                fileObject = await fileToObject(fileInput.files[0]);
            }

            toggleLoader('send-memo-submit-button', true);

            try {
                const result = await apiCall('POST', 'uploadMemo', {
                    refNumber: requestId,
                    file: fileObject,
                    username: user.username,
                    memoType: memoType
                });
                
                if (result.status === 'success') {
                    showAlert('สำเร็จ', 'ส่งบันทึกข้อความสำเร็จ');
                    document.getElementById('send-memo-modal').style.display = 'none';
                    document.getElementById('send-memo-form').reset();
                    await fetchUserRequests();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการส่งบันทึกข้อความ: ' + error.message);
            } finally {
                toggleLoader('send-memo-submit-button', false);
            }
        }

        // --- STATS FUNCTIONS ---

        // --- STATS FUNCTIONS ---

async function loadStatsData() {
    try {
        const user = getCurrentUser();
        if (!user) return;

        document.getElementById('stats-overview').innerHTML = `
            <div class="text-center p-8">
                <div class="loader mx-auto"></div>
                <p class="mt-4">กำลังโหลดสถิติ...</p>
            </div>
        `;

        // โหลดข้อมูลทั้งหมด
        const [requestsResult, memosResult, usersResult] = await Promise.all([
            apiCall('GET', 'getAllRequests'),
            apiCall('GET', 'getAllMemos'),
            apiCall('GET', 'getAllUsers')
        ]);

        const requests = requestsResult.data || [];
        const memos = memosResult.data || [];
        const users = usersResult.data || [];

        // กรองข้อมูลของผู้ใช้ปัจจุบัน (ถ้าไม่ใช่ admin)
        const userRequests = user.role === 'admin' ? requests : requests.filter(req => req.username === user.username);
        const userMemos = user.role === 'admin' ? memos : memos.filter(memo => memo.submittedBy === user.username);

        renderStatsOverview(userRequests, userMemos, users, user);
        
    } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('stats-overview').innerHTML = `
            <div class="text-center p-4 text-red-500">
                <p>เกิดข้อผิดพลาดในการโหลดสถิติ</p>
            </div>
        `;
    }
}

function renderStatsOverview(requests, memos, users, currentUser) {
    const container = document.getElementById('stats-overview');
    
    // คำนวณสถิติ
    const stats = calculateStats(requests, memos, users, currentUser);
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- การ์ดสถิติ -->
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">คำขอทั้งหมด</p>
                        <p class="text-2xl font-bold text-gray-900">${stats.totalRequests}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">คำขอที่เสร็จสิ้น</p>
                        <p class="text-2xl font-bold text-gray-900">${stats.completedRequests}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">บันทึกข้อความ</p>
                        <p class="text-2xl font-bold text-gray-900">${stats.totalMemos}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">ผู้ใช้ทั้งหมด</p>
                        <p class="text-2xl font-bold text-gray-900">${stats.totalUsers}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- สถิติตามสถานะ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-800">สถานะคำขอ</h3>
                <div class="space-y-3">
                    ${Object.entries(stats.requestStatus).map(([status, count]) => `
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">${translateStatus(status)}</span>
                            <span class="font-semibold">${count} คำขอ</span>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- สถิติตามแผนก -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-800">คำขอตามแผนก</h3>
                <div class="space-y-3">
                    ${Object.entries(stats.departmentStats).slice(0, 8).map(([dept, count]) => `
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 truncate" title="${dept}">${dept}</span>
                            <span class="font-semibold">${count} คำขอ</span>
                        </div>
                    `).join('')}
                    ${Object.entries(stats.departmentStats).length > 8 ? `
                        <div class="text-center text-sm text-gray-500 mt-2">
                            + ${Object.entries(stats.departmentStats).length - 8} แผนกอื่นๆ
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>

        ${currentUser.role === 'admin' ? `
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold mb-4 text-gray-800">สถิติผู้ใช้</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <p class="text-2xl font-bold text-blue-600">${stats.userStats.total}</p>
                    <p class="text-sm text-gray-600">ผู้ใช้ทั้งหมด</p>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <p class="text-2xl font-bold text-green-600">${stats.userStats.admins}</p>
                    <p class="text-sm text-gray-600">ผู้ดูแลระบบ</p>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <p class="text-2xl font-bold text-purple-600">${stats.userStats.regularUsers}</p>
                    <p class="text-sm text-gray-600">ผู้ใช้ทั่วไป</p>
                </div>
            </div>
        </div>
        ` : ''}

        <!-- สถิติรายเดือน -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold mb-4 text-gray-800">คำขอรายเดือน (6 เดือนล่าสุด)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">เดือน</th>
                            <th class="px-4 py-2 text-center text-sm font-medium text-gray-700">จำนวนคำขอ</th>
                            <th class="px-4 py-2 text-center text-sm font-medium text-gray-700">สถานะเสร็จสิ้น</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.monthlyStats.map(month => `
                            <tr class="border-b">
                                <td class="px-4 py-2 text-sm text-gray-600">${month.month}</td>
                                <td class="px-4 py-2 text-center text-sm font-semibold">${month.count}</td>
                                <td class="px-4 py-2 text-center">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${month.completed > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        ${month.completed}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function calculateStats(requests, memos, users, currentUser) {
    // สถิติพื้นฐาน
    const totalRequests = requests.length;
    const totalMemos = memos.length;
    const totalUsers = users.length;

    // สถิติสถานะคำขอ
    const requestStatus = {};
    requests.forEach(req => {
        const status = req.status || 'กำลังดำเนินการ';
        requestStatus[status] = (requestStatus[status] || 0) + 1;
    });

    // คำขอที่เสร็จสิ้น
    const completedRequests = requests.filter(req => 
        req.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน' || 
        req.status === 'Approved' ||
        req.commandStatus === 'เสร็จสิ้นรอออกคำสั่งไปราชการ'
    ).length;

    // สถิติตามแผนก
    const departmentStats = {};
    requests.forEach(req => {
        const dept = req.department || 'ไม่ระบุแผนก';
        departmentStats[dept] = (departmentStats[dept] || 0) + 1;
    });

    // สถิติผู้ใช้ (สำหรับ admin)
    const userStats = {
        total: users.length,
        admins: users.filter(u => u.role === 'admin').length,
        regularUsers: users.filter(u => u.role === 'user').length
    };

    // สถิติรายเดือน (6 เดือนล่าสุด)
    const monthlyStats = calculateMonthlyStats(requests);

    return {
        totalRequests,
        completedRequests,
        totalMemos,
        totalUsers,
        requestStatus,
        departmentStats,
        userStats,
        monthlyStats
    };
}

function calculateMonthlyStats(requests) {
    const months = [];
    const now = new Date();
    
    // สร้าง 6 เดือนย้อนหลัง
    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
        
        const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        
        const monthRequests = requests.filter(req => {
            const reqDate = new Date(req.timestamp || req.startDate || req.docDate);
            return reqDate >= monthStart && reqDate <= monthEnd;
        });
        
        const completedRequests = monthRequests.filter(req => 
            req.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน' || 
            req.status === 'Approved'
        ).length;
        
        months.push({
            month: monthKey,
            count: monthRequests.length,
            completed: completedRequests
        });
    }
    
    return months;
}

        // --- TEMPLATE FUNCTIONS ---

        function downloadAttendeeTemplate() {
            const template = [
                ['ชื่อ-นามสกุล', 'ตำแหน่ง'],
                ['ตัวอย่าง ผู้ใช้', 'ครู'],
                ['ตัวอย่าง ผู้ใช้2', 'นักเรียน']
            ];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'attendee_template.xlsx');
        }

        async function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                const attendeesList = document.getElementById('form-attendees-list');
                attendeesList.innerHTML = '';

                jsonData.forEach(row => {
                    if (row['ชื่อ-นามสกุล'] && row['ตำแหน่ง']) {
                        addAttendeeFieldWithData(row['ชื่อ-นามสกุล'], row['ตำแหน่ง']);
                    }
                });

                showAlert('สำเร็จ', 'นำเข้าข้อมูลผู้ร่วมเดินทางสำเร็จ');
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message);
            } finally {
                e.target.value = '';
            }
        }

        function addAttendeeFieldWithData(name, position) {
            const list = document.getElementById('form-attendees-list');
            const attendeeDiv = document.createElement('div');
            attendeeDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-2';
            attendeeDiv.innerHTML = `
                <input type="text" class="form-input attendee-name md:col-span-1" placeholder="ชื่อ-นามสกุล" value="${name}" required>
                <div class="attendee-position-wrapper md:col-span-1">
                     <select class="form-input attendee-position-select">
                        <option value="">-- เลือกตำแหน่ง --</option>
                        <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                        <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                        <option value="ครู">ครู</option>
                        <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                        <option value="พนักงานราชการ">พนักงานราชการ</option>
                        <option value="ครูอัตราจ้าง">ครูอัตราจ้าง</option>
                        <option value="พนักงานขับรถ">พนักงานขับรถ</option>
                        <option value="นักเรียน">นักเรียน</option>
                        <option value="other">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" class="form-input attendee-position-other hidden mt-1" placeholder="ระบุตำแหน่ง" value="${position}">
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ลบ</button>
            `;
            list.appendChild(attendeeDiv);
            
            const select = attendeeDiv.querySelector('.attendee-position-select');
            const otherInput = attendeeDiv.querySelector('.attendee-position-other');

            const optionExists = Array.from(select.options).some(opt => opt.value === position);
            if (optionExists) {
                select.value = position;
            } else {
                select.value = 'other';
                otherInput.classList.remove('hidden');
            }

            select.addEventListener('change', () => {
                otherInput.classList.toggle('hidden', select.value !== 'other');
            });
        }

        // --- ADMIN COMMAND FUNCTIONS ---

        async function fetchAllRequestsForCommand() {
            try {
                if (!checkAdminAccess()) {
                    showAlert('ผิดพลาด', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                    return;
                }

                const result = await apiCall('GET', 'getAllRequests');
                if (result.status === 'success') {
                    renderAdminRequestsList(result.data);
                }
            } catch (error) {
                console.error('Error fetching requests for command:', error);
                showAlert('ผิดพลาด', 'ไม่สามารถโหลดข้อมูลคำขอได้');
            }
        }

        function renderAdminRequestsList(requests) {
            const container = document.getElementById('admin-requests-list');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ไม่พบคำขอไปราชการ</p>';
                return;
            }

            container.innerHTML = requests.map(request => {
                const hasCommandSolo = request.commandPdfUrlSolo && request.commandPdfUrlSolo.trim() !== '';
                const hasCommandSmall = request.commandPdfUrlGroupSmall && request.commandPdfUrlGroupSmall.trim() !== '';
                const hasCommandLarge = request.commandPdfUrlGroupLarge && request.commandPdfUrlGroupLarge.trim() !== '';
                const hasAnyCommand = hasCommandSolo || hasCommandSmall || hasCommandLarge;
                
                return `
                    <div class="border rounded-lg p-4 bg-white">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold">${request.id}</h4>
                                <p class="text-sm text-gray-600">โดย: ${request.requesterName} | ${request.purpose}</p>
                                <p class="text-sm text-gray-500">${request.location} | ${formatDisplayDate(request.startDate)} - ${formatDisplayDate(request.endDate)}</p>
                                <p class="text-sm">สถานะคำขอ: <span class="font-medium">${translateStatus(request.status)}</span></p>
                                <p class="text-sm">สถานะคำสั่ง: <span class="font-medium">${request.commandStatus || 'รอดำเนินการ'}</span></p>
                            </div>
                            <div class="flex flex-col gap-2">
                                ${request.pdfUrl ? `<a href="${request.pdfUrl}" target="_blank" class="btn btn-success btn-sm">ดูคำขอ</a>` : ''}
                                
                                ${hasAnyCommand ? `
                                    <div class="flex gap-1">
                                        ${hasCommandSolo ? `<a href="${request.commandPdfUrlSolo}" target="_blank" class="btn bg-blue-500 text-white btn-sm">คำสั่งเดี่ยว</a>` : ''}
                                        ${hasCommandSmall ? `<a href="${request.commandPdfUrlGroupSmall}" target="_blank" class="btn bg-blue-500 text-white btn-sm">คำสั่งกลุ่มเล็ก</a>` : ''}
                                        ${hasCommandLarge ? `<a href="${request.commandPdfUrlGroupLarge}" target="_blank" class="btn bg-blue-500 text-white btn-sm">คำสั่งกลุ่มใหญ่</a>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${request.dispatchBookPdfUrl ? `<a href="${request.dispatchBookPdfUrl}" target="_blank" class="btn bg-purple-500 text-white btn-sm">ดูหนังสือส่ง</a>` : ''}
                                
                                <div class="flex gap-1">
                                    ${!hasAnyCommand ? `<button onclick="openCommandApproval('${request.id}')" class="btn bg-green-500 text-white btn-sm">ออกคำสั่ง</button>` : ''}
                                    ${!request.dispatchBookPdfUrl ? `<button onclick="openDispatchModal('${request.id}')" class="btn bg-orange-500 text-white btn-sm">ออกหนังสือส่ง</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function fetchAllMemos() {
            try {
                if (!checkAdminAccess()) {
                    showAlert('ผิดพลาด', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                    return;
                }

                const result = await apiCall('GET', 'getAllMemos');
                if (result.status === 'success') {
                    renderAdminMemosList(result.data);
                }
            } catch (error) {
                console.error('Error fetching memos:', error);
                showAlert('ผิดพลาด', 'ไม่สามารถโหลดข้อมูลบันทึกข้อความได้');
            }
        }

        function renderAdminMemosList(memos) {
            const container = document.getElementById('admin-memos-list');
            
            if (!memos || memos.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ไม่พบบันทึกข้อความ</p>';
                return;
            }

            container.innerHTML = memos.map(memo => {
                const hasCompletedFiles = memo.completedMemoUrl || memo.completedCommandUrl || memo.dispatchBookUrl;
                
                return `
                    <div class="border rounded-lg p-4 bg-white">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold">${memo.id}</h4>
                                <p class="text-sm text-gray-600">โดย: ${memo.submittedBy} | อ้างอิง: ${memo.refNumber}</p>
                                <p class="text-sm">สถานะ: <span class="font-medium">${translateStatus(memo.status)}</span></p>
                                <div class="mt-2 text-xs text-gray-500">
                                    ${memo.completedMemoUrl ? `<div>✓ บันทึกข้อความสมบูรณ์</div>` : ''}
                                    ${memo.completedCommandUrl ? `<div>✓ คำสั่งสมบูรณ์</div>` : ''}
                                    ${memo.dispatchBookUrl ? `<div>✓ หนังสือส่งสมบูรณ์</div>` : ''}
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                ${memo.fileURL ? `<a href="${memo.fileURL}" target="_blank" class="btn btn-success btn-sm">ดูไฟล์ต้นทาง</a>` : ''}
                                ${memo.completedMemoUrl ? `<a href="${memo.completedMemoUrl}" target="_blank" class="btn bg-blue-500 text-white btn-sm">ดูบันทึกสมบูรณ์</a>` : ''}
                                ${memo.completedCommandUrl ? `<a href="${memo.completedCommandUrl}" target="_blank" class="btn bg-blue-500 text-white btn-sm">ดูคำสั่งสมบูรณ์</a>` : ''}
                                ${memo.dispatchBookUrl ? `<a href="${memo.dispatchBookUrl}" target="_blank" class="btn bg-purple-500 text-white btn-sm">ดูหนังสือส่ง</a>` : ''}
                                
                                <button onclick="openAdminMemoAction('${memo.id}')" class="btn bg-green-500 text-white btn-sm">
                                    ${hasCompletedFiles ? 'จัดการไฟล์' : 'อัพโหลดไฟล์'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ฟังก์ชันเปิด Modal อนุมัติคำสั่ง
        function openCommandApproval(requestId) {
            if (!checkAdminAccess()) {
                showAlert('ผิดพลาด', 'คุณไม่มีสิทธิ์ใช้งานฟังก์ชันนี้');
                return;
            }
            document.getElementById('command-request-id').value = requestId;
            document.getElementById('command-approval-modal').style.display = 'flex';
        }

        // ฟังก์ชันเปิด Modal ส่งหนังสือส่ง
        function openDispatchModal(requestId) {
            if (!checkAdminAccess()) {
                showAlert('ผิดพลาด', 'คุณไม่มีสิทธิ์ใช้งานฟังก์ชันนี้');
                return;
            }
            document.getElementById('dispatch-request-id').value = requestId;
            // ตั้งค่าปีปัจจุบัน
            const currentYear = new Date().getFullYear() + 543;
            document.getElementById('dispatch-year').value = currentYear;
            document.getElementById('dispatch-modal').style.display = 'flex';
        }

        // ฟังก์ชันเปิด Modal จัดการบันทึกข้อความ
        function openAdminMemoAction(memoId) {
            if (!checkAdminAccess()) {
                showAlert('ผิดพลาด', 'คุณไม่มีสิทธิ์ใช้งานฟังก์ชันนี้');
                return;
            }
            document.getElementById('admin-memo-id').value = memoId;
            document.getElementById('admin-memo-action-modal').style.display = 'flex';
        }

        // ฟังก์ชันอนุมัติคำสั่ง
        async function handleCommandApproval(e) {
            e.preventDefault();
            
            const requestId = document.getElementById('command-request-id').value;
            const commandType = document.querySelector('input[name="command_type"]:checked')?.value;
            
            if (!commandType) {
                showAlert('ผิดพลาด', 'กรุณาเลือกรูปแบบคำสั่ง');
                return;
            }

            toggleLoader('command-approval-submit-button', true);

            try {
                const result = await apiCall('POST', 'approveCommand', {
                    requestId: requestId,
                    templateType: commandType
                });
                
                if (result.status === 'success') {
                    showAlert('สำเร็จ', 'อนุมัติคำสั่งเรียบร้อยแล้ว');
                    document.getElementById('command-approval-modal').style.display = 'none';
                    document.getElementById('command-approval-form').reset();
                    await fetchAllRequestsForCommand();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการอนุมัติคำสั่ง: ' + error.message);
            } finally {
                toggleLoader('command-approval-submit-button', false);
            }
        }

        // ฟังก์ชันสร้างหนังสือส่ง
        async function handleDispatchFormSubmit(e) {
            e.preventDefault();
            
            const requestId = document.getElementById('dispatch-request-id').value;
            const dispatchMonth = document.getElementById('dispatch-month').value;
            const dispatchYear = document.getElementById('dispatch-year').value;
            const commandCount = document.getElementById('command-count').value;
            const memoCount = document.getElementById('memo-count').value;

            if (!dispatchMonth || !dispatchYear || !commandCount || !memoCount) {
                showAlert('ผิดพลาด', 'กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            toggleLoader('dispatch-submit-button', true);

            try {
                const result = await apiCall('POST', 'generateDispatchBook', {
                    requestId: requestId,
                    dispatchMonth: dispatchMonth,
                    dispatchYear: dispatchYear,
                    commandCount: commandCount,
                    memoCount: memoCount
                });
                
                if (result.status === 'success') {
                    showAlert('สำเร็จ', 'สร้างหนังสือส่งสำเร็จ');
                    document.getElementById('dispatch-modal').style.display = 'none';
                    document.getElementById('dispatch-form').reset();
                    await fetchAllRequestsForCommand();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการสร้างหนังสือส่ง: ' + error.message);
            } finally {
                toggleLoader('dispatch-submit-button', false);
            }
        }

        // ฟังก์ชันจัดการบันทึกข้อความโดยผู้ดูแลระบบ
        async function handleAdminMemoActionSubmit(e) {
            e.preventDefault();
            
            const memoId = document.getElementById('admin-memo-id').value;
            const status = document.getElementById('admin-memo-status').value;
            
            const completedMemoFile = document.getElementById('admin-completed-memo-file').files[0];
            const completedCommandFile = document.getElementById('admin-completed-command-file').files[0];
            const dispatchBookFile = document.getElementById('admin-dispatch-book-file').files[0];

            let completedMemoFileObject = null;
            let completedCommandFileObject = null;
            let dispatchBookFileObject = null;

            // แปลงไฟล์เป็น object
            if (completedMemoFile) {
                completedMemoFileObject = await fileToObject(completedMemoFile);
            }
            if (completedCommandFile) {
                completedCommandFileObject = await fileToObject(completedCommandFile);
            }
            if (dispatchBookFile) {
                dispatchBookFileObject = await fileToObject(dispatchBookFile);
            }

            toggleLoader('admin-memo-submit-button', true);

            try {
                const result = await apiCall('POST', 'updateMemoStatus', {
                    id: memoId,
                    status: status,
                    completedMemoFile: completedMemoFileObject,
                    completedCommandFile: completedCommandFileObject,
                    dispatchBookFile: dispatchBookFileObject
                });
                
                if (result.status === 'success') {
                    showAlert('สำเร็จ', 'อัพเดทสถานะและไฟล์เรียบร้อยแล้ว');
                    document.getElementById('admin-memo-action-modal').style.display = 'none';
                    document.getElementById('admin-memo-action-form').reset();
                    await fetchAllMemos();
                } else {
                    showAlert('ผิดพลาด', result.message);
                }
            } catch (error) {
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการอัพเดท: ' + error.message);
            } finally {
                toggleLoader('admin-memo-submit-button', false);
            }
        }
        // ฟังก์ชันส่งออกรายงานสถิติ
async function exportStatsReport() {
    try {
        const user = getCurrentUser();
        if (!user) return;

        toggleLoader('export-stats', true);

        // โหลดข้อมูลล่าสุด
        const [requestsResult, memosResult, usersResult] = await Promise.all([
            apiCall('GET', 'getAllRequests'),
            apiCall('GET', 'getAllMemos'),
            apiCall('GET', 'getAllUsers')
        ]);

        const requests = requestsResult.data || [];
        const memos = memosResult.data || [];
        const users = usersResult.data || [];

        // กรองข้อมูล
        const userRequests = user.role === 'admin' ? requests : requests.filter(req => req.username === user.username);
        const stats = calculateStats(userRequests, memos, users, user);

        // สร้าง Excel report
        const reportData = [
            ['รายงานสถิติระบบไปราชการ', '', '', ''],
            ['วันที่ออกรายงาน', new Date().toLocaleDateString('th-TH'), '', ''],
            ['', '', '', ''],
            ['สถิติภาพรวม', '', '', ''],
            ['คำขอทั้งหมด', stats.totalRequests, '', ''],
            ['คำขอที่เสร็จสิ้น', stats.completedRequests, '', ''],
            ['บันทึกข้อความ', stats.totalMemos, '', ''],
            ['ผู้ใช้ทั้งหมด', stats.totalUsers, '', ''],
            ['', '', '', ''],
            ['สถิติตามสถานะ', '', '', ''],
            ...Object.entries(stats.requestStatus).map(([status, count]) => [translateStatus(status), count, '', '']),
            ['', '', '', ''],
            ['สถิติตามแผนก', '', '', ''],
            ...Object.entries(stats.departmentStats).map(([dept, count]) => [dept, count, '', '']),
            ['', '', '', ''],
            ['สถิติรายเดือน', '', '', ''],
            ['เดือน', 'จำนวนคำขอ', 'เสร็จสิ้น', ''],
            ...stats.monthlyStats.map(month => [month.month, month.count, month.completed, ''])
        ];

        if (user.role === 'admin') {
            reportData.splice(9, 0, 
                ['', '', '', ''],
                ['สถิติผู้ใช้', '', '', ''],
                ['ผู้ใช้ทั้งหมด', stats.userStats.total, '', ''],
                ['ผู้ดูแลระบบ', stats.userStats.admins, '', ''],
                ['ผู้ใช้ทั่วไป', stats.userStats.regularUsers, '', '']
            );
        }

        const ws = XLSX.utils.aoa_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'รายงานสถิติการขออนุญาตไปราชการ');
        
        const fileName = `รายงานสถิติการขออนุญาตไปราชการ_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showAlert('สำเร็จ', 'ส่งออกรายงานเรียบร้อยแล้ว');

    } catch (error) {
        console.error('Error exporting stats:', error);
        showAlert('ผิดพลาด', 'ไม่สามารถส่งออกรายงานได้');
    } finally {
        toggleLoader('export-stats', false);
    }
}

    </script>

</body>
</html>

